/*************************************
 * Copyright 2011 Toura, LLC.
 * All Rights Reserved.
 ************************************/
dojo.provide("toura.base");if(!dojo._hasResource["toura.Utilities"]){dojo._hasResource["toura.Utilities"]=true;dojo.provide("toura.Utilities");dojo.forIn=function(_1,fn,_2){for(var k in _1){if(_1.hasOwnProperty(k)){dojo.hitch(_2||window,fn)(k,_1[k]);}}};toura.util={truncate:function(_3,_4){var _5;_4=_4||200;_3=_3.replace("</p>"," ").replace("<br>"," ").replace(toura.regex.stripHTML,"");_5=_3=dojo.trim(_3);_3=_3.substr(0,_4);if(_3&&_5.length>_4){_3=_3+" &hellip;";}return _3;},copyStyles:function(_6,_7,_8){var _9=window.getComputedStyle(_6);dojo.forEach(_8,function(_a){dojo.style(_7,_a,_9[_a]);});}};toura.regex={stripHTML:/(<\/.>)|(<.>)|(<[^b][^r]?[^>]*>)/g};toura.tmpl=function(_b,_c){return dojo.string.substitute(_b,_c);};toura.haml=Haml;toura.populate=function(_d,_e,_f){console.log("populating",arguments);_d.innerHTML=dojo.map(_f,_e).join("");};toura.datasource=function(_10,_11){dojo.declare("client.data."+_10,null,_11);};}if(!dojo._hasResource["toura._Logging"]){dojo._hasResource["toura._Logging"]=true;dojo.provide("toura._Logging");(function(d,w,c){var _12,sep="=====",_13;function _14(ts){var str="";if(!_13){_13=ts;}else{str=" ("+(ts-_13)+"ms since last log) ";_13=ts;}return str;};d.mixin(toura,{log:function(){var msg=[].slice.call(arguments);if(w.device){console.log("\n\n "+new Date().getTime()+" "+msg.join(" ")+"\n\n");}else{c.log.apply(c,msg);}},logSection:function(_15){var ts=new Date().getTime();console.log((w.device?"\n":"")+sep+"\n"+ts+"   START "+_15+_14(ts)+"\n"+sep);},endLogSection:function(_16){var ts=new Date().getTime();console.log((w.device?"\n":"")+sep+"\n"+ts+"   END   "+_16+_14(ts)+"\n"+sep);}});}(dojo,window,console));}if(!dojo._hasResource["toura.app.Phonegap.device"]){dojo._hasResource["toura.app.Phonegap.device"]=true;dojo.provide("toura.app.Phonegap.device");(function(){function _17(ua){if(!ua){return "unknown";}if(!dojo.isString(ua)){return "unknown";}if(!dojo.trim(ua)){return "unknown";}var v;if(ua.match("Android")){v=dojo.trim(ua.split("Android")[1].split(";")[0]).split("-")[0].split(".");return _18(v);}if(ua.indexOf("AppleWebKit")>-1&&(ua.indexOf("iPhone")+ua.indexOf("iPad")+ua.indexOf("iPod"))>=0){return "unknown-ios-webkit";}return "unknown";};function _18(_19){return [_19[0],_19[1]||"0"].join("-");};toura.app.Phonegap.device=function(pg,_1a){return {version:(function(){if(pg){return _18(window.device.version.split("-")[0].split("."));}return _17(window.navigator.userAgent);}()),_parseVersion:_17};};}());}if(!dojo._hasResource["toura.app.Phonegap.network"]){dojo._hasResource["toura.app.Phonegap.network"]=true;dojo.provide("toura.app.Phonegap.network");toura.app.Phonegap.network=function(pg,_1b){var n=navigator,_1c=5*60*1000,_1d,_1e,_1f;return {isReachable:function(_20){console.log("toura.app.Phonegap.network::isReachable()");var dfd=new dojo.Deferred(),now=new Date().getTime();if(_1e&&!_1f&&(now-_1e<_1c)){dfd.resolve(_1f);return dfd;}_1e=now;if(navigator.network&&navigator.network.connection){_1d=navigator.network.connection.type;if(_1d===Connection.UNKNOWN||_1d===Connection.NONE){_1f=false;}else{_1f=true;}}else{_1f=true;}dfd.resolve(_1f);return dfd.promise;}};};}if(!dojo._hasResource["toura.app.Phonegap.analytics"]){dojo._hasResource["toura.app.Phonegap.analytics"]=true;dojo.provide("toura.app.Phonegap.analytics");toura.app.Phonegap.analytics=function(pg,_21){var os=_21.os,_22;return {log:(function(){function _23(){_22=_22||toura.app.Config.get("app").name.replace(/[^a-zA-Z]/g,"");return _22;};return toura.app.Phonegap.present?function(evt,_24){console.log("toura.app.Phonegap::logAnalyticsEvent()");PhoneGap.exec(function(){},function(_25){toura.log("Could not log flurry event.  Error: "+_25);},"FlurryCommand","logEvent",[evt,_24]);}:function(evt,_26){console.log("toura.app.Phonegap::logAnalyticsEvent()");};}())};};}if(!dojo._hasResource["toura.app.Phonegap.audio"]){dojo._hasResource["toura.app.Phonegap.audio"]=true;dojo.provide("toura.app.Phonegap.audio");toura.app.Phonegap.audio=function(pg,_27){var _28,_29=function(){},_2a=function(err){};return {play:function(url){console.log("toura.app.Phonegap.audio::play()");if(!pg){return;}url=/^http/.test(url)?url:("/android_asset/www/"+url);_28=new Media(url,_29,_2a);_28.play();},stop:function(){console.log("toura.app.Phonegap.audio::stop()");if(!pg||!_28){return;}_28.pause();},destroy:function(){if(!_28){return;}_28.stop();_28.release();_28=null;}};};}if(!dojo._hasResource["vendor.urbanairship.push"]){dojo._hasResource["vendor.urbanairship.push"]=true;dojo.provide("vendor.urbanairship.push");vendor.urbanairship.push=function(){var _2b=function(){};_2b.prototype.register=function(_2c,_2d,_2e){PhoneGap.exec(_2c,_2d,"PushNotification","registerAPN",_2e);};_2b.prototype.startNotify=function(_2f){PhoneGap.exec(null,null,"PushNotification","startNotify",[]);};_2b.prototype.log=function(_30){PhoneGap.exec(null,null,"PushNotification","log",[{"msg":_30}]);};PhoneGap.addConstructor(function(){if(!window.plugins){window.plugins={};}window.plugins.pushNotification=new _2b();});};}if(!dojo._hasResource["toura.app.Phonegap.push"]){dojo._hasResource["toura.app.Phonegap.push"]=true;dojo.provide("toura.app.Phonegap.push");toura.app.Phonegap.push=function(pg,_31){if(!pg){return;}vendor.urbanairship.push();};}if(!dojo._hasResource["toura.app.Phonegap.browser"]){dojo._hasResource["toura.app.Phonegap.browser"]=true;dojo.provide("toura.app.Phonegap.browser");toura.app.Phonegap.browser=function(pg,_32){function _33(){};window.ChildBrowser=_33;var os=_32.os,_34={ios:function(){function _33(){};_33._onLocationChange=function(_35){window.plugins.childBrowser.onLocationChange(_35);};_33._onClose=function(){window.plugins.childBrowser.onClose();};_33._onOpenExternal=function(){window.plugins.childBrowser.onOpenExternal();};_33._onJSCallback=function(js,loc){};_33.prototype.showWebPage=function(loc){PhoneGap.exec("ChildBrowserCommand.showWebPage",loc);};_33.prototype.close=function(){PhoneGap.exec("ChildBrowserCommand.close");};_33.prototype.jsExec=function(_36){};_33.install=function(){if(!window.plugins){window.plugins={};}window.plugins.childBrowser=new _33();return window.plugins.childBrowser;};_33.install();},android:function(){_33.prototype.showWebPage=function(url,_37){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,_37]);};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("childBrowser",new _33());PluginManager.addService("ChildBrowser","com.phonegap.plugins.childBrowser.ChildBrowser");});}};if(pg){_34[os]();}return {url:function(url){if(pg){if(os==="android"){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,false]);}else{window.plugins.childBrowser.showWebPage(url);}return;}window.location=url;},getBrowser:function(){if(!window.plugins.childBrowser){throw new Error("Can't find childBrowser plugin");}return window.plugins.childBrowser;}};};}if(!dojo._hasResource["toura.app.Phonegap"]){dojo._hasResource["toura.app.Phonegap"]=true;dojo.provide("toura.app.Phonegap");(function(){var _38=dojo.subscribe("/app/start",function(){var tap=toura.app.Phonegap,_39=toura.app.Config.get("device"),_3a=tap.present=window.device&&window.device.phonegap;dojo.forEach(["device","network","analytics","audio","push","browser"],function(_3b){if(!tap[_3b]){throw "No such phonegap item "+_3b;}tap[_3b]=tap[_3b](_3a,_39);});dojo.unsubscribe(_38);});}());}if(!dojo._hasResource["toura.app.xhr"]){dojo._hasResource["toura.app.xhr"]=true;dojo.provide("toura.app.xhr");var _d=dojo,cfg=_d.config;function setValue(obj,_3c,_3d){if(_3d===null){return;}var val=obj[_3c];if(typeof val=="string"){obj[_3c]=[val,_3d];}else{if(_d.isArray(val)){val.push(_3d);}else{obj[_3c]=_3d;}}};dojo.fieldToObject=function(_3e){var ret=null;var _3f=_d.byId(_3e);if(_3f){var _40=_3f.name;var _41=(_3f.type||"").toLowerCase();if(_40&&_41&&!_3f.disabled){if(_41=="radio"||_41=="checkbox"){if(_3f.checked){ret=_3f.value;}}else{if(_3f.multiple){ret=[];_d.query("option",_3f).forEach(function(opt){if(opt.selected){ret.push(opt.value);}});}else{ret=_3f.value;}}}}return ret;};dojo.formToObject=function(_42){var ret={};var _43="file|submit|image|reset|button|";_d.forEach(dojo.byId(_42).elements,function(_44){var _45=_44.name;var _46=(_44.type||"").toLowerCase();if(_45&&_46&&_43.indexOf(_46)==-1&&!_44.disabled){setValue(ret,_45,_d.fieldToObject(_44));if(_46=="image"){ret[_45+".x"]=ret[_45+".y"]=ret[_45].x=ret[_45].y=0;}}});return ret;};dojo.objectToQuery=function(map){var enc=encodeURIComponent;var _47=[];var _48={};for(var _49 in map){var _4a=map[_49];if(_4a!=_48[_49]){var _4b=enc(_49)+"=";if(_d.isArray(_4a)){for(var i=0;i<_4a.length;i++){_47.push(_4b+enc(_4a[i]));}}else{_47.push(_4b+enc(_4a));}}}return _47.join("&");};dojo.formToQuery=function(_4c){return _d.objectToQuery(_d.formToObject(_4c));};dojo.formToJson=function(_4d,_4e){return _d.toJson(_d.formToObject(_4d),_4e);};dojo.queryToObject=function(str){var ret={};var qp=str.split("&");var dec=decodeURIComponent;_d.forEach(qp,function(_4f){if(_4f.length){var _50=_4f.split("=");var _51=dec(_50.shift());var val=dec(_50.join("="));if(typeof ret[_51]=="string"){ret[_51]=[ret[_51]];}if(_d.isArray(ret[_51])){ret[_51].push(val);}else{ret[_51]=val;}}});return ret;};dojo._blockAsync=false;var handlers=_d._contentHandlers=dojo.contentHandlers={text:function(xhr){return xhr.responseText;},json:function(xhr){return _d.fromJson(xhr.responseText||null);},"json-comment-filtered":function(xhr){if(!dojo.config.useCommentedJson){console.warn("Consider using the standard mimetype:application/json."+" json-commenting can introduce security issues. To"+" decrease the chances of hijacking, use the standard the 'json' handler and"+" prefix your json with: {}&&\n"+"Use djConfig.useCommentedJson=true to turn off this message.");}var _52=xhr.responseText;var _53=_52.indexOf("/*");var _54=_52.lastIndexOf("*/");if(_53==-1||_54==-1){throw new Error("JSON was not comment filtered");}return _d.fromJson(_52.substring(_53+2,_54));},javascript:function(xhr){return _d.eval(xhr.responseText);},xml:function(xhr){var _55=xhr.responseXML;return _55;},"json-comment-optional":function(xhr){if(xhr.responseText&&/^[^{\[]*\/\*/.test(xhr.responseText)){return handlers["json-comment-filtered"](xhr);}else{return handlers["json"](xhr);}}};dojo._ioSetArgs=function(_56,_57,_58,_59){var _5a={args:_56,url:_56.url};var _5b=null;if(_56.form){var _5c=_d.byId(_56.form);var _5d=_5c.getAttributeNode("action");_5a.url=_5a.url||(_5d?_5d.value:null);_5b=_d.formToObject(_5c);}var _5e=[{}];if(_5b){_5e.push(_5b);}if(_56.content){_5e.push(_56.content);}if(_56.preventCache){_5e.push({"dojo.preventCache":new Date().valueOf()});}_5a.query=_d.objectToQuery(_d.mixin.apply(null,_5e));_5a.handleAs=_56.handleAs||"text";var d=new _d.Deferred(_57);d.addCallbacks(_58,function(_5f){return _59(_5f,d);});var ld=_56.load;if(ld&&_d.isFunction(ld)){d.addCallback(function(_60){return ld.call(_56,_60,_5a);});}var err=_56.error;if(err&&_d.isFunction(err)){d.addErrback(function(_61){return err.call(_56,_61,_5a);});}var _62=_56.handle;if(_62&&_d.isFunction(_62)){d.addBoth(function(_63){return _62.call(_56,_63,_5a);});}if(cfg.ioPublish&&_d.publish&&_5a.args.ioPublish!==false){d.addCallbacks(function(res){_d.publish("/dojo/io/load",[d,res]);return res;},function(res){_d.publish("/dojo/io/error",[d,res]);return res;});d.addBoth(function(res){_d.publish("/dojo/io/done",[d,res]);return res;});}d.ioArgs=_5a;return d;};var _deferredCancel=function(dfd){dfd.canceled=true;var xhr=dfd.ioArgs.xhr;var _64=typeof xhr.abort;if(_64=="function"||_64=="object"||_64=="unknown"){xhr.abort();}var err=dfd.ioArgs.error;if(!err){err=new Error("xhr cancelled");err.dojoType="cancel";}return err;};var _deferredOk=function(dfd){var ret=handlers[dfd.ioArgs.handleAs](dfd.ioArgs.xhr);return ret===undefined?null:ret;};var _deferError=function(_65,dfd){if(!dfd.ioArgs.args.failOk){console.error(_65);}return _65;};var _inFlightIntvl=null;var _inFlight=[];var _pubCount=0;var _checkPubCount=function(dfd){if(_pubCount<=0){_pubCount=0;if(cfg.ioPublish&&_d.publish&&(!dfd||dfd&&dfd.ioArgs.args.ioPublish!==false)){_d.publish("/dojo/io/stop");}}};var _watchInFlight=function(){var now=(new Date()).getTime();if(!_d._blockAsync){for(var i=0,tif;i<_inFlight.length&&(tif=_inFlight[i]);i++){var dfd=tif.dfd;var _66=function(){if(!dfd||dfd.canceled||!tif.validCheck(dfd)){_inFlight.splice(i--,1);_pubCount-=1;}else{if(tif.ioCheck(dfd)){_inFlight.splice(i--,1);tif.resHandle(dfd);_pubCount-=1;}else{if(dfd.startTime){if(dfd.startTime+(dfd.ioArgs.args.timeout||0)<now){_inFlight.splice(i--,1);var err=new Error("timeout exceeded");err.dojoType="timeout";dfd.errback(err);dfd.cancel();_pubCount-=1;}}}}};if(dojo.config.debugAtAllCosts){_66.call(this);}else{try{_66.call(this);}catch(e){dfd.errback(e);}}}}_checkPubCount(dfd);if(!_inFlight.length){clearInterval(_inFlightIntvl);_inFlightIntvl=null;return;}};dojo._ioCancelAll=function(){try{_d.forEach(_inFlight,function(i){try{i.dfd.cancel();}catch(e){}});}catch(e){}};_d._ioNotifyStart=function(dfd){if(cfg.ioPublish&&_d.publish&&dfd.ioArgs.args.ioPublish!==false){if(!_pubCount){_d.publish("/dojo/io/start");}_pubCount+=1;_d.publish("/dojo/io/send",[dfd]);}};_d._ioWatch=function(dfd,_67,_68,_69){var _6a=dfd.ioArgs.args;if(_6a.timeout){dfd.startTime=(new Date()).getTime();}_inFlight.push({dfd:dfd,validCheck:_67,ioCheck:_68,resHandle:_69});if(!_inFlightIntvl){_inFlightIntvl=setInterval(_watchInFlight,50);}if(_6a.sync){_watchInFlight();}};var _defaultContentType="application/x-www-form-urlencoded";var _validCheck=function(dfd){return dfd.ioArgs.xhr.readyState;};var _ioCheck=function(dfd){return 4==dfd.ioArgs.xhr.readyState;};var _resHandle=function(dfd){var xhr=dfd.ioArgs.xhr;if(_d._isDocumentOk(xhr)){dfd.callback(dfd);}else{var err=new Error("Unable to load "+dfd.ioArgs.url+" status:"+xhr.status);err.status=xhr.status;err.responseText=xhr.responseText;dfd.errback(err);}};dojo._ioAddQueryToUrl=function(_6b){if(_6b.query.length){_6b.url+=(_6b.url.indexOf("?")==-1?"?":"&")+_6b.query;_6b.query=null;}};dojo.xhr=function(_6c,_6d,_6e){var dfd=_d._ioSetArgs(_6d,_deferredCancel,_deferredOk,_deferError);var _6f=dfd.ioArgs;var xhr=_6f.xhr=_d._xhrObj(_6f.args);if(!xhr){dfd.cancel();return dfd;}if("postData" in _6d){_6f.query=_6d.postData;}else{if("putData" in _6d){_6f.query=_6d.putData;}else{if("rawBody" in _6d){_6f.query=_6d.rawBody;}else{if((arguments.length>2&&!_6e)||"POST|PUT".indexOf(_6c.toUpperCase())==-1){_d._ioAddQueryToUrl(_6f);}}}}xhr.open(_6c,_6f.url,_6d.sync!==true,_6d.user||undefined,_6d.password||undefined);if(_6d.headers){for(var hdr in _6d.headers){if(hdr.toLowerCase()==="content-type"&&!_6d.contentType){_6d.contentType=_6d.headers[hdr];}else{if(_6d.headers[hdr]){xhr.setRequestHeader(hdr,_6d.headers[hdr]);}}}}if(_6d.contentType!==false){xhr.setRequestHeader("Content-Type",_6d.contentType||_defaultContentType);}if(!_6d.headers||!("X-Requested-With" in _6d.headers)){xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");}_d._ioNotifyStart(dfd);if(dojo.config.debugAtAllCosts){xhr.send(_6f.query);}else{try{xhr.send(_6f.query);}catch(e){_6f.error=e;dfd.cancel();}}_d._ioWatch(dfd,_validCheck,_ioCheck,_resHandle);xhr=null;return dfd;};dojo.xhrGet=function(_70){return _d.xhr("GET",_70);};dojo.rawXhrPost=dojo.xhrPost=function(_71){return _d.xhr("POST",_71,true);};dojo.rawXhrPut=dojo.xhrPut=function(_72){return _d.xhr("PUT",_72,true);};dojo.xhrDelete=function(_73){return _d.xhr("DELETE",_73);};}if(!dojo._hasResource["toura.app.Config"]){dojo._hasResource["toura.app.Config"]=true;dojo.provide("toura.app.Config");if(!toura.app._Config){var req=dojo.require;req("toura.app.TouraConfig");}(function(d,_74){var _75;toura.app.Config={get:function(key){var val=_75[key];if(val===_74){console.error("No config value found for "+key);throw new Error("No config value found for "+key);}return val;},set:function(key,val){_75[key]=val;},registerConfig:function(_76){_75=_76;}};toura.app.Config.registerConfig(toura.app._Config);}(dojo));}if(!dojo._hasResource["toura.app.Analytics"]){dojo._hasResource["toura.app.Analytics"]=true;dojo.provide("toura.app.Analytics");(function(){var _77=toura.app.Phonegap;dojo.declare("toura.app.Analytics",[],{constructor:function(id){this.appId=id;dojo.subscribe("/video/play",dojo.hitch(this,"_trackEvent","Video Play"));dojo.subscribe("/audio/play",dojo.hitch(this,"_trackEvent","Audio Play"));dojo.subscribe("/image/view",dojo.hitch(this,"_trackEvent","Image View"));dojo.subscribe("/share",dojo.hitch(this,"_trackEvent","Share"));dojo.subscribe("/node/view",this,"_trackPageview");dojo.subscribe("/search",this,"_trackSearch");},_trackEvent:function(_78,_79){_77.analytics.log(_78,{data:_79});},_trackPageview:function(_7a){_77.analytics.log("/tour/"+toura.app.Config.get("app").id+_7a);},_trackSearch:function(_7b){_7b=_7b?dojo.trim(_7b):false;if(!_7b){return;}_77.analytics.log("Search",{searchTerm:_7b});}});toura.app.Analytics=new toura.app.Analytics();}());}if(!dojo._hasResource["toura.app.DeviceStorage"]){dojo._hasResource["toura.app.DeviceStorage"]=true;dojo.provide("toura.app.DeviceStorage");toura.app.DeviceStorage=(function(){var _7c={"tour":{tableName:"items",fields:["id text","json text"],insertStatement:function(_7d,_7e){return ["INSERT INTO "+_7d+"( id, json ) VALUES ( ?, ? )",[_7e.id,JSON.stringify(_7e)]];},processSelecton:function(_7f){var _80=[],len=_7f.rows.length,_81;for(var i=0;i<len;i++){_81=_7f.rows.item(i).json;_80.push(_81?JSON.parse(_81):{});}return _80;}}};return {init:function(_82){this.appId=_82;if(!window.localStorage){console.log("no local storage");throw new Error("Local storage interface is not defined. Cannot create database. Aborting.");}if(!window.openDatabase){console.log("no database capability");throw new Error("SQLite database interface is not defined. Cannot create database. Aborting.");}var db=this._db=openDatabase(_82,"1.0",_82+" Database",{android:5*1024*1024,ios:1000000}[toura.app.Config.get("device").os]);if(!db){console.log("No database. This will end badly.");}this._sql=function(_83,_84){var dfd=new dojo.Deferred(),len;_83=dojo.isArray(_83)?_83:[_83];len=_83.length;db.transaction(function(t){dojo.forEach(_83,function(q,i){var _85=i+1===len,cb,eb,_86=[];if(_85){cb=dojo.isFunction(_84)?function(t,_87){dfd.callback(_84(_87));}:dfd.callback;eb=dfd.errback;}else{cb=eb=function(){};}if(dojo.isArray(q)){_86=q[1];q=q[0];}t.executeSql(q,_86,cb,eb);});});return dfd;};return this._db;},drop:function(_88){var _89=[];dojo.forIn(_7c,function(_8a,_8b){_89.push("DROP TABLE IF EXISTS "+_8b.tableName);});window.localStorage.clear();return this._sql(_89);},set:function(k,v){var sql=_7c[k],_8c;if(sql){_8c=["DROP TABLE IF EXISTS "+sql.tableName,"CREATE TABLE "+sql.tableName+"("+sql.fields.join(",")+")"];dojo.forEach(v,function(_8d){_8c.push(sql.insertStatement(sql.tableName,_8d));});return this._sql(_8c);}window.localStorage.setItem(k,JSON.stringify(v));return true;},get:function(k){var sql=_7c[k];if(sql){return this._sql("SELECT * FROM "+sql.tableName,sql.processSelecton);}var ret=window.localStorage.getItem(k);if(ret==="undefined"){ret=null;}ret=ret&&JSON.parse(ret);return ret;}};}());}if(!dojo._hasResource["toura.app.URL"]){dojo._hasResource["toura.app.URL"]=true;dojo.provide("toura.app.URL");toura.app.URL={home:function(){return "#/home";},about:function(){return "#/about";},maps:function(){return "#/maps";},favorites:function(){return "#/favorites";},node:function(_8e){return "#/node/"+_8e;},search:function(){return "#/search";},searchTerm:function(_8f){return toura.app.URL.search()+"/"+_8f;},searchResult:function(_90){var url=["node",_90.node];if(_90.type!=="node"){url.push(_90.type,_90.id);}return "#/"+url.join("/");},update:function(){return "#/update";},storedAsset:function(_91,_92){var _93={"image":"images","video":"videos","audio":"audios","videoPoster":"videos/poster"};return [toura.mediaDir||"media",_93[_91],_92].join("/");},googleMapAddress:function(_94){var url="http://maps.google.com/maps?",_95={q:_94};return url+dojo.objectToQuery(_95);},protocol:function(){return (/^https/).test(document.location.protocol)?"https":"http";},tel:function(tel){return "tel:"+tel.replace(/\W/g,"");},feedItem:function(_96,_97){return "/feed/"+_96+"/item/"+_97;}};}if(!dojo._hasResource["toura.models.TextAsset"]){dojo._hasResource["toura.models.TextAsset"]=true;dojo.provide("toura.models.TextAsset");dojo.declare("toura.models.TextAsset",[],{constructor:function(_98,_99){dojo.mixin(this,{id:_98.getValue(_99,"id"),body:_98.getValue(_99,"body"),name:_98.getValue(_99,"name"),contexts:_98.getValues(_99,"contexts")});}});}if(!dojo._hasResource["toura.models.SimpleNode"]){dojo._hasResource["toura.models.SimpleNode"]=true;dojo.provide("toura.models.SimpleNode");(function(){var _9a={};dojo.subscribe("/tour/update",function(){_9a={};});dojo.declare("toura.models.SimpleNode",[],{constructor:function(_9b,_9c){var id=_9b.getValue(_9c,"id");if(_9a[id]){dojo.mixin(this,_9a[id]);return;}dojo.mixin(this,{id:_9b.getValue(_9c,"id"),name:_9b.getValue(_9c,"name")});this.url=toura.app.URL.node(this.id);_9a[id]=this;}});}());}if(!dojo._hasResource["toura.models._CaptionedAsset"]){dojo._hasResource["toura.models._CaptionedAsset"]=true;dojo.provide("toura.models._CaptionedAsset");dojo.declare("toura.models._CaptionedAsset",[],{_processCaption:function(_9d,_9e){if(!_9e.caption){return;}_9d.fetchItemByIdentity({identity:_9e.caption._reference,onItem:function(_9f){dojo.mixin(this,{caption:_9d.getValue(_9f,"body"),name:_9d.getValue(_9f,"name")||this.name});},scope:this});}});}if(!dojo._hasResource["toura.models._StorableAsset"]){dojo._hasResource["toura.models._StorableAsset"]=true;dojo.provide("toura.models._StorableAsset");(function(){var _a0=toura.app.URL.storedAsset;dojo.declare("toura.models._StorableAsset",[],{_getUrl:function(_a1,_a2){this.store=_a1;var _a3=_a1.getValue(_a2,"type"),_a4=_a3==="image"?["featuredSmall","featured","gallery","original"]:false;if(_a4){dojo.forEach(_a4,function(_a5){var t=this[_a5]=_a1.getValue(_a2,_a5),_a6=this._isStreamed(_a2,_a5);t.url=(_a6&&t.url)?t.url:_a0(_a3,t.filename);},this);}else{var url=_a1.getValue(_a2,"url");this.url=(this._isStreamed(_a2)&&url)?url:_a0(_a3,_a1.getValue(_a2,"filename"));}},_isStreamed:function(_a7,_a8){if(toura.forceStreaming){return true;}if(toura.forceLocal){return false;}if(!toura.app.manifest){return true;}if(!toura.app.manifest||this.store.getValue(_a7,"streamed")){return true;}var _a9=_a8?this.store.getValue(_a7,_a8).filename:this.store.getValue(_a7,"filename");var _aa=toura.app.manifest[this.store.getValue(_a7,"type")+"s"];if(!_aa||!dojo.isArray(_aa)){return true;}if(dojo.indexOf(_aa,_a9)>-1){return false;}return true;}});}());}if(!dojo._hasResource["toura.models.Image"]){dojo._hasResource["toura.models.Image"]=true;dojo.provide("toura.models.Image");dojo.declare("toura.models.Image",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_ab,_ac){_ab.fetchItemByIdentity({identity:_ac.image._reference,onItem:function(_ad){dojo.mixin(this,{id:_ab.getValue(_ad,"id"),name:_ab.getValue(_ad,"name"),height:_ab.getValue(_ad,"height")||null,width:_ab.getValue(_ad,"width")||null});this._getUrl(_ab,_ad);},scope:this});this._processCaption(_ab,_ac);}});}if(!dojo._hasResource["toura.models.HeaderImage"]){dojo._hasResource["toura.models.HeaderImage"]=true;dojo.provide("toura.models.HeaderImage");dojo.declare("toura.models.HeaderImage",[toura.models._StorableAsset,toura.models._CaptionedAsset],{constructor:function(_ae,_af){dojo.mixin(this,{id:_ae.getValue(_af,"id"),name:_ae.getValue(_af,"name"),height:_ae.getValue(_af,"height")||null,width:_ae.getValue(_af,"width")||null});this._getUrl(_ae,_af);this._processCaption(_ae,_af);this.destination=/^http/.test(this.name)?this.name:false;}});}if(!dojo._hasResource["toura.models.BackgroundImage"]){dojo._hasResource["toura.models.BackgroundImage"]=true;dojo.provide("toura.models.BackgroundImage");dojo.declare("toura.models.BackgroundImage",[toura.models._StorableAsset],{constructor:function(_b0,_b1){dojo.mixin(this,{id:_b0.getValue(_b1,"id"),name:_b0.getValue(_b1,"name"),height:_b0.getValue(_b1,"height")||null,width:_b0.getValue(_b1,"width")||null});this._getUrl(_b0,_b1);}});}if(!dojo._hasResource["toura.models.FeaturedImage"]){dojo._hasResource["toura.models.FeaturedImage"]=true;dojo.provide("toura.models.FeaturedImage");dojo.declare("toura.models.FeaturedImage",[toura.models._StorableAsset],{constructor:function(_b2,_b3){this._getUrl(_b2,_b3);this.small=this.featuredSmall;this.large=this.featured;delete this.featured_small;delete this.featured;delete this.gallery;delete this.original;}});}if(!dojo._hasResource["toura.models.Video"]){dojo._hasResource["toura.models.Video"]=true;dojo.provide("toura.models.Video");dojo.declare("toura.models.Video",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_b4,_b5){if(!_b5.video){dojo.mixin(this,{id:_b4.getValue(_b5,"id"),name:_b4.getValue(_b5,"name"),url:_b4.getValue(_b5,"url")});return;}_b4.fetchItemByIdentity({identity:_b5.video._reference,onItem:function(_b6){dojo.mixin(this,{id:_b4.getValue(_b6,"id"),name:_b4.getValue(_b6,"name"),poster:_b4.getValue(_b6,"poster")});this._getUrl(_b4,_b6);},scope:this});this._processCaption(_b4,_b5);if(this.poster){this.poster=this._posterOnDevice()?toura.app.URL.storedAsset("videoPoster",this.poster.filename):this.poster.url;}},_posterOnDevice:function(){var _b7=this.poster.filename;return toura.app.manifest&&toura.app.manifest.videos&&dojo.indexOf(toura.app.manifest.videos.posters||[],_b7)>-1;}});}if(!dojo._hasResource["toura.models.Audio"]){dojo._hasResource["toura.models.Audio"]=true;dojo.provide("toura.models.Audio");dojo.declare("toura.models.Audio",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_b8,_b9){_b8.fetchItemByIdentity({identity:_b9.audio._reference,onItem:function(_ba){dojo.mixin(this,{id:_b8.getValue(_ba,"id"),name:_b8.getValue(_ba,"name")});this._getUrl(_b8,_ba);},scope:this});this._processCaption(_b8,_b9);}});}if(!dojo._hasResource["toura.models.Data"]){dojo._hasResource["toura.models.Data"]=true;dojo.provide("toura.models.Data");dojo.declare("toura.models.Data",[],{constructor:function(_bb,_bc){_bb.fetchItemByIdentity({identity:_bc.dataAsset._reference,onItem:function(_bd){dojo.mixin(this,{id:_bb.getValue(_bd,"id"),name:_bb.getValue(_bd,"name"),type:_bb.getValue(_bd,"dataType"),json:JSON.parse(_bb.getValue(_bd,"value"))});},scope:this});}});}if(!dojo._hasResource["toura.models.GoogleMapPin"]){dojo._hasResource["toura.models.GoogleMapPin"]=true;dojo.provide("toura.models.GoogleMapPin");dojo.declare("toura.models.GoogleMapPin",[toura.models._CaptionedAsset],{constructor:function(_be,_bf){_be.fetchItemByIdentity({identity:_bf.googleMapPin._reference,onItem:function(_c0){dojo.mixin(this,{id:_be.getValue(_c0,"id"),name:_be.getValue(_c0,"name"),lat:_be.getValue(_c0,"lat"),lon:_be.getValue(_c0,"lon"),address:_be.getValue(_c0,"address"),phoneNumber:_be.getValue(_c0,"phoneNumber"),website:_be.getValue(_c0,"website")});},scope:this});this._processCaption(_be,_bf);}});}if(!dojo._hasResource["dojo.io.script"]){dojo._hasResource["dojo.io.script"]=true;dojo.provide("dojo.io.script");dojo.getObject("io",true,dojo);(function(){var _c1=dojo.isIE?"onreadystatechange":"load",_c2=/complete|loaded/;dojo.io.script={get:function(_c3){var dfd=this._makeScriptDeferred(_c3);var _c4=dfd.ioArgs;dojo._ioAddQueryToUrl(_c4);dojo._ioNotifyStart(dfd);if(this._canAttach(_c4)){var _c5=this.attach(_c4.id,_c4.url,_c3.frameDoc);if(!_c4.jsonp&&!_c4.args.checkString){var _c6=dojo.connect(_c5,_c1,function(evt){if(evt.type=="load"||_c2.test(_c5.readyState)){dojo.disconnect(_c6);_c4.scriptLoaded=evt;}});}}dojo._ioWatch(dfd,this._validCheck,this._ioCheck,this._resHandle);return dfd;},attach:function(id,url,_c7){var doc=(_c7||dojo.doc);var _c8=doc.createElement("script");_c8.type="text/javascript";_c8.src=url;_c8.id=id;_c8.charset="utf-8";return doc.getElementsByTagName("head")[0].appendChild(_c8);},remove:function(id,_c9){dojo.destroy(dojo.byId(id,_c9));if(this["jsonp_"+id]){delete this["jsonp_"+id];}},_makeScriptDeferred:function(_ca){var dfd=dojo._ioSetArgs(_ca,this._deferredCancel,this._deferredOk,this._deferredError);var _cb=dfd.ioArgs;_cb.id=dojo._scopeName+"IoScript"+(this._counter++);_cb.canDelete=false;_cb.jsonp=_ca.callbackParamName||_ca.jsonp;if(_cb.jsonp){_cb.query=_cb.query||"";if(_cb.query.length>0){_cb.query+="&";}_cb.query+=_cb.jsonp+"="+(_ca.frameDoc?"parent.":"")+dojo._scopeName+".io.script.jsonp_"+_cb.id+"._jsonpCallback";_cb.frameDoc=_ca.frameDoc;_cb.canDelete=true;dfd._jsonpCallback=this._jsonpCallback;this["jsonp_"+_cb.id]=dfd;}return dfd;},_deferredCancel:function(dfd){dfd.canceled=true;if(dfd.ioArgs.canDelete){dojo.io.script._addDeadScript(dfd.ioArgs);}},_deferredOk:function(dfd){var _cc=dfd.ioArgs;if(_cc.canDelete){dojo.io.script._addDeadScript(_cc);}return _cc.json||_cc.scriptLoaded||_cc;},_deferredError:function(_cd,dfd){if(dfd.ioArgs.canDelete){if(_cd.dojoType=="timeout"){dojo.io.script.remove(dfd.ioArgs.id,dfd.ioArgs.frameDoc);}else{dojo.io.script._addDeadScript(dfd.ioArgs);}}console.log("dojo.io.script error",_cd);return _cd;},_deadScripts:[],_counter:1,_addDeadScript:function(_ce){dojo.io.script._deadScripts.push({id:_ce.id,frameDoc:_ce.frameDoc});_ce.frameDoc=null;},_validCheck:function(dfd){var _cf=dojo.io.script;var _d0=_cf._deadScripts;if(_d0&&_d0.length>0){for(var i=0;i<_d0.length;i++){_cf.remove(_d0[i].id,_d0[i].frameDoc);_d0[i].frameDoc=null;}dojo.io.script._deadScripts=[];}return true;},_ioCheck:function(dfd){var _d1=dfd.ioArgs;if(_d1.json||(_d1.scriptLoaded&&!_d1.args.checkString)){return true;}var _d2=_d1.args.checkString;if(_d2&&eval("typeof("+_d2+") != 'undefined'")){return true;}return false;},_resHandle:function(dfd){if(dojo.io.script._ioCheck(dfd)){dfd.callback(dfd);}else{dfd.errback(new Error("inconceivable dojo.io.script._resHandle error"));}},_canAttach:function(_d3){return true;},_jsonpCallback:function(_d4){this.ioArgs.json=_d4;}};})();}if(!dojo._hasResource["toura.models.Feed"]){dojo._hasResource["toura.models.Feed"]=true;dojo.provide("toura.models.Feed");(function(){dojo.declare("toura.models.Feed",[],{throttle:5*60*1000,constructor:function(_d5,_d6){if(_d6&&_d6.feed){_d5.fetchItemByIdentity({identity:_d6.feed._reference,onItem:function(_d7){dojo.mixin(this,{feedUrl:_d5.getValue(_d7,"feedUrl"),id:_d5.getValue(_d7,"id"),name:_d5.getValue(_d7,"name")});},scope:this});}else{dojo.mixin(this,{feedUrl:_d5.getValue(_d6,"feedUrl"),id:_d5.getValue(_d6,"id"),name:_d5.getValue(_d6,"name")});}this.lastChecked=toura.app.DeviceStorage.get(this.id+"-checked");},load:function(){var fn=toura.app.Phonegap.present?dojo.hitch(dojo,"xhrGet"):dojo.hitch(dojo.io.script,"get"),dfd=new dojo.Deferred();if(new Date().getTime()-this.lastChecked<this.throttle){dfd.resolve(this._get());}else{toura.app.Phonegap.network.isReachable().then(dojo.hitch(this,function(_d8){if(!_d8){dfd.resolve(this._get());return;}fn(this._createArgs(dfd));}));}return dfd.promise;},getItem:function(_d9){this._get();var _da=this.items[_d9];_da.siblings=this.items;return _da;},_onLoad:function(dfd,_db){this.lastChecked=new Date().getTime();if(_db&&_db.query&&_db.query.results&&_db.query.results.item){this.items=dojo.map(_db.query.results.item,function(_dc,_dd){_dc.index=_dd;return new toura.models.FeedItem(_dc,this);},this);this.updated=new dojo.date.stamp.fromISOString(_db.query.created);}else{console.warn("There were no results for feed",this.id,_db);this.items=[];}this._store();dfd.resolve(this._get());},_onError:function(dfd){dfd.resolve(this._get()||[]);},_store:function(){toura.app.DeviceStorage.set(this.id,this.items);toura.app.DeviceStorage.set(this.id+"-checked",this.lastChecked);},_get:function(){this.items=dojo.map(toura.app.DeviceStorage.get(this.id)||[],function(_de){_de.pubDate=new Date(_de.pubDate);return _de;});return this.items;},_createArgs:function(dfd){var req={url:"http://query.yahooapis.com/v1/public/yql",content:{q:"select * from feed where url='{{feed}}' limit 20".replace("{{feed}}",this.feedUrl),format:"json"},preventCache:true,load:dojo.hitch(this,"_onLoad",dfd),error:dojo.hitch(this,"_onError",dfd)};if(!toura.app.Phonegap.present){req.callbackParamName="callback";}else{req.handleAs="json";}return req;}});dojo.declare("toura.models.FeedItem",null,{constructor:function(_df,_e0){this.type="feedItem";dojo.mixin(this,{title:_df.title||"",body:_df.description||"",url:toura.app.URL.feedItem(_e0.id,_df.index),link:_df.link,pubDate:_df.pubDate,name:_df.title,feedName:_e0.name,id:_e0.id+"-"+_df.index});if(dojo.isObject(this.body)){this.body=this.body.content||null;}if(dojo.isObject(this.link)){this.link=this.link.content||null;}if(dojo.isObject(this.title)){this.title=this.title.content||null;}this.image=this._getImage(_df);this.author=this._getAuthor(_df);},_getImage:function(_e1){var enc=_e1.enclosure||_e1.content;if(enc&&enc.type&&enc.type.match(/(jpeg|png)/i)){return {url:enc.url};}return "";},_getAuthor:function(_e2){var _e3=_e2.author;if(_e3&&_e3.displayName){return _e3.displayName;}return "";}});}());}if(!dojo._hasResource["toura.models.Node"]){dojo._hasResource["toura.models.Node"]=true;dojo.provide("toura.models.Node");(function(){var _e4={};dojo.subscribe("/tour/update",function(){_e4={};});dojo.declare("toura.models.Node",[],{constructor:function(_e5,_e6){var id=_e5.getValue(_e6,"id");if(_e4[id]){dojo.mixin(this,_e4[id]);return;}this.store=_e5;this._dataCache={};var _e7=function(_e8,_e9){return dojo.map(_e5.getValues(_e6,_e8)||[],function(_ea){return new _e9(_e5,_ea);});};dojo.mixin(this,{type:"node",id:id,name:_e5.getValue(_e6,"name"),headerImage:{phone:_e7("phoneHeaderImage",toura.models.HeaderImage)[0],tablet:_e7("tabletHeaderImage",toura.models.HeaderImage)[0]},backgroundImage:{phone:_e7("phoneBackgroundImage",toura.models.BackgroundImage)[0],tablet:_e7("tabletBackgroundImage",toura.models.BackgroundImage)[0]},featuredImage:_e7("featuredImage",toura.models.FeaturedImage)[0],children:_e5.getValues(_e6,"children"),bodyText:_e5.getValue(_e6,"bodyText"),images:_e7("images",toura.models.Image),audios:_e7("audios",toura.models.Audio),videos:_e7("videos",toura.models.Video),data:_e7("dataAssets",toura.models.Data),staticMapImages:_e7("imageMapImages",toura.models.Image),googleMapPins:_e7("googleMapPins",toura.models.GoogleMapPin),feeds:_e7("feeds",toura.models.Feed),pageController:_e5.getValue(_e6,"pageController"),sharingURL:_e5.getValue(_e6,"sharingUrl"),parent:_e5.getValue(_e6,"parent")});dojo.mixin(this,{url:toura.app.URL.node(this.id),bodyText:this.bodyText&&new toura.models.TextAsset(_e5,this.bodyText),assetTypeUrl:function(_eb){return this.url+"/"+_eb;},parent:this.parent&&new toura.models.Node(_e5,this.parent),isHomeNode:this.id===toura.app.Config.get("app").homeNodeId});this.siblings=this.parent?dojo.map(this.parent.children,function(c){return new toura.models.SimpleNode(this.store,c);},this):[];this._assetCache={};_e4[id]=this;},_pluralize:function(_ec){var _ed={"google-map-pin":"googleMapPins","image":"images","video":"videos","audio":"audios","static-map-image":"staticMapImages"};if(!_ed[_ec]){console.warn("toura.models.Node::_pluralize(): no property found for",_ec);}return _ed[_ec]||(_ec+"s");},getAssetById:function(_ee,id){var key=_ee+id,_ef,_f0;if(!this._assetCache[key]){_f0=this[this._pluralize(_ee)];if(!_f0){console.warn("toura.models.Node::getAssetById(): No matching asset property found for",_ee);_f0=[];}_ef=dojo.filter(_f0,function(a){return a.id===id;});this._assetCache[key]=_ef.length?_ef[0]:false;}return this._assetCache[key];},getBackgroundImage:function(_f1){var _f2=_f1.type==="phone"?"gallery":"original";if(this.backgroundImage&&this.backgroundImage[_f1.type]){return this.backgroundImage[_f1.type][_f2];}return false;},populateChildren:function(){if(this.childrenPopulated){return;}this.children=dojo.map(this.children,function(c){return new toura.models.Node(this.store,c);},this);this.childrenPopulated=true;},getData:function(_f3){if(!this._dataCache[_f3]){var _f4=dojo.filter(this.data,function(d){return d.type===_f3;});this._dataCache[_f3]=!_f4.length?false:_f4[0].json;}return this._dataCache[_f3];}});}());}if(!dojo._hasResource["toura.models.SearchResult"]){dojo._hasResource["toura.models.SearchResult"]=true;dojo.provide("toura.models.SearchResult");dojo.declare("toura.models.SearchResult",[],{constructor:function(_f5,_f6){var _f7=_f6.context,_f8=_f6.textAsset,_f9;if(!_f7){_f9=new toura.models.Node(_f5,_f6);dojo.mixin(this,{type:"node",nodeId:_f9.id,displayName:_f9.name,displayText:_f9.bodyText?_f9.bodyText.body||"":"",url:toura.app.URL.searchResult({type:"node",node:_f9.id}),nodeTitle:_f9.name});return;}dojo.mixin(this,{nodeId:_f7.node,type:_f7.type,displayName:_f8.name,displayText:_f8.body,url:toura.app.URL.searchResult(_f7)});_f5.fetchItemByIdentity({identity:_f7.node,onItem:function(_fa){var n=new toura.models.Node(_f5,_fa);this.nodeTitle=n.name;if(_f7.type!=="node"){this.asset=n.getAssetById(_f7.type,_f7.id);}},scope:this});}});}if(!dojo._hasResource["toura.app.Data"]){dojo._hasResource["toura.app.Data"]=true;dojo.provide("toura.app.Data");dojo.declare("toura.app.Data",null,{cache:{},searchCache:{},models:{node:toura.models.Node,backgroundImage:toura.models.BackgroundImage,feed:toura.models.Feed,featuredImage:toura.models.FeaturedImage},constructor:function(_fb){this.loadData(_fb);},loadData:function(_fc){this.cache={};this.searchCache={};this._store=new dojo.data.ItemFileReadStore({data:{identifier:"id",items:_fc},hierarchical:false});this.onLoadData(_fc);},onLoadData:function(_fd){dojo.publish("/data/loaded",[_fd]);},getModel:function(id,_fe){if(!id){throw new Error("toura.app.Data::getModel requires an id");}if(!dojo.isString(id)){throw new Error("toura.app.Data::getModel requires the id to be a string");}var _ff=this.cache,_100=this._store,item,_101;if(!_ff[id]){item=this.getById(id);if(!item){return false;}_fe=_fe||_100.getValue(item,"type");_101=this.models[_fe];if(item&&!_101){throw new Error("toura.app.Data::getModel no model for type "+_fe);}_ff[id]=new _101(_100,item);}return _ff[id];},getById:function(id){var ret;this._store.fetchItemByIdentity({identity:id,scope:this,onItem:dojo.hitch(this,function(item){ret=item;})});return ret;},search:function(term){if(!term||!dojo.trim(term)){return [];}term=dojo.trim(term.replace(/\W/g," "));if(this.searchCache[term]){return this.searchCache[term];}var _102=[],_103=[],_104=this._store,_105=function(_106){_102=_102.concat(_106);},re=new RegExp(term,"i"),seen={},_107,_108=toura.models.SearchResult;var _109=[{type:"text-asset",body:re},{type:"text-asset",name:re}];dojo.forEach(_109,function(q){_104.fetch({query:q,onComplete:_105});});dojo.forEach(_102,function(a){var ta=new toura.models.TextAsset(_104,a);_103=_103.concat(dojo.map(ta.contexts,function(c){return new _108(_104,{textAsset:ta,context:c});}));},this);_104.fetch({query:{type:"node",name:re},onComplete:function(_10a){_103=_103.concat(dojo.map(_10a,function(item){return new _108(_104,item);}));}});_104.fetch({query:{type:"node",identifier:re},onComplete:function(_10b){_107=dojo.map(_10b,function(item){return new toura.models.SearchResult(_104,item);});}});_103=_107.concat(_103);_103=dojo.filter(_103,function(r){if(seen[r.nodeId]&&r.type==="node"){return false;}if(seen[r.url]){return false;}seen[r.url]=true;seen[r.nodeId]=true;return true;});this.searchCache[term]=_103;return _103;}});}if(!dojo._hasResource["toura._Nls"]){dojo._hasResource["toura._Nls"]=true;dojo.provide("toura._Nls");dojo.declare("toura._Nls",null,{data:{__initialized:false},constructor:function(){if(!this.data.__initialized){this.data.nlsStrings=dojo.i18n.getLocalization("toura","toura",toura.app.Config.get("locale"));this.data.__initialized=true;}},getString:function(key,_10c){var str=this.data.nlsStrings[key];return (_10c)?dojo.string.substitute(str,_10c):str;},postMixInProperties:function(){this.inherited("postMixInProperties",arguments);this.initializeStrings();},initializeStrings:function(){}});}if(!dojo._hasResource["vendor.iscroll"]){dojo._hasResource["vendor.iscroll"]=true;dojo.provide("vendor.iscroll");(function(){function _10d(el,_10e){var that=this,doc=document,div,i;that.wrapper=typeof el=="object"?el:doc.getElementById(el);that.wrapper.style.overflow="hidden";that.scroller=that.wrapper.children[0];that.options={HWTransition:true,HWCompositing:true,hScroll:true,vScroll:true,hScrollbar:true,vScrollbar:true,fixedScrollbar:_10f,fadeScrollbar:(_110&&_111)||!_112,hideScrollbar:_110||!_112,scrollbarClass:"",bounce:_111,bounceLock:false,momentum:_111,lockDirection:true,zoom:false,zoomMin:1,zoomMax:4,snap:false,pullToRefresh:false,pullDownLabel:["Pull down to refresh...","Release to refresh...","Loading..."],pullUpLabel:["Pull up to refresh...","Release to refresh...","Loading..."],onPullDown:function(){},onPullUp:function(){},onScrollStart:null,onScrollEnd:null,onZoomStart:null,onZoomEnd:null,checkDOMChange:false};for(i in _10e){that.options[i]=_10e[i];}that.options.HWCompositing=that.options.HWCompositing&&_14c;that.options.HWTransition=that.options.HWTransition&&_14c;if(that.options.HWCompositing){that.scroller.style.cssText+="-webkit-transition-property:-webkit-transform;-webkit-transform-origin:0 0;-webkit-transform:"+_118+"0,0"+_119;}else{that.scroller.style.cssText+="-webkit-transition-property:top,left;-webkit-transform-origin:0 0;top:0;left:0";}if(that.options.HWTransition){that.scroller.style.cssText+="-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;";}that.options.hScrollbar=that.options.hScroll&&that.options.hScrollbar;that.options.vScrollbar=that.options.vScroll&&that.options.vScrollbar;that.pullDownToRefresh=that.options.pullToRefresh=="down"||that.options.pullToRefresh=="both";that.pullUpToRefresh=that.options.pullToRefresh=="up"||that.options.pullToRefresh=="both";if(that.pullDownToRefresh){div=doc.createElement("div");div.className="iScrollPullDown";div.innerHTML="<span class=\"iScrollPullDownIcon\"></span><span class=\"iScrollPullDownLabel\">"+that.options.pullDownLabel[0]+"</span>\n";that.scroller.insertBefore(div,that.scroller.children[0]);that.options.bounce=true;that.pullDownEl=div;that.pullDownLabel=div.getElementsByTagName("span")[1];}if(that.pullUpToRefresh){div=doc.createElement("div");div.className="iScrollPullUp";div.innerHTML="<span class=\"iScrollPullUpIcon\"></span><span class=\"iScrollPullUpLabel\">"+that.options.pullUpLabel[0]+"</span>\n";that.scroller.appendChild(div);that.options.bounce=true;that.pullUpEl=div;that.pullUpLabel=div.getElementsByTagName("span")[1];}that.refresh();that._bind(_117,window);that._bind(_113);if(_11f&&that.options.zoom){that._bind("gesturestart");that.scroller.style.webkitTransform=that.scroller.style.webkitTransform+" scale(1)";}if(!_112){that._bind("mousewheel");}if(that.options.checkDOMChange){that.DOMChangeInterval=setInterval(function(){that._checkSize();},250);}};_10d.prototype={x:0,y:0,currPageX:0,currPageY:0,pagesX:[],pagesY:[],offsetBottom:0,offsetTop:0,scale:1,lastScale:1,contentReady:true,handleEvent:function(e){var that=this;switch(e.type){case _113:that._start(e);break;case _114:that._move(e);break;case _115:case _116:that._end(e);break;case "webkitTransitionEnd":that._transitionEnd(e);break;case _117:that._resize();break;case "gesturestart":that._gestStart(e);break;case "gesturechange":that._gestChange(e);break;case "gestureend":case "gesturecancel":that._gestEnd(e);break;case "mousewheel":that._wheel(e);break;}},_scrollbar:function(dir){var that=this,doc=document,bar;if(!that[dir+"Scrollbar"]){if(that[dir+"ScrollbarWrapper"]){that[dir+"ScrollbarIndicator"].style.webkitTransform="";that[dir+"ScrollbarWrapper"].parentNode.removeChild(that[dir+"ScrollbarWrapper"]);that[dir+"ScrollbarWrapper"]=null;that[dir+"ScrollbarIndicator"]=null;}return;}if(!that[dir+"ScrollbarWrapper"]){bar=doc.createElement("div");if(that.options.scrollbarClass){bar.className=that.options.scrollbarClass+dir.toUpperCase();}else{bar.style.cssText="position:absolute;z-index:100;"+(dir=="h"?"height:7px;bottom:1px;left:2px;right:7px":"width:7px;bottom:7px;top:2px;right:1px");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:opacity;-webkit-transition-duration:"+(that.options.fadeScrollbar?"350ms":"0")+";overflow:hidden;opacity:"+(that.options.hideScrollbar?"0":"1");that.wrapper.appendChild(bar);that[dir+"ScrollbarWrapper"]=bar;bar=doc.createElement("div");if(!that.options.scrollbarClass){bar.style.cssText="position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);-webkit-background-clip:padding-box;-webkit-box-sizing:border-box;"+(dir=="h"?"height:100%;-webkit-border-radius:4px 3px;":"width:100%;-webkit-border-radius:3px 4px;");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:-webkit-transform;-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;-webkit-transform:"+_118+"0,0"+_119;that[dir+"ScrollbarWrapper"].appendChild(bar);that[dir+"ScrollbarIndicator"]=bar;}if(dir=="h"){that.hScrollbarSize=that.hScrollbarWrapper.clientWidth;that.hScrollbarIndicatorSize=m.max(m.round(that.hScrollbarSize*that.hScrollbarSize/that.scrollerW),8);that.hScrollbarIndicator.style.width=that.hScrollbarIndicatorSize+"px";that.hScrollbarMaxScroll=that.hScrollbarSize-that.hScrollbarIndicatorSize;that.hScrollbarProp=that.hScrollbarMaxScroll/that.maxScrollX;}else{that.vScrollbarSize=that.vScrollbarWrapper.clientHeight;that.vScrollbarIndicatorSize=m.max(m.round(that.vScrollbarSize*that.vScrollbarSize/that.scrollerH),8);that.vScrollbarIndicator.style.height=that.vScrollbarIndicatorSize+"px";that.vScrollbarMaxScroll=that.vScrollbarSize-that.vScrollbarIndicatorSize;that.vScrollbarProp=that.vScrollbarMaxScroll/that.maxScrollY;}that._indicatorPos(dir,true);},_resize:function(){var that=this;setTimeout(function(){that.refresh();},0);},_checkSize:function(){var that=this,_11a,_11b;if(that.moved||that.zoomed||!that.contentReady){return;}_11a=m.round(that.scroller.offsetWidth*that.scale),_11b=m.round((that.scroller.offsetHeight-that.offsetBottom-that.offsetTop)*that.scale);if(_11a==that.scrollerW&&_11b==that.scrollerH){return;}that.refresh();},_pos:function(x,y){var that=this;that.x=that.hScroll?x:0;that.y=that.vScroll?y:0;that.scroller.style.webkitTransform=_118+that.x+"px,"+that.y+"px"+_119+" scale("+that.scale+")";that._indicatorPos("h");that._indicatorPos("v");},_indicatorPos:function(dir,_11c){var that=this,pos=dir=="h"?that.x:that.y;if(!that[dir+"Scrollbar"]){return;}pos=that[dir+"ScrollbarProp"]*pos;if(pos<0){pos=that.options.fixedScrollbar?0:pos+pos*3;if(that[dir+"ScrollbarIndicatorSize"]+pos<9){pos=-that[dir+"ScrollbarIndicatorSize"]+8;}}else{if(pos>that[dir+"ScrollbarMaxScroll"]){pos=that.options.fixedScrollbar?that[dir+"ScrollbarMaxScroll"]:pos+(pos-that[dir+"ScrollbarMaxScroll"])*3;if(that[dir+"ScrollbarIndicatorSize"]+that[dir+"ScrollbarMaxScroll"]-pos<9){pos=that[dir+"ScrollbarIndicatorSize"]+that[dir+"ScrollbarMaxScroll"]-8;}}}that[dir+"ScrollbarWrapper"].style.webkitTransitionDelay="0";that[dir+"ScrollbarWrapper"].style.opacity=_11c&&that.options.hideScrollbar?"0":"1";that[dir+"ScrollbarIndicator"].style.webkitTransform=_118+(dir=="h"?pos+"px,0":"0,"+pos+"px")+_119;},_transitionTime:function(time){var that=this;time+="ms";that.scroller.style.webkitTransitionDuration=time;if(that.hScrollbar){that.hScrollbarIndicator.style.webkitTransitionDuration=time;}if(that.vScrollbar){that.vScrollbarIndicator.style.webkitTransitionDuration=time;}},_start:function(e){var that=this,_11d=_112?e.changedTouches[0]:e,_11e;that.moved=false;e.preventDefault();if(_112&&e.touches.length==2&&that.options.zoom&&_11f&&!that.zoomed){that.originX=m.abs(e.touches[0].pageX+e.touches[1].pageX-that.wrapperOffsetLeft*2)/2-that.x;that.originY=m.abs(e.touches[0].pageY+e.touches[1].pageY-that.wrapperOffsetTop*2)/2-that.y;}that.moved=false;that.distX=0;that.distY=0;that.absDistX=0;that.absDistY=0;that.dirX=0;that.dirY=0;that.returnTime=0;that._transitionTime(0);if(that.options.momentum){if(that.scrollInterval){clearInterval(that.scrollInterval);that.scrollInterval=null;}if(that.options.HWCompositing){_11e=new WebKitCSSMatrix(window.getComputedStyle(that.scroller,null).webkitTransform);if(_11e.m41!=that.x||_11e.m42!=that.y){that._unbind("webkitTransitionEnd");that._pos(_11e.m41,_11e.m42);}}else{_11e=window.getComputedStyle(that.scroller,null);if(that.x+"px"!=_11e.left||that.y+"px"!=_11e.top){that._unbind("webkitTransitionEnd");that._pos(_11e.left.replace(/[^0-9]/g)*1,_11e.top.replace(/[^0-9]/g)*1);}}}that.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";if(that.hScrollbar){that.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}if(that.vScrollbar){that.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}that.startX=that.x;that.startY=that.y;that.pointX=_11d.pageX;that.pointY=_11d.pageY;that.startTime=e.timeStamp;if(that.options.onScrollStart){that.options.onScrollStart.call(that);}that._bind(_114);that._bind(_115);that._bind(_116);},_move:function(e){if(_112&&e.touches.length>1){return;}var that=this,_120=_112?e.changedTouches[0]:e,_121=_120.pageX-that.pointX,_122=_120.pageY-that.pointY,newX=that.x+_121,newY=that.y+_122;e.preventDefault();that.pointX=_120.pageX;that.pointY=_120.pageY;if(newX>0||newX<that.maxScrollX){newX=that.options.bounce?that.x+(_121/2.4):newX>=0||that.maxScrollX>=0?0:that.maxScrollX;}if(newY>0||newY<that.maxScrollY){newY=that.options.bounce?that.y+(_122/2.4):newY>=0||that.maxScrollY>=0?0:that.maxScrollY;if(that.options.pullToRefresh&&that.contentReady){if(that.pullDownToRefresh&&newY>that.offsetBottom){that.pullDownEl.className="iScrollPullDown flip";that.pullDownLabel.innerText=that.options.pullDownLabel[1];}else{if(that.pullDownToRefresh&&that.pullDownEl.className.match("flip")){that.pullDownEl.className="iScrollPullDown";that.pullDownLabel.innerText=that.options.pullDownLabel[0];}}if(that.pullUpToRefresh&&newY<that.maxScrollY-that.offsetTop){that.pullUpEl.className="iScrollPullUp flip";that.pullUpLabel.innerText=that.options.pullUpLabel[1];}else{if(that.pullUpToRefresh&&that.pullUpEl.className.match("flip")){that.pullUpEl.className="iScrollPullUp";that.pullUpLabel.innerText=that.options.pullUpLabel[0];}}}}if(that.absDistX<4&&that.absDistY<4){that.distX+=_121;that.distY+=_122;that.absDistX=m.abs(that.distX);that.absDistY=m.abs(that.distY);return;}if(that.options.lockDirection){if(that.absDistX>that.absDistY+3){newY=that.y;_122=0;}else{if(that.absDistY>that.absDistX+3){newX=that.x;_121=0;}}}that.moved=true;that._pos(newX,newY);that.dirX=_121>0?-1:_121<0?1:0;that.dirY=_122>0?-1:_122<0?1:0;if(e.timeStamp-that.startTime>300){that.startTime=e.timeStamp;that.startX=that.x;that.startY=that.y;}},_end:function(e){if(_112&&e.touches.length!=0){return;}var that=this,_123=_112?e.changedTouches[0]:e,_124,ev,_125={dist:0,time:0},_126={dist:0,time:0},_127=e.timeStamp-that.startTime,_128=that.x,_129=that.y,_12a,snap;that._unbind(_114);that._unbind(_115);that._unbind(_116);if(that.zoomed){return;}if(!that.moved){if(_112){if(that.doubleTapTimer&&that.options.zoom){clearTimeout(that.doubleTapTimer);that.doubleTapTimer=null;that.zoom(that.pointX,that.pointY,that.scale==1?2:1);}else{that.doubleTapTimer=setTimeout(function(){that.doubleTapTimer=null;_124=_123.target;while(_124.nodeType!=1){_124=_124.parentNode;}ev=document.createEvent("MouseEvents");ev.initMouseEvent("click",true,true,e.view,1,_123.screenX,_123.screenY,_123.clientX,_123.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null);ev._fake=true;_124.dispatchEvent(ev);},that.options.zoom?250:0);}}that._resetPos();return;}if(that.pullDownToRefresh&&that.contentReady&&that.pullDownEl.className.match("flip")){that.pullDownEl.className="iScrollPullDown loading";that.pullDownLabel.innerText=that.options.pullDownLabel[2];that.scroller.style.marginTop="0";that.offsetBottom=0;that.refresh();that.contentReady=false;that.options.onPullDown();}if(that.pullUpToRefresh&&that.contentReady&&that.pullUpEl.className.match("flip")){that.pullUpEl.className="iScrollPullUp loading";that.pullUpLabel.innerText=that.options.pullUpLabel[2];that.scroller.style.marginBottom="0";that.offsetTop=0;that.refresh();that.contentReady=false;that.options.onPullUp();}if(_127<300&&that.options.momentum){_125=_128?that._momentum(_128-that.startX,_127,-that.x,that.scrollerW-that.wrapperW+that.x,that.options.bounce?that.wrapperW:0):_125;_126=_129?that._momentum(_129-that.startY,_127,-that.y,(that.maxScrollY<0?that.scrollerH-that.wrapperH+that.y:0),that.options.bounce?that.wrapperH:0):_126;_128=that.x+_125.dist;_129=that.y+_126.dist;if((that.x>0&&_128>0)||(that.x<that.maxScrollX&&_128<that.maxScrollX)){_125={dist:0,time:0};}if((that.y>0&&_129>0)||(that.y<that.maxScrollY&&_129<that.maxScrollY)){_126={dist:0,time:0};}}if(_125.dist||_126.dist){_12a=m.max(m.max(_125.time,_126.time),10);if(that.options.snap){snap=that._snap(_128,_129);_128=snap.x;_129=snap.y;_12a=m.max(snap.time,_12a);}that.scrollTo(_128,_129,_12a);return;}if(that.options.snap){snap=that._snap(that.x,that.y);if(snap.x!=that.x||snap.y!=that.y){that.scrollTo(snap.x,snap.y,snap.time);}return;}that._resetPos();},_resetPos:function(time){var that=this,_12b=that.x,_12c=that.y;if(that.x>=0){_12b=0;}else{if(that.x<that.maxScrollX){_12b=that.maxScrollX;}}if(that.y>=0||that.maxScrollY>0){_12c=0;}else{if(that.y<that.maxScrollY){_12c=that.maxScrollY;}}if(_12b==that.x&&_12c==that.y){if(that.moved){if(that.options.onScrollEnd){that.options.onScrollEnd.call(that);}that.moved=false;}if(that.zoomed){if(that.options.onZoomEnd){that.options.onZoomEnd.call(that);}that.zoomed=false;}if(that.hScrollbar&&that.options.hideScrollbar){that.hScrollbarWrapper.style.webkitTransitionDelay="300ms";that.hScrollbarWrapper.style.opacity="0";}if(that.vScrollbar&&that.options.hideScrollbar){that.vScrollbarWrapper.style.webkitTransitionDelay="300ms";that.vScrollbarWrapper.style.opacity="0";}return;}if(time===undefined){time=200;}if(time){that.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";if(that.hScrollbar){that.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}if(that.vScrollbar){that.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}}that.scrollTo(_12b,_12c,time);},_timedScroll:function(_12d,_12e,_12f){var that=this,_130=that.x,_131=that.y,_132=(new Date).getTime(),_133;that._transitionTime(0);if(that.scrollInterval){clearInterval(that.scrollInterval);that.scrollInterval=null;}that.scrollInterval=setInterval(function(){var now=(new Date).getTime(),newX,newY;if(now>=_132+_12f){clearInterval(that.scrollInterval);that.scrollInterval=null;that._pos(_12d,_12e);that._transitionEnd();return;}now=(now-_132)/_12f-1;_133=m.sqrt(1-now*now);newX=(_12d-_130)*_133+_130;newY=(_12e-_131)*_133+_131;that._pos(newX,newY);},20);},_transitionEnd:function(e){var that=this;if(e){e.stopPropagation();}that._unbind("webkitTransitionEnd");that._resetPos(that.returnTime);that.returnTime=0;},_gestStart:function(e){var that=this;that._transitionTime(0);that.lastScale=1;if(that.options.onZoomStart){that.options.onZoomStart.call(that);}that._unbind("gesturestart");that._bind("gesturechange");that._bind("gestureend");that._bind("gesturecancel");},_gestChange:function(e){var that=this,_134=that.scale*e.scale,x,y,_135;that.zoomed=true;if(_134<that.options.zoomMin){_134=that.options.zoomMin;}else{if(_134>that.options.zoomMax){_134=that.options.zoomMax;}}_135=_134/that.scale;x=that.originX-that.originX*_135+that.x;y=that.originY-that.originY*_135+that.y;that.scroller.style.webkitTransform=_118+x+"px,"+y+"px"+_119+" scale("+_134+")";that.lastScale=_135;},_gestEnd:function(e){var that=this,_136=that.scale,_137=that.lastScale;that.scale=_136*_137;if(that.scale<that.options.zoomMin+0.05){that.scale=that.options.zoomMin;}else{if(that.scale>that.options.zoomMax-0.05){that.scale=that.options.zoomMax;}}_137=that.scale/_136;that.x=that.originX-that.originX*_137+that.x;that.y=that.originY-that.originY*_137+that.y;that.scroller.style.webkitTransform=_118+that.x+"px,"+that.y+"px"+_119+" scale("+that.scale+")";setTimeout(function(){that.refresh();},0);that._bind("gesturestart");that._unbind("gesturechange");that._unbind("gestureend");that._unbind("gesturecancel");},_wheel:function(e){var that=this,_138=that.x+e.wheelDeltaX/12,_139=that.y+e.wheelDeltaY/12;if(_138>0){_138=0;}else{if(_138<that.maxScrollX){_138=that.maxScrollX;}}if(_139>0){_139=0;}else{if(_139<that.maxScrollY){_139=that.maxScrollY;}}that.scrollTo(_138,_139,0);},_momentum:function(dist,time,_13a,_13b,size){var that=this,_13c=0.0006,_13d=m.abs(dist)/time,_13e=(_13d*_13d)/(2*_13c),_13f=0,_140=0;if(dist>0&&_13e>_13a){_140=size/(6/(_13e/_13d*_13c));_13a=_13a+_140;that.returnTime=800/size*_140+100;_13d=_13d*_13a/_13e;_13e=_13a;}else{if(dist<0&&_13e>_13b){_140=size/(6/(_13e/_13d*_13c));_13b=_13b+_140;that.returnTime=800/size*_140+100;_13d=_13d*_13b/_13e;_13e=_13b;}}_13e=_13e*(dist<0?-1:1);_13f=_13d/_13c;return {dist:_13e,time:m.round(_13f)};},_offset:function(el,tree){var left=-el.offsetLeft,top=-el.offsetTop;if(!tree){return {x:left,y:top};}while(el=el.offsetParent){left-=el.offsetLeft;top-=el.offsetTop;}return {x:left,y:top};},_snap:function(x,y){var that=this,i,l,page,time,_141,_142;page=that.pagesX.length-1;for(i=0,l=that.pagesX.length;i<l;i++){if(x>=that.pagesX[i]){page=i;break;}}if(page==that.currPageX&&page>0&&that.dirX<0){page--;}x=that.pagesX[page];_141=m.abs(x-that.pagesX[that.currPageX]);_141=_141?m.abs(that.x-x)/_141*500:0;that.currPageX=page;page=that.pagesY.length-1;for(i=0;i<page;i++){if(y>=that.pagesY[i]){page=i;break;}}if(page==that.currPageY&&page>0&&that.dirY<0){page--;}y=that.pagesY[page];_142=m.abs(y-that.pagesY[that.currPageY]);_142=_142?m.abs(that.y-y)/_142*500:0;that.currPageY=page;time=m.round(m.max(_141,_142))||200;return {x:x,y:y,time:time};},_bind:function(type,el){(el||this.scroller).addEventListener(type,this,false);},_unbind:function(type,el){(el||this.scroller).removeEventListener(type,this,false);},destroy:function(){var that=this;if(that.options.checkDOMChange){clearTimeout(that.DOMChangeInterval);}if(that.pullDownToRefresh){that.pullDownEl.parentNode.removeChild(that.pullDownEl);}if(that.pullUpToRefresh){that.pullUpEl.parentNode.removeChild(that.pullUpEl);}that.hScrollbar=false;that.vScrollbar=false;that._scrollbar("h");that._scrollbar("v");that.scroller.style.webkitTransform="";that._unbind("webkitTransitionEnd");that._unbind(_117);that._unbind(_113);that._unbind(_114);that._unbind(_115);that._unbind(_116);if(that.options.zoom){that._unbind("gesturestart");that._unbind("gesturechange");that._unbind("gestureend");that._unbind("gesturecancel");}},refresh:function(){var that=this,pos=0,page=0,i,l,els,_143,_144,_145;if(that.pullDownToRefresh){_145=that.pullDownEl.className.match("loading");if(_145&&!that.contentReady){_143=that.scrollerH;that.contentReady=true;that.pullDownEl.className="iScrollPullDown";that.pullDownLabel.innerText=that.options.pullDownLabel[0];that.offsetBottom=that.pullDownEl.offsetHeight;that.scroller.style.marginTop=-that.offsetBottom+"px";}else{if(!_145){that.offsetBottom=that.pullDownEl.offsetHeight;that.scroller.style.marginTop=-that.offsetBottom+"px";}}}if(that.pullUpToRefresh){_145=that.pullUpEl.className.match("loading");if(_145&&!that.contentReady){_143=that.scrollerH;that.contentReady=true;that.pullUpEl.className="iScrollPullUp";that.pullUpLabel.innerText=that.options.pullUpLabel[0];that.offsetTop=that.pullUpEl.offsetHeight;that.scroller.style.marginBottom=-that.offsetTop+"px";}else{if(!_145){that.offsetTop=that.pullUpEl.offsetHeight;that.scroller.style.marginBottom=-that.offsetTop+"px";}}}that.wrapperW=that.wrapper.clientWidth;that.wrapperH=that.wrapper.clientHeight;if(!that.wrapperW||!that.wrapperH){return false;}that.scrollerW=m.round(that.scroller.offsetWidth*that.scale);that.scrollerH=m.round((that.scroller.offsetHeight-that.offsetBottom-that.offsetTop)*that.scale);that.maxScrollX=that.wrapperW-that.scrollerW;that.maxScrollY=that.wrapperH-that.scrollerH;that.dirX=0;that.dirY=0;that._transitionTime(0);that.hScroll=that.options.hScroll&&that.maxScrollX<0;that.vScroll=that.options.vScroll&&(!that.options.bounceLock&&!that.hScroll||that.scrollerH>that.wrapperH);that.hScrollbar=that.hScroll&&that.options.hScrollbar;that.vScrollbar=that.vScroll&&that.options.vScrollbar&&that.scrollerH>that.wrapperH;that._scrollbar("h");that._scrollbar("v");if(typeof that.options.snap=="string"){that.pagesX=[];that.pagesY=[];els=that.scroller.querySelectorAll(that.options.snap);for(i=0,l=els.length;i<l;i++){pos=that._offset(els[i]);that.pagesX[i]=pos.x<that.maxScrollX?that.maxScrollX:pos.x*that.scale;that.pagesY[i]=pos.y<that.maxScrollY?that.maxScrollY:pos.y*that.scale;}}else{if(that.options.snap){that.pagesX=[];while(pos>=that.maxScrollX){that.pagesX[page]=pos;pos=pos-that.wrapperW;page++;}if(that.maxScrollX%that.wrapperW){that.pagesX[that.pagesX.length]=that.maxScrollX-that.pagesX[that.pagesX.length-1]+that.pagesX[that.pagesX.length-1];}pos=0;page=0;that.pagesY=[];while(pos>=that.maxScrollY){that.pagesY[page]=pos;pos=pos-that.wrapperH;page++;}if(that.maxScrollY%that.wrapperH){that.pagesY[that.pagesY.length]=that.maxScrollY-that.pagesY[that.pagesY.length-1]+that.pagesY[that.pagesY.length-1];}}}if(that.options.zoom){_144=that._offset(that.wrapper,true);that.wrapperOffsetLeft=-_144.x;that.wrapperOffsetTop=-_144.y;}if(_143&&that.y==0){_143=_143-that.scrollerH+that.y;that.scrollTo(0,_143,0);}that._resetPos();},scrollTo:function(x,y,time,_146){var that=this;if(_146){x=that.x-x;y=that.y-y;}time=!time||(m.round(that.x)==m.round(x)&&m.round(that.y)==m.round(y))?0:time;that.moved=true;if(!that.options.HWTransition){that._timedScroll(x,y,time);return;}if(time){that._bind("webkitTransitionEnd");}that._transitionTime(time);that._pos(x,y);if(!time){setTimeout(function(){that._transitionEnd();},0);}},scrollToElement:function(el,time){var that=this,pos;el=el.nodeType?el:that.scroller.querySelector(el);if(!el){return;}pos=that._offset(el);pos.x=pos.x>0?0:pos.x<that.maxScrollX?that.maxScrollX:pos.x;pos.y=pos.y>0?0:pos.y<that.maxScrollY?that.maxScrollY:pos.y;time=time===undefined?m.max(m.abs(pos.x)*2,m.abs(pos.y)*2):time;that.scrollTo(pos.x,pos.y,time);},scrollToPage:function(_147,_148,time){var that=this,x,y;if(that.options.snap){_147=_147=="next"?that.currPageX+1:_147=="prev"?that.currPageX-1:_147;_148=_148=="next"?that.currPageY+1:_148=="prev"?that.currPageY-1:_148;_147=_147<0?0:_147>that.pagesX.length-1?that.pagesX.length-1:_147;_148=_148<0?0:_148>that.pagesY.length-1?that.pagesY.length-1:_148;that.currPageX=_147;that.currPageY=_148;x=that.pagesX[_147];y=that.pagesY[_148];}else{x=-that.wrapperW*_147;y=-that.wrapperH*_148;if(x<that.maxScrollX){x=that.maxScrollX;}if(y<that.maxScrollY){y=that.maxScrollY;}}that.scrollTo(x,y,time||400);},zoom:function(x,y,_149,_14a){var that=this,_14b=_149/that.scale;x=x-that.wrapperOffsetLeft-that.x;y=y-that.wrapperOffsetTop-that.y;that.x=x-x*_14b+that.x;that.y=y-y*_14b+that.y;that.scale=_149;if(that.options.onZoomStart){that.options.onZoomStart.call(that);}that.refresh();that._bind("webkitTransitionEnd");that._transitionTime(_14a!==null?_14a:200);setTimeout(function(){that.zoomed=true;that.scroller.style.webkitTransform=_118+that.x+"px,"+that.y+"px"+_119+" scale("+_149+")";},0);}};var _111="WebKitCSSMatrix" in window&&"m11" in new WebKitCSSMatrix(),_112="ontouchstart" in window,_11f="ongesturestart" in window,_14c="WebKitTransitionEvent" in window,_110=(/iphone|ipad/gi).test(navigator.appVersion),_10f=(/android/gi).test(navigator.appVersion),_117="onorientationchange" in window?"orientationchange":"resize",_113=_112?"touchstart":"mousedown",_114=_112?"touchmove":"mousemove",_115=_112?"touchend":"mouseup",_116=_112?"touchcancel":"mouseup",_118="translate"+(_111?"3d(":"("),_119=_111?",0)":")",m=Math;if(typeof exports!=="undefined"){exports.iScroll=_10d;}else{window.iScroll=_10d;}})();}if(!dojo._hasResource["toura.ui.Scrollable"]){dojo._hasResource["toura.ui.Scrollable"]=true;dojo.provide("toura.ui.Scrollable");dojo.declare("toura.ui.Scrollable",dijit._Widget,{postCreate:function(){this.inherited(arguments);this.subscribe("/page/transition/end","_makeScroller");this.subscribe("/window/resize","refreshScroller");this.subscribe("/fontsize","refreshScroller");this.subscribe("/content/update",function(){this.refreshScroller();if(this.scroller){this.scroller.scrollTo(0,0);}});dojo.addClass(this.domNode,"scrollable");},_makeScroller:function(){if(this.domNode.children.length>1){console.error("toura.ui.Scrollable::_makeScroller: More than one child element. Only the first one will be scrollable. Probably not what you want!");}this.scroller=new iScroll(this.domNode,{vScrollbar:false});this.scroller.refresh();},makeScroller:function(){if(!this.scroller){this._makeScroller();}},destroy:function(){if(this.scroller){this.scroller.destroy();}this.inherited(arguments);},refreshScroller:function(){if(this.scroller){this.scroller.refresh();}}});}if(!dojo._hasResource["toura.ui.Clickable"]){dojo._hasResource["toura.ui.Clickable"]=true;dojo.provide("toura.ui.Clickable");dojo.declare("toura.ui.Clickable",null,{constructor:function(el,_14d){this.connections=[];this.secondaryConnections=[];this.subscriptions=[];this.handler=_14d;this.el=el;this.moved=false;dojo.addClass(this.el,"not-moving");if(toura.app.UI.hasTouch){this.connections.push(dojo.connect(el,"touchstart",this,"_onTouchStart"));this.connections.push(dojo.connect(el,"click",function(e){e.preventDefault();}));}else{this.connections.push(dojo.connect(el,"click",this,"_handle"));}},_onTouchStart:function(){this.touchStartTime=new Date().getTime();this.secondaryConnections=[dojo.connect(this.el,"touchmove",this,"_onTouchMove"),dojo.connect(this.el,"touchend",this,"_handle")];},_onTouchMove:function(){dojo.removeClass(this.el,"not-moving");this.moved=true;},_handle:function(e){this.touchEndTime=new Date().getTime();dojo.addClass(this.el,"not-moving");dojo.forEach(this.secondaryConnections||[],dojo.disconnect);this.secondaryConnections=[];if(toura.animating){e.preventDefault();console.log("click ignored during animation");return;}var _14e=e.target,href=dojo.attr(_14e,"href");if(this.touchStartTime&&(this.touchEndTime-this.touchStartTime>toura.app.UI.touchMoveDebounce)&&this.moved){this.moved=false;return;}while(!href&&_14e!==this.el){href=dojo.attr(_14e,"href");if(!href){_14e=_14e.parentNode;}}if(!href){return;}if(this.handler&&dojo.isFunction(this.handler)&&this.handler(_14e,e)===false){return;}if(!/#/.test(href)){return;}href=href.split("#")[1];if(href){e.preventDefault();e.stopPropagation();toura.app.Router.go(href);}},destroy:function(){dojo.forEach(this.connections||[],dojo.disconnect);dojo.forEach(this.secondaryConnections||[],dojo.disconnect);dojo.forEach(this.subscriptions||[],dojo.unsubscribe);}});}if(!dojo._hasResource["toura._View"]){dojo._hasResource["toura._View"]=true;dojo.provide("toura._View");(function(){var _14f={};dojo.declare("toura._View",[dijit._Widget,dijit._Templated,toura._Nls],{templateString:"%div",isHidden:false,isDisabled:false,postMixInProperties:function(){this.inherited(arguments);if(!this.device){this.device=toura.app.Config.get("device");}this.phone=this.device.type==="phone";this.tablet=this.device.type==="tablet";},_skipNodeCache:true,_stringRepl:function(tmpl){var t=_14f[tmpl]=(_14f[tmpl]||Haml(tmpl));return t(this);},postCreate:function(){this.inherited(arguments);},adopt:function(cls,_150,node){var x=new cls(_150,node);this._addItem(x);return x;},_addItem:function(){this._addedItems=this._addedItems||[];this._addedItems.push.apply(this._addedItems,arguments);},orphan:function(_151,_152){this._addedItems=this._addedItems||[];var i=dojo.indexOf(this._addedItems,_151);if(i>=0){this._addedItems.splice(i,1);}if(_152){this._kill(_151);}},_kill:function(w){if(w&&w.destroyRecursive){w.destroyRecursive();}else{if(w&&w.destroy){w.destroy();}}},query:function(sel){var nl,_153;if(!sel){return new dojo.NodeList(this.domNode);}else{_153=this.domNode.querySelectorAll(sel);nl=new dojo.NodeList();dojo.forEach(_153,function(n){nl.push(n);});}return nl;},preventClickDelay:function(el,_154){this.clickables=this.clickables||[];this.clickables.push(new toura.ui.Clickable(el,dojo.hitch(this,_154)));},destroy:function(){dojo.forEach(this._addedItems,this._kill);dojo.forEach(this.scrollerHandles||[],function(_155){_155.destroy();});dojo.forEach(this.clickables||[],function(c){c.destroy();});this.inherited(arguments);},addClass:function(_156){dojo.addClass(this.domNode,_156);},removeClass:function(_157){dojo.removeClass(this.domNode,_157);},show:function(_158){if(_158&&_158.nodeName){dojo.removeClass(_158,"hidden");return;}this.removeClass("hidden");this.isHidden=false;},hide:function(_159){if(_159&&_159.nodeName){dojo.addClass(_159,"hidden");return;}this.addClass("hidden");this.isHidden=true;},toggle:function(_15a){if(_15a){dojo.toggleClass(_15a,"hidden");return;}if(this.isHidden){this.show();}else{this.hide();}},enable:function(){this.removeClass("disabled");this.isDisabled=false;},disable:function(){this.addClass("disabled");this.isDisabled=true;}});}());}if(!dojo._hasResource["toura.containers.Pages"]){dojo._hasResource["toura.containers.Pages"]=true;dojo.provide("toura.containers.Pages");dojo.declare("toura.containers.Pages",[toura._View],{templateString:dojo.cache("toura.containers","Pages/Pages.haml","%ol.page-container\n"),direction:"next",postCreate:function(){this.connect(this.domNode,"webkitAnimationEnd","_onAnimationEnd");},_setNavDirectionAttr:function(dir){this.direction=dir==="back"?"prev":"next";},_setContentAttr:function(_15b){if(toura.animating){return;}var n=this.domNode,next=this.direction==="next";this.direction="next";this.currentPage=_15b;if(n.children.length){toura.animating=true;this.addClass("pre-slide");_15b.placeAt(n,next?"last":"first");this.addClass(next?"slide-left":"slide-right");}else{_15b.placeAt(n,"last");this._onAnimationEnd();}setTimeout(function(){if(this.animating){this._onAnimationEnd();}},600);},_cleanupOldPage:function(){var _15c=document.querySelectorAll("ol.page-container > li");dojo.forEach(_15c,function(page){if(this.currentPage.domNode!==page){dojo.destroy(page);var _15d=dijit.byNode(page);if(_15d){_15d.destroy();}}},this);this.removeClass(["slide-left","slide-right","pre-slide"]);},_onAnimationEnd:function(){this._cleanupOldPage();toura.animating=false;dojo.publish("/page/transition/end");}});}if(!dojo._hasResource["toura.components._Component"]){dojo._hasResource["toura.components._Component"]=true;dojo.provide("toura.components._Component");dojo.declare("toura.components._Component",[toura._View],{handleClicks:false,prepareData:function(){},setupConnections:function(){},setupSubscriptions:function(){},setupChildComponents:function(){},adjustMarkup:function(){},resizeElements:function(){},teardown:function(){},postMixInProperties:function(){this.inherited(arguments);if(this.screen){this.screen.registerComponent(this);this.connect(this.screen,"startup","startup");}this.prepareData();this._loadHelpers();this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.isHidden){this.hide();}if(this.handleClicks){this.preventClickDelay(this.clickableNode||this.domNode,this._clickHandler&&dojo.hitch(this,"_clickHandler"));}this.subscribe("/window/resize",function(){this.dimensions=null;});this.setupChildComponents();this.adjustMarkup();this.setupConnections();this.setupSubscriptions();},startup:function(){this.inherited(arguments);this.resizeElements();},destroy:function(){this.teardown();this.inherited(arguments);},_loadHelpers:function(){if(this.helpers&&dojo.isObject(this.helpers)){dojo.forIn(this.helpers,function(prop,tpl){if(tpl){this.helpers[prop]=Haml(tpl)();}},this);}},_setupTouch:function(ele,_15e){var _15f=toura.app.UI.hasTouch,evt=_15f?"touchstart":"click";this.connect(ele,evt,_15e);if(_15f){this.connect(ele,"click",function(e){e.preventDefault();});}},getDimensions:function(){var _160=this[this.sizeNode];this.dimensions=this.dimensions||{width:dojo.style(this.domNode,"width"),height:dojo.style(this.domNode,"height")};return this.dimensions;}});toura.component=function(name,_161){var p=dojo.mixin(_161,{templateString:_161.componentTemplate||"%div",prepareData:function(){this.inherited(arguments);if(_161.prep){_161.prep.call(this);}},postCreate:function(){this.inherited(arguments);if(jQuery){this.$domNode=jQuery(this.domNode);}},startup:function(){this.inherited(arguments);if(_161.init){_161.init.call(this);}}});dojo.declare("client.components."+name,[toura.components._Component],p);};}if(!dojo._hasResource["toura.components.SiblingNav"]){dojo._hasResource["toura.components.SiblingNav"]=true;dojo.provide("toura.components.SiblingNav");dojo.declare("toura.components.SiblingNav",[toura.components._Component],{templateString:dojo.cache("toura.components","SiblingNav/SiblingNav.haml",".component.sibling-nav\n  .handle{ dojoAttachPoint : 'handleNode' }\n    .toggler\n  %nav\n    .controller.prev{ dojoAttachPoint : 'prevButton' } prev\n    %ol.nodes{ dojoAttachPoint : 'siblingList' }\n    .controller.next{ dojoAttachPoint : 'nextButton' } next\n\n\n"),siblingTemplate:Haml(dojo.cache("toura.components","SiblingNav/Sibling.haml","%li{ class : className }\n  %span{ data-href : url }= name\n")),setupConnections:function(){var evt=toura.app.UI.hasTouch?"touchstart":"click";this.connect(this.handleNode,evt,"toggle");this.connect(this.prevButton,evt,dojo.hitch(this,"_handleButton","prev"));this.connect(this.nextButton,evt,dojo.hitch(this,"_handleButton","next"));this.connect(this.siblingList,evt,"_handleLink");},toggle:function(){this.set("open",!this.open);},_handleButton:function(dir){var node=this[dir+"Item"];if(dir==="prev"){toura.app.UI.set("navDirection","back");}toura.app.Router.go(node.url,true);},_handleLink:function(e){var _162=e.target,url=dojo.attr(_162,"data-href");if(!url){return;}if(dojo.hasClass(_162.parentNode,"prev")){toura.app.UI.set("navDirection","back");}toura.app.Router.go(url,true);},_setOpenAttr:function(open){dojo[open?"addClass":"removeClass"](this.domNode,"open");this.open=open;},_setNodeAttr:function(node){if(!node||!node.siblings||!node.siblings.length){this.hide();this.set("open",false);this.siblings=false;return;}this.show();this._processSiblings(node.siblings,node);},_processSiblings:function(_163,_164){this.siblings=_163.length?true:false;dojo.forEach(_163,function(_165,idx){if(_165.id===_164.id){this.currentIndex=idx;}},this);var _166=this.currentIndex+1;var _167=this.currentIndex-1;this.nextItem=_166>=_163.length?null:_163[_166];this.prevItem=_167<0?null:_163[_167];this._updateButtons();this._updateLinks();},_updateButtons:function(){dojo[this.nextItem?"removeClass":"addClass"](this.nextButton,"inactive");dojo[this.prevItem?"removeClass":"addClass"](this.prevButton,"inactive");},_updateLinks:function(){var html,_168;dojo.empty(this.siblingList);if(this.prevItem){_168=dojo.mixin(this.prevItem,{className:"prev"});this.prevLink=dojo.place(this.siblingTemplate(_168),this.siblingList);}if(this.nextItem){_168=dojo.mixin(this.nextItem,{className:"next"});this.nextLink=dojo.place(this.siblingTemplate(_168),this.siblingList);}}});}if(!dojo._hasResource["toura.app.UI"]){dojo._hasResource["toura.app.UI"]=true;dojo.provide("toura.app.UI");dojo.declare("toura.app.UI",[dojo.Stateful],{containers:{},currentPage:null,constructor:function(_169){this.device=_169;this.body=dojo.body();this.hasTouch="ontouchstart" in window;this.touchMoveDebounce=_169.os==="android"?200:0;this._navSetup();this._watchers();this._updateViewport();this._uiSetup();this._eventSetup();this._containersSetup();},_watchers:function(){var _16a={fontSize:function(k,_16b,_16c){var b=this.body;if(_16b){dojo.removeClass(b,_16b);}dojo.addClass(b,_16c);toura.app.DeviceStorage.set("fontSize",_16c);dojo.publish("/fontsize");},navDirection:function(k,old,dir){this.containers.pages.set("navDirection",dir);},siblingNavVisible:function(k,old,_16d){if(!this.siblingNav){return;}if(!this.siblingNav.siblings){this.siblingNav.hide();return;}this.siblingNav[_16d?"show":"hide"]();}};dojo.forIn(_16a,this.watch,this);},_updateViewport:function(){this.viewport={width:this.body.offsetWidth,height:this.body.offsetHeight};},_uiSetup:function(){var b=this.body,_16e=this.device,_16f;dojo.addClass(b,_16e.type);dojo.addClass(b,_16e.os);dojo.addClass(b,"version-"+toura.app.Phonegap.device.version);this.set("fontSize",toura.app.DeviceStorage.get("fontSize"));if(toura.features.multiLineChildNodes){dojo.addClass(b,"multi-line-child-nodes");}if(toura.isMAP){dojo.addClass(b,"layout-MAP");}dojo.forIn(toura.features,function(_170,_171){if(_171){dojo.addClass(b,"feature-"+_170);}});},_containersSetup:function(){this.containers.pages=new toura.containers.Pages().placeAt(this.body,"first");},_navSetup:function(){if(!toura.features.siblingNav){return;}this.siblingNav=new toura.components.SiblingNav().placeAt(this.body,"last");this.set("siblingNavVisible",false);},_eventSetup:function(){dojo.connect(document,"touchmove",function(e){e.preventDefault();});dojo.connect(window,"resize",this,function(){this._updateViewport();dojo.publish("/window/resize");});dojo.connect(document,"menubutton",this,function(e){e.preventDefault();dojo.publish("/button/menu");});dojo.connect(document,"backbutton",this,function(e){e.preventDefault();toura.app.Router.back();});dojo.connect(document,"searchbutton",this,function(e){toura.app.Router.go("/search");e.preventDefault();});if(this.siblingNav){dojo.connect(this.siblingNav,"show",this,function(){dojo.addClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});dojo.connect(this.siblingNav,"hide",this,function(){dojo.removeClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});}},showPage:function(page,node){if(!page){throw new Error("toura.app.UI::showPage called without a page to show");}if(page.startup){var s=dojo.subscribe("/page/transition/end",function(){page.startup();dojo.unsubscribe(s);});}this.containers.pages.set("content",page);this.currentPage=page;if(!this.siblingNav){return;}this.set("siblingNavVisible",true);this.siblingNav.set("node",node);},hideSplash:function(){var _172=dojo.byId("splash");if(_172){dojo.destroy(_172);}},getCurrentPage:function(){return this.currentPage;}});dojo.subscribe("/app/ready",function(){toura.app.UI=new toura.app.UI(toura.app.Config.get("device"));});}if(!dojo._hasResource["dojo.hash"]){dojo._hasResource["dojo.hash"]=true;dojo.provide("dojo.hash");(function(){dojo.hash=function(hash,_173){if(!arguments.length){return _174();}if(hash.charAt(0)=="#"){hash=hash.substring(1);}if(_173){_175(hash);}else{location.href="#"+hash;}return hash;};var _176,_177,_178,_179=dojo.config.hashPollFrequency||100;function _17a(str,_17b){var i=str.indexOf(_17b);return (i>=0)?str.substring(i+1):"";};function _174(){return _17a(location.href,"#");};function _17c(){dojo.publish("/dojo/hashchange",[_174()]);};function _17d(){if(_174()===_176){return;}_176=_174();_17c();};function _175(hash){if(_177){if(_177.isTransitioning()){setTimeout(dojo.hitch(null,_175,hash),_179);return;}var href=_177.iframe.location.href;var _17e=href.indexOf("?");_177.iframe.location.replace(href.substring(0,_17e)+"?"+hash);return;}location.replace("#"+hash);!_178&&_17d();};function _17f(){var ifr=document.createElement("iframe"),_180="dojo-hash-iframe",_181=dojo.config.dojoBlankHtmlUrl||dojo.moduleUrl("dojo","resources/blank.html");if(dojo.config.useXDomain&&!dojo.config.dojoBlankHtmlUrl){console.warn("dojo.hash: When using cross-domain Dojo builds,"+" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl"+" to the path on your domain to blank.html");}ifr.id=_180;ifr.src=_181+"?"+_174();ifr.style.display="none";document.body.appendChild(ifr);this.iframe=dojo.global[_180];var _182,_183,_184,_185,_186,_187=this.iframe.location;function _188(){_176=_174();_182=_186?_176:_17a(_187.href,"?");_183=false;_184=null;};this.isTransitioning=function(){return _183;};this.pollLocation=function(){if(!_186){try{var _189=_17a(_187.href,"?");if(document.title!=_185){_185=this.iframe.document.title=document.title;}}catch(e){_186=true;console.error("dojo.hash: Error adding history entry. Server unreachable.");}}var hash=_174();if(_183&&_176===hash){if(_186||_189===_184){_188();_17c();}else{setTimeout(dojo.hitch(this,this.pollLocation),0);return;}}else{if(_176===hash&&(_186||_182===_189)){}else{if(_176!==hash){_176=hash;_183=true;_184=hash;ifr.src=_181+"?"+_184;_186=false;setTimeout(dojo.hitch(this,this.pollLocation),0);return;}else{if(!_186){location.href="#"+_187.search.substring(1);_188();_17c();}}}}setTimeout(dojo.hitch(this,this.pollLocation),_179);};_188();setTimeout(dojo.hitch(this,this.pollLocation),_179);};dojo.addOnLoad(function(){if("onhashchange" in dojo.global&&(!dojo.isIE||(dojo.isIE>=8&&document.compatMode!="BackCompat"))){_178=dojo.connect(dojo.global,"onhashchange",_17c);}else{if(document.addEventListener){_176=_174();setInterval(_17d,_179);}else{if(document.attachEvent){_177=new _17f();}}}});})();}if(!dojo._hasResource["toura.app.Router"]){dojo._hasResource["toura.app.Router"]=true;dojo.provide("toura.app.Router");(function(d){d.declare("toura.app.Router",null,{QUERY_STRING_MATCHER:/\?([^#]*)$/,PATH_REPLACER:"([^/]+)",PATH_NAME_MATCHER:/:([\w\d]+)/g,_routes:[],_cache:{},_currentHash:null,_hasHistoryState:!!(history.pushState&&history.replaceState),constructor:function(_18a){if(!_18a||!_18a.routes){throw new Error("No routes defined for toura.app.Router");}d.forEach(_18a.routes,function(r){this.registerRoute(r.route,r.handler,r.defaultRoute);},this);},init:function(){if(!this.defaultRoute){console.error("No default route provided to router.");throw new Error("No default route provided to router.");}var hash=window.location.hash.toString(),loc=hash.replace("#","")||this.defaultRoute.origRoute;this.go(loc);d.subscribe("/dojo/hashchange",this,"_handleHash");if(this._hasHistoryState){d.connect(window,"onpopstate",this,function(){var hash=window.location.hash.replace("#","");this._handleHash(hash);});}},go:function(loc,_18b,_18c){var hash=loc.replace("#",""),_18d;if(this._hasHistoryState){history[_18b?"replaceState":"pushState"](_18c,null,"#"+hash);this._handleHash(hash);}else{window.location.hash=hash;this._handleHash(hash);}},back:function(){toura.app.UI.set("navDirection","back");history.back();},home:function(){toura.app.UI.set("navDirection","back");this.go("/home");},_handleHash:function(hash){if(hash===this._currentHash){console.log(">>> hash is a dupe, ignoring: "+hash);return;}this._currentHash=hash;toura.logSection("Handling "+hash);var _18e=this.currentRoute=this._lookupRoute(hash),_18f,_190=true;hash=hash.replace("#","");if(!_18e){console.log("No route found for hash "+hash);this.go(this.defaultRoute.origRoute);return;}_18f=this._parseParamsFromHash(hash);_18f.pageState=window.history.state;_18e=d.mixin(_18e,{hash:hash});_18e.callback(_18f,_18e);d.publish("/router/handleHash/after");toura.endLogSection("Handling "+hash);},_parseParamsFromHash:function(hash){var _191=hash.split("?"),path=_191[0],_192=_191[1],_193,_194,_195=decodeURIComponent,_196=this.currentRoute;_193=_192?d.mixin({},d.queryToObject(_192)):{};if((_194=_196.path.exec(this._routeablePath(path)))!==null){_194.shift();d.forEach(_194,function(_197,i){if(_196.paramNames[i]){_193[_196.paramNames[i]]=_195(_197);}else{if(!_193.splat){_193.splat=[];}_193.splat.push(_195(_197));}});}return _193;},_lookupRoute:function(hash){var _198=this._routeablePath(hash);if(!this._cache[hash]){d.forEach(this._routes,function(_199){if(this._routeablePath(hash).match(_199.path)){this._cache[hash]=_199;}},this);}return this._cache[hash];},_routeablePath:function(hash){return hash.replace(this.QUERY_STRING_MATCHER,"");},registerRoute:function(_19a,fn,_19b){var _19c,_19d=[],_19e=_19a,r;this.PATH_NAME_MATCHER.lastIndex=0;while((_19c=this.PATH_NAME_MATCHER.exec(_19a))!==null){_19d.push(_19c[1]);}_19a=d.isString(_19a)?new RegExp("^"+_19a.replace(this.PATH_NAME_MATCHER,this.PATH_REPLACER)+"$"):_19a;r={origRoute:_19e,path:_19a,callback:fn,paramNames:_19d};this._routes.push(r);if(_19b){this.defaultRoute=r;}}});}(dojo));}if(!dojo._hasResource["toura.models._Updateable"]){dojo._hasResource["toura.models._Updateable"]=true;dojo.provide("toura.models._Updateable");dojo.declare("toura.models._Updateable",[],{bundleDataUrl:"",remoteDataUrl:"",remoteVersionUrl:"",storageKey:"",lastChecked:0,constructor:function(_19f){dojo.mixin(this,_19f);},getItems:function(){console.warn("The getItems method has not been implemented by ",this.declaredClass);return this._items||[];},bootstrap:function(){console.log("toura.models._Updateable::bootstrap()");var _1a0=this._getLocalVersion(),dfd=this.deferred=new dojo.Deferred();dojo.when(_1a0<0?this._initializeData():true,dojo.hitch(this,"_updateIfNecessary")).then(dojo.hitch(this,"_onUpdate"));return dfd.promise;},_onUpdate:function(_1a1){if(_1a1){if(_1a1.appVersion&&this._isAppVersionCompatible(_1a1.appVersion)){dojo.when(this._store(_1a1),dojo.hitch(this,function(){this._onDataReady();this.deferred.resolve(true);}));}else{this.deferred.resolve(false);}}else{this.deferred.resolve(false);}},_isAppVersionCompatible:function(_1a2){var _1a3=toura.app.Config.get("appVersion"),_1a4=this._parseMajorVersion(_1a3);return _1a4===this._parseMajorVersion(_1a2);},_updateIfNecessary:function(){var dfd=new dojo.Deferred(),_1a5=this._getLocalVersion();dojo.when(this._getRemoteVersion(),dojo.hitch(this,function(_1a6){var _1a7=this._parseMajorVersion(toura.app.Config.get("appVersion"));if(_1a6){_1a6.appVersion=_1a6.appVersion||"2.0";}if(_1a6&&this._isAppVersionCompatible(_1a6.appVersion)&&(_1a6.version>_1a5)){this._getRemoteData().then(dojo.hitch(this,function(_1a8){if(!_1a8){dfd.resolve(false);return;}dfd.resolve(_1a8);}));}else{this._onDataReady();dfd.resolve(false);}}),function(){dfd.resolve(false);});return dfd.promise;},_xhr:function(url,dfd){return dojo.xhrGet({url:url,preventCache:true,handleAs:"json",contentType:false,load:dfd.resolve,error:dfd.reject});},_getRemoteVersion:function(){this.lastChecked=new Date().getTime();var dfd=new dojo.Deferred();if(toura.skipVersionCheck||!this.remoteVersionUrl){console.log("No remote version URL -- skipping remote version check");dfd.resolve({version:-1});}else{toura.app.Phonegap.network.isReachable().then(dojo.hitch(this,function(_1a9){if(!_1a9){dfd.resolve({version:-1});return;}this._xhr(this.remoteVersionUrl,dfd);}),dfd.reject);}return dfd.promise;},_getLocalVersion:function(){var v=toura.app.DeviceStorage.get(this.storageKey+"-version")||-1;return v;},_setLocalVersion:function(v){toura.app.DeviceStorage.set(this.storageKey+"-version",v);},_getRemoteData:function(){var dfd=new dojo.Deferred();if(!this.remoteDataUrl){console.log("No remote data URL -- skipping remote data check");dfd.resolve(false);}else{toura.app.Phonegap.network.isReachable().then(dojo.hitch(this,function(){this._xhr(this.remoteDataUrl,dfd);}),function(){dfd.resolve(false);});}return dfd.promise;},_getBundleData:function(){var dfd=new dojo.Deferred();if(!this.bundleDataUrl){dfd.resolve();}dojo.io.script.get({url:this.bundleDataUrl,preventCache:true}).then(dojo.hitch(this,function(_1aa){dfd.resolve(this._processBundleData(_1aa));}),function(){dfd.reject("Could not load local bundle data");});return dfd.promise;},_processBundleData:function(data){console.warn("_processBundleData was not implemented by",this.declaredClass);return data;},_initializeData:function(){var dfd=new dojo.Deferred();this._getBundleData().then(dojo.hitch(this,function(data){console.log("toura.models._Updateable::_initializeData() got",data);if(!data){dfd.resolve(false);return;}dojo.when(this._store(data),function(){dfd.resolve(true);});}));return dfd.promise;},_store:function(_1ab){this.lastUpdated=new Date().getTime();this._items=_1ab.items;this._setLocalVersion(_1ab&&_1ab.version||0);},_parseMajorVersion:function(_1ac){return +_1ac.split(".")[0];},_onDataReady:function(){}});}if(!dojo._hasResource["toura.models.Tour"]){dojo._hasResource["toura.models.Tour"]=true;dojo.provide("toura.models.Tour");dojo.declare("toura.models.Tour",[toura.models._Updateable],{storageKey:"tour",_store:function(data){this.inherited(arguments);var dfd=new dojo.Deferred();if(data.app){toura.app.DeviceStorage.set("app",data.app);}if(data.items){toura.app.DeviceStorage.set("tour",data.items).then(function(){dfd.resolve(true);});}return dfd.promise;},getItems:function(){if(this._items){return this._items;}var dfd=new dojo.Deferred();toura.app.DeviceStorage.get("tour").then(dojo.hitch(this,function(_1ad){if(toura.extraRawTourData&&dojo.isArray(toura.extraRawTourData)){dojo.forEach(toura.extraRawTourData,function(item){_1ad.push(item);});}this._items=_1ad;dfd.resolve(_1ad);}));return dfd.promise;},_processBundleData:function(){return toura.data.local;},_onDataReady:function(){toura.app.Config.set("app",toura.app.DeviceStorage.get("app"));}});}if(!dojo._hasResource["toura.app.Bootstrapper"]){dojo._hasResource["toura.app.Bootstrapper"]=true;dojo.provide("toura.app.Bootstrapper");toura.app.Bootstrapper=function(){var dfd=new dojo.Deferred(),app=toura.app,tour;app.DeviceStorage.init(app.Config.get("id"));tour=toura.app.Tour=new toura.models.Tour({bundleDataUrl:toura.localDataUrl||("./data/tour.js"+(app.Phonegap.present?".jet":"")),remoteDataUrl:app.Config.get("updateUrl"),remoteVersionUrl:app.Config.get("versionUrl")});dojo.subscribe("/page/transition/end",function(){var _1ae=tour.lastChecked,now=new Date().getTime(),_1af=now-_1ae,_1b0=1000*60*60*(toura.otaInterval||8),_1b1=_1af>_1b0;if(!_1b1){return;}tour.bootstrap().then(function(_1b2){if(!_1b2){return;}dojo.when(toura.app.Tour.getItems(),function(data){toura.app.Data.loadData(data);alert(dojo.i18n.getLocalization("toura","toura",toura.app.Config.get("locale")).OTA_UPDATE_NOTICE);toura.app.Router.home();});});});tour.bootstrap().then(dfd.resolve,dfd.reject);return dfd.promise;};}if(!dojo._hasResource["dojo.store.util.QueryResults"]){dojo._hasResource["dojo.store.util.QueryResults"]=true;dojo.provide("dojo.store.util.QueryResults");dojo.getObject("store.util",true,dojo);dojo.store.util.QueryResults=function(_1b3){if(!_1b3){return _1b3;}if(_1b3.then){_1b3=dojo.delegate(_1b3);}function _1b4(_1b5){if(!_1b3[_1b5]){_1b3[_1b5]=function(){var args=arguments;return dojo.when(_1b3,function(_1b6){Array.prototype.unshift.call(args,_1b6);return dojo.store.util.QueryResults(dojo[_1b5].apply(dojo,args));});};}};_1b4("forEach");_1b4("filter");_1b4("map");if(!_1b3.total){_1b3.total=dojo.when(_1b3,function(_1b7){return _1b7.length;});}return _1b3;};}if(!dojo._hasResource["dojo.store.util.SimpleQueryEngine"]){dojo._hasResource["dojo.store.util.SimpleQueryEngine"]=true;dojo.provide("dojo.store.util.SimpleQueryEngine");dojo.getObject("store.util",true,dojo);dojo.store.util.SimpleQueryEngine=function(_1b8,_1b9){switch(typeof _1b8){default:throw new Error("Can not query with a "+typeof _1b8);case "object":case "undefined":var _1ba=_1b8;_1b8=function(_1bb){for(var key in _1ba){var _1bc=_1ba[key];if(_1bc&&_1bc.test){if(!_1bc.test(_1bb[key])){return false;}}else{if(_1bc!=_1bb[key]){return false;}}}return true;};break;case "string":if(!this[_1b8]){throw new Error("No filter function "+_1b8+" was found in store");}_1b8=this[_1b8];case "function":}function _1bd(_1be){var _1bf=dojo.filter(_1be,_1b8);if(_1b9&&_1b9.sort){_1bf.sort(function(a,b){for(var sort,i=0;sort=_1b9.sort[i];i++){var _1c0=a[sort.attribute];var _1c1=b[sort.attribute];if(_1c0!=_1c1){return !!sort.descending==_1c0>_1c1?-1:1;}}return 0;});}if(_1b9&&(_1b9.start||_1b9.count)){var _1c2=_1bf.length;_1bf=_1bf.slice(_1b9.start||0,(_1b9.start||0)+(_1b9.count||Infinity));_1bf.total=_1c2;}return _1bf;};_1bd.matches=_1b8;return _1bd;};}if(!dojo._hasResource["dojo.store.Memory"]){dojo._hasResource["dojo.store.Memory"]=true;dojo.provide("dojo.store.Memory");dojo.declare("dojo.store.Memory",null,{constructor:function(_1c3){this.index={};dojo.mixin(this,_1c3);this.setData(this.data||[]);},data:null,idProperty:"id",index:null,queryEngine:dojo.store.util.SimpleQueryEngine,get:function(id){return this.index[id];},getIdentity:function(_1c4){return _1c4[this.idProperty];},put:function(_1c5,_1c6){var id=_1c6&&_1c6.id||_1c5[this.idProperty]||Math.random();this.index[id]=_1c5;var data=this.data,_1c7=this.idProperty;for(var i=0,l=data.length;i<l;i++){if(data[i][_1c7]==id){data[i]=_1c5;return id;}}this.data.push(_1c5);return id;},add:function(_1c8,_1c9){if(this.index[_1c9&&_1c9.id||_1c8[this.idProperty]]){throw new Error("Object already exists");}return this.put(_1c8,_1c9);},remove:function(id){delete this.index[id];var data=this.data,_1ca=this.idProperty;for(var i=0,l=data.length;i<l;i++){if(data[i][_1ca]==id){data.splice(i,1);return;}}},query:function(_1cb,_1cc){return dojo.store.util.QueryResults(this.queryEngine(_1cb,_1cc)(this.data));},setData:function(data){if(data.items){this.idProperty=data.identifier;data=this.data=data.items;}else{this.data=data;}for(var i=0,l=data.length;i<l;i++){var _1cd=data[i];this.index[_1cd[this.idProperty]]=_1cd;}}});}if(!dojo._hasResource["dojo.date"]){dojo._hasResource["dojo.date"]=true;dojo.provide("dojo.date");dojo.getObject("date",true,dojo);dojo.date.getDaysInMonth=function(_1ce){var _1cf=_1ce.getMonth();var days=[31,28,31,30,31,30,31,31,30,31,30,31];if(_1cf==1&&dojo.date.isLeapYear(_1ce)){return 29;}return days[_1cf];};dojo.date.isLeapYear=function(_1d0){var year=_1d0.getFullYear();return !(year%400)||(!(year%4)&&!!(year%100));};dojo.date.getTimezoneName=function(_1d1){var str=_1d1.toString();var tz="";var _1d2;var pos=str.indexOf("(");if(pos>-1){tz=str.substring(++pos,str.indexOf(")"));}else{var pat=/([A-Z\/]+) \d{4}$/;if((_1d2=str.match(pat))){tz=_1d2[1];}else{str=_1d1.toLocaleString();pat=/ ([A-Z\/]+)$/;if((_1d2=str.match(pat))){tz=_1d2[1];}}}return (tz=="AM"||tz=="PM")?"":tz;};dojo.date.compare=function(_1d3,_1d4,_1d5){_1d3=new Date(+_1d3);_1d4=new Date(+(_1d4||new Date()));if(_1d5=="date"){_1d3.setHours(0,0,0,0);_1d4.setHours(0,0,0,0);}else{if(_1d5=="time"){_1d3.setFullYear(0,0,0);_1d4.setFullYear(0,0,0);}}if(_1d3>_1d4){return 1;}if(_1d3<_1d4){return -1;}return 0;};dojo.date.add=function(date,_1d6,_1d7){var sum=new Date(+date);var _1d8=false;var _1d9="Date";switch(_1d6){case "day":break;case "weekday":var days,_1da;var mod=_1d7%5;if(!mod){days=(_1d7>0)?5:-5;_1da=(_1d7>0)?((_1d7-5)/5):((_1d7+5)/5);}else{days=mod;_1da=parseInt(_1d7/5);}var strt=date.getDay();var adj=0;if(strt==6&&_1d7>0){adj=1;}else{if(strt==0&&_1d7<0){adj=-1;}}var trgt=strt+days;if(trgt==0||trgt==6){adj=(_1d7>0)?2:-2;}_1d7=(7*_1da)+days+adj;break;case "year":_1d9="FullYear";_1d8=true;break;case "week":_1d7*=7;break;case "quarter":_1d7*=3;case "month":_1d8=true;_1d9="Month";break;default:_1d9="UTC"+_1d6.charAt(0).toUpperCase()+_1d6.substring(1)+"s";}if(_1d9){sum["set"+_1d9](sum["get"+_1d9]()+_1d7);}if(_1d8&&(sum.getDate()<date.getDate())){sum.setDate(0);}return sum;};dojo.date.difference=function(_1db,_1dc,_1dd){_1dc=_1dc||new Date();_1dd=_1dd||"day";var _1de=_1dc.getFullYear()-_1db.getFullYear();var _1df=1;switch(_1dd){case "quarter":var m1=_1db.getMonth();var m2=_1dc.getMonth();var q1=Math.floor(m1/3)+1;var q2=Math.floor(m2/3)+1;q2+=(_1de*4);_1df=q2-q1;break;case "weekday":var days=Math.round(dojo.date.difference(_1db,_1dc,"day"));var _1e0=parseInt(dojo.date.difference(_1db,_1dc,"week"));var mod=days%7;if(mod==0){days=_1e0*5;}else{var adj=0;var aDay=_1db.getDay();var bDay=_1dc.getDay();_1e0=parseInt(days/7);mod=days%7;var _1e1=new Date(_1db);_1e1.setDate(_1e1.getDate()+(_1e0*7));var _1e2=_1e1.getDay();if(days>0){switch(true){case aDay==6:adj=-1;break;case aDay==0:adj=0;break;case bDay==6:adj=-1;break;case bDay==0:adj=-2;break;case (_1e2+mod)>5:adj=-2;}}else{if(days<0){switch(true){case aDay==6:adj=0;break;case aDay==0:adj=1;break;case bDay==6:adj=2;break;case bDay==0:adj=1;break;case (_1e2+mod)<0:adj=2;}}}days+=adj;days-=(_1e0*2);}_1df=days;break;case "year":_1df=_1de;break;case "month":_1df=(_1dc.getMonth()-_1db.getMonth())+(_1de*12);break;case "week":_1df=parseInt(dojo.date.difference(_1db,_1dc,"day")/7);break;case "day":_1df/=24;case "hour":_1df/=60;case "minute":_1df/=60;case "second":_1df/=1000;case "millisecond":_1df*=_1dc.getTime()-_1db.getTime();}return Math.round(_1df);};}if(!dojo._hasResource["dojo.cldr.supplemental"]){dojo._hasResource["dojo.cldr.supplemental"]=true;dojo.provide("dojo.cldr.supplemental");dojo.getObject("cldr.supplemental",true,dojo);dojo.cldr.supplemental.getFirstDayOfWeek=function(_1e3){var _1e4={mv:5,ae:6,af:6,bh:6,dj:6,dz:6,eg:6,er:6,et:6,iq:6,ir:6,jo:6,ke:6,kw:6,ly:6,ma:6,om:6,qa:6,sa:6,sd:6,so:6,sy:6,tn:6,ye:6,ar:0,as:0,az:0,bw:0,ca:0,cn:0,fo:0,ge:0,gl:0,gu:0,hk:0,il:0,"in":0,jm:0,jp:0,kg:0,kr:0,la:0,mh:0,mn:0,mo:0,mp:0,mt:0,nz:0,ph:0,pk:0,sg:0,th:0,tt:0,tw:0,um:0,us:0,uz:0,vi:0,zw:0};var _1e5=dojo.cldr.supplemental._region(_1e3);var dow=_1e4[_1e5];return (dow===undefined)?1:dow;};dojo.cldr.supplemental._region=function(_1e6){_1e6=dojo.i18n.normalizeLocale(_1e6);var tags=_1e6.split("-");var _1e7=tags[1];if(!_1e7){_1e7={de:"de",en:"us",es:"es",fi:"fi",fr:"fr",he:"il",hu:"hu",it:"it",ja:"jp",ko:"kr",nl:"nl",pt:"br",sv:"se",zh:"cn"}[tags[0]];}else{if(_1e7.length==4){_1e7=tags[2];}}return _1e7;};dojo.cldr.supplemental.getWeekend=function(_1e8){var _1e9={"in":0,af:4,dz:4,ir:4,om:4,sa:4,ye:4,ae:5,bh:5,eg:5,il:5,iq:5,jo:5,kw:5,ly:5,ma:5,qa:5,sd:5,sy:5,tn:5};var _1ea={af:5,dz:5,ir:5,om:5,sa:5,ye:5,ae:6,bh:5,eg:6,il:6,iq:6,jo:6,kw:6,ly:6,ma:6,qa:6,sd:6,sy:6,tn:6};var _1eb=dojo.cldr.supplemental._region(_1e8);var _1ec=_1e9[_1eb];var end=_1ea[_1eb];if(_1ec===undefined){_1ec=6;}if(end===undefined){end=0;}return {start:_1ec,end:end};};}if(!dojo._hasResource["dojo.regexp"]){dojo._hasResource["dojo.regexp"]=true;dojo.provide("dojo.regexp");dojo.getObject("regexp",true,dojo);dojo.regexp.escapeString=function(str,_1ed){return str.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(ch){if(_1ed&&_1ed.indexOf(ch)!=-1){return ch;}return "\\"+ch;});};dojo.regexp.buildGroupRE=function(arr,re,_1ee){if(!(arr instanceof Array)){return re(arr);}var b=[];for(var i=0;i<arr.length;i++){b.push(re(arr[i]));}return dojo.regexp.group(b.join("|"),_1ee);};dojo.regexp.group=function(_1ef,_1f0){return "("+(_1f0?"?:":"")+_1ef+")";};}if(!dojo._hasResource["dojo.date.locale"]){dojo._hasResource["dojo.date.locale"]=true;dojo.provide("dojo.date.locale");dojo.getObject("date.locale",true,dojo);(function(){function _1f1(_1f2,_1f3,_1f4,_1f5){return _1f5.replace(/([a-z])\1*/ig,function(_1f6){var s,pad,c=_1f6.charAt(0),l=_1f6.length,_1f7=["abbr","wide","narrow"];switch(c){case "G":s=_1f3[(l<4)?"eraAbbr":"eraNames"][_1f2.getFullYear()<0?0:1];break;case "y":s=_1f2.getFullYear();switch(l){case 1:break;case 2:if(!_1f4.fullYear){s=String(s);s=s.substr(s.length-2);break;}default:pad=true;}break;case "Q":case "q":s=Math.ceil((_1f2.getMonth()+1)/3);pad=true;break;case "M":var m=_1f2.getMonth();if(l<3){s=m+1;pad=true;}else{var _1f8=["months","format",_1f7[l-3]].join("-");s=_1f3[_1f8][m];}break;case "w":var _1f9=0;s=dojo.date.locale._getWeekOfYear(_1f2,_1f9);pad=true;break;case "d":s=_1f2.getDate();pad=true;break;case "D":s=dojo.date.locale._getDayOfYear(_1f2);pad=true;break;case "E":var d=_1f2.getDay();if(l<3){s=d+1;pad=true;}else{var _1fa=["days","format",_1f7[l-3]].join("-");s=_1f3[_1fa][d];}break;case "a":var _1fb=(_1f2.getHours()<12)?"am":"pm";s=_1f4[_1fb]||_1f3["dayPeriods-format-wide-"+_1fb];break;case "h":case "H":case "K":case "k":var h=_1f2.getHours();switch(c){case "h":s=(h%12)||12;break;case "H":s=h;break;case "K":s=(h%12);break;case "k":s=h||24;break;}pad=true;break;case "m":s=_1f2.getMinutes();pad=true;break;case "s":s=_1f2.getSeconds();pad=true;break;case "S":s=Math.round(_1f2.getMilliseconds()*Math.pow(10,l-3));pad=true;break;case "v":case "z":s=dojo.date.locale._getZone(_1f2,true,_1f4);if(s){break;}l=4;case "Z":var _1fc=dojo.date.locale._getZone(_1f2,false,_1f4);var tz=[(_1fc<=0?"+":"-"),dojo.string.pad(Math.floor(Math.abs(_1fc)/60),2),dojo.string.pad(Math.abs(_1fc)%60,2)];if(l==4){tz.splice(0,0,"GMT");tz.splice(3,0,":");}s=tz.join("");break;default:throw new Error("dojo.date.locale.format: invalid pattern char: "+_1f5);}if(pad){s=dojo.string.pad(s,l);}return s;});};dojo.date.locale._getZone=function(_1fd,_1fe,_1ff){if(_1fe){return dojo.date.getTimezoneName(_1fd);}else{return _1fd.getTimezoneOffset();}};dojo.date.locale.format=function(_200,_201){_201=_201||{};var _202=dojo.i18n.normalizeLocale(_201.locale),_203=_201.formatLength||"short",_204=dojo.date.locale._getGregorianBundle(_202),str=[],_205=dojo.hitch(this,_1f1,_200,_204,_201);if(_201.selector=="year"){return _206(_204["dateFormatItem-yyyy"]||"yyyy",_205);}var _207;if(_201.selector!="date"){_207=_201.timePattern||_204["timeFormat-"+_203];if(_207){str.push(_206(_207,_205));}}if(_201.selector!="time"){_207=_201.datePattern||_204["dateFormat-"+_203];if(_207){str.push(_206(_207,_205));}}return str.length==1?str[0]:_204["dateTimeFormat-"+_203].replace(/\{(\d+)\}/g,function(_208,key){return str[key];});};dojo.date.locale.regexp=function(_209){return dojo.date.locale._parseInfo(_209).regexp;};dojo.date.locale._parseInfo=function(_20a){_20a=_20a||{};var _20b=dojo.i18n.normalizeLocale(_20a.locale),_20c=dojo.date.locale._getGregorianBundle(_20b),_20d=_20a.formatLength||"short",_20e=_20a.datePattern||_20c["dateFormat-"+_20d],_20f=_20a.timePattern||_20c["timeFormat-"+_20d],_210;if(_20a.selector=="date"){_210=_20e;}else{if(_20a.selector=="time"){_210=_20f;}else{_210=_20c["dateTimeFormat-"+_20d].replace(/\{(\d+)\}/g,function(_211,key){return [_20f,_20e][key];});}}var _212=[],re=_206(_210,dojo.hitch(this,_213,_212,_20c,_20a));return {regexp:re,tokens:_212,bundle:_20c};};dojo.date.locale.parse=function(_214,_215){var _216=/[\u200E\u200F\u202A\u202E]/g,info=dojo.date.locale._parseInfo(_215),_217=info.tokens,_218=info.bundle,re=new RegExp("^"+info.regexp.replace(_216,"")+"$",info.strict?"":"i"),_219=re.exec(_214&&_214.replace(_216,""));if(!_219){return null;}var _21a=["abbr","wide","narrow"],_21b=[1970,0,1,0,0,0,0],amPm="",_21c=dojo.every(_219,function(v,i){if(!i){return true;}var _21d=_217[i-1];var l=_21d.length;switch(_21d.charAt(0)){case "y":if(l!=2&&_215.strict){_21b[0]=v;}else{if(v<100){v=Number(v);var year=""+new Date().getFullYear(),_21e=year.substring(0,2)*100,_21f=Math.min(Number(year.substring(2,4))+20,99),num=(v<_21f)?_21e+v:_21e-100+v;_21b[0]=num;}else{if(_215.strict){return false;}_21b[0]=v;}}break;case "M":if(l>2){var _220=_218["months-format-"+_21a[l-3]].concat();if(!_215.strict){v=v.replace(".","").toLowerCase();_220=dojo.map(_220,function(s){return s.replace(".","").toLowerCase();});}v=dojo.indexOf(_220,v);if(v==-1){return false;}}else{v--;}_21b[1]=v;break;case "E":case "e":var days=_218["days-format-"+_21a[l-3]].concat();if(!_215.strict){v=v.toLowerCase();days=dojo.map(days,function(d){return d.toLowerCase();});}v=dojo.indexOf(days,v);if(v==-1){return false;}break;case "D":_21b[1]=0;case "d":_21b[2]=v;break;case "a":var am=_215.am||_218["dayPeriods-format-wide-am"],pm=_215.pm||_218["dayPeriods-format-wide-pm"];if(!_215.strict){var _221=/\./g;v=v.replace(_221,"").toLowerCase();am=am.replace(_221,"").toLowerCase();pm=pm.replace(_221,"").toLowerCase();}if(_215.strict&&v!=am&&v!=pm){return false;}amPm=(v==pm)?"p":(v==am)?"a":"";break;case "K":if(v==24){v=0;}case "h":case "H":case "k":if(v>23){return false;}_21b[3]=v;break;case "m":_21b[4]=v;break;case "s":_21b[5]=v;break;case "S":_21b[6]=v;}return true;});var _222=+_21b[3];if(amPm==="p"&&_222<12){_21b[3]=_222+12;}else{if(amPm==="a"&&_222==12){_21b[3]=0;}}var _223=new Date(_21b[0],_21b[1],_21b[2],_21b[3],_21b[4],_21b[5],_21b[6]);if(_215.strict){_223.setFullYear(_21b[0]);}var _224=_217.join(""),_225=_224.indexOf("d")!=-1,_226=_224.indexOf("M")!=-1;if(!_21c||(_226&&_223.getMonth()>_21b[1])||(_225&&_223.getDate()>_21b[2])){return null;}if((_226&&_223.getMonth()<_21b[1])||(_225&&_223.getDate()<_21b[2])){_223=dojo.date.add(_223,"hour",1);}return _223;};function _206(_227,_228,_229,_22a){var _22b=function(x){return x;};_228=_228||_22b;_229=_229||_22b;_22a=_22a||_22b;var _22c=_227.match(/(''|[^'])+/g),_22d=_227.charAt(0)=="'";dojo.forEach(_22c,function(_22e,i){if(!_22e){_22c[i]="";}else{_22c[i]=(_22d?_229:_228)(_22e.replace(/''/g,"'"));_22d=!_22d;}});return _22a(_22c.join(""));};function _213(_22f,_230,_231,_232){_232=dojo.regexp.escapeString(_232);if(!_231.strict){_232=_232.replace(" a"," ?a");}return _232.replace(/([a-z])\1*/ig,function(_233){var s,c=_233.charAt(0),l=_233.length,p2="",p3="";if(_231.strict){if(l>1){p2="0"+"{"+(l-1)+"}";}if(l>2){p3="0"+"{"+(l-2)+"}";}}else{p2="0?";p3="0{0,2}";}switch(c){case "y":s="\\d{2,4}";break;case "M":s=(l>2)?"\\S+?":p2+"[1-9]|1[0-2]";break;case "D":s=p2+"[1-9]|"+p3+"[1-9][0-9]|[12][0-9][0-9]|3[0-5][0-9]|36[0-6]";break;case "d":s="3[01]|[12]\\d|"+p2+"[1-9]";break;case "w":s=p2+"[1-9]|[1-4][0-9]|5[0-3]";break;case "E":s="\\S+";break;case "h":s=p2+"[1-9]|1[0-2]";break;case "k":s=p2+"\\d|1[01]";break;case "H":s=p2+"\\d|1\\d|2[0-3]";break;case "K":s=p2+"[1-9]|1\\d|2[0-4]";break;case "m":case "s":s="[0-5]\\d";break;case "S":s="\\d{"+l+"}";break;case "a":var am=_231.am||_230["dayPeriods-format-wide-am"],pm=_231.pm||_230["dayPeriods-format-wide-pm"];if(_231.strict){s=am+"|"+pm;}else{s=am+"|"+pm;if(am!=am.toLowerCase()){s+="|"+am.toLowerCase();}if(pm!=pm.toLowerCase()){s+="|"+pm.toLowerCase();}if(s.indexOf(".")!=-1){s+="|"+s.replace(/\./g,"");}}s=s.replace(/\./g,"\\.");break;default:s=".*";}if(_22f){_22f.push(_233);}return "("+s+")";}).replace(/[\xa0 ]/g,"[\\s\\xa0]");};})();(function(){var _234=[];dojo.date.locale.addCustomFormats=function(_235,_236){_234.push({pkg:_235,name:_236});};dojo.date.locale._getGregorianBundle=function(_237){var _238={};dojo.forEach(_234,function(desc){var _239=dojo.i18n.getLocalization(desc.pkg,desc.name,_237);_238=dojo.mixin(_238,_239);},this);return _238;};})();dojo.date.locale.addCustomFormats("dojo.cldr","gregorian");dojo.date.locale.getNames=function(item,type,_23a,_23b){var _23c,_23d=dojo.date.locale._getGregorianBundle(_23b),_23e=[item,_23a,type];if(_23a=="standAlone"){var key=_23e.join("-");_23c=_23d[key];if(_23c[0]==1){_23c=undefined;}}_23e[1]="format";return (_23c||_23d[_23e.join("-")]).concat();};dojo.date.locale.isWeekend=function(_23f,_240){var _241=dojo.cldr.supplemental.getWeekend(_240),day=(_23f||new Date()).getDay();if(_241.end<_241.start){_241.end+=7;if(day<_241.start){day+=7;}}return day>=_241.start&&day<=_241.end;};dojo.date.locale._getDayOfYear=function(_242){return dojo.date.difference(new Date(_242.getFullYear(),0,1,_242.getHours()),_242)+1;};dojo.date.locale._getWeekOfYear=function(_243,_244){if(arguments.length==1){_244=0;}var _245=new Date(_243.getFullYear(),0,1).getDay(),adj=(_245-_244+7)%7,week=Math.floor((dojo.date.locale._getDayOfYear(_243)+adj-1)/7);if(_245==_244){week++;}return week;};}if(!dojo._hasResource["toura.models.Favorite"]){dojo._hasResource["toura.models.Favorite"]=true;dojo.provide("toura.models.Favorite");dojo.declare("toura.models.Favorite",[],{constructor:function(obj){var _246=new Date(),_247={id:obj.id,type:"node",name:obj.name,added:_246.getTime(),displayDate:dojo.date.locale.format(_246,{datePattern:"d MMMM yyy",timePattern:"H:m"})};dojo.mixin(this,_247);}});}if(!dojo._hasResource["toura.app.user.Favorites"]){dojo._hasResource["toura.app.user.Favorites"]=true;dojo.provide("toura.app.user.Favorites");(function(){var ds=toura.app.DeviceStorage;dojo.declare("toura.app.user.Favorites",[],{constructor:function(){this._init();this.subscriptions=[dojo.subscribe("/favorite/add",this,"_addFavorite"),dojo.subscribe("/favorite/remove",this,"_removeFavorite"),dojo.subscribe("/favorites/clear",this,"_empty"),dojo.subscribe("/data/loaded",this,"_refresh")];},hasFavorites:function(){return !!this.store.data.length;},_init:function(){var favs=ds.get("favorites");this.store=new dojo.store.Memory({data:favs||[]});this._refresh();},_refresh:function(){dojo.forEach(this.store.data,function(item){if(!toura.app.Data.getById(item.id)){item.deleted=true;this.store.put(item);}},this);this.onRefresh(this.store.data);},onRefresh:function(data){},load:function(_248,_249){if(!_248){_248="added";_249=true;}return this._sort(_248||"added",_249);},isFavorite:function(obj){return !!obj&&!!obj.id&&!!this.store.get(obj.id);},_removeFavorite:function(obj){console.log("toura.app.user.Favorites::_removeFavorite()",obj);var id=dojo.isString(obj)?obj:obj.id;this.store.remove(id);this._save();},_empty:function(){this._save([]);this._init();},_save:function(_24a){console.log("will try to save",this.store.data);ds.set("favorites",_24a||this.store.data);},_addFavorite:function(obj){console.log("toura.app.user.Favorites::_addFavorite()",obj);if(this.isFavorite(obj)){return;}this.store.add(new toura.models.Favorite(obj));this._save();},_sort:function(prop,_24b){if(!prop){throw new Error("toura.app.user.Favorites::_sort requires a property for sorting");}var data=[].concat(this.store.data),_24c=this._makeModels(data[0]&&data[0][prop]?data.sort(function(a,b){a=a[prop];b=b[prop];if(a<b){return _24b?1:-1;}if(a>b){return _24b?-1:1;}return 0;}):data);return _24c;},_makeModels:function(data){return dojo.map(data,function(item){return dojo.mixin({model:toura.app.Data.getModel(item.id)},item);},this);},destroy:function(){dojo.forEach(this.subscriptions,dojo.unsubscribe);}});}());dojo.subscribe("/app/ready",function(){toura.app.user.Favorites=new toura.app.user.Favorites();});}if(!dojo._hasResource["toura.ui.BackgroundImage"]){dojo._hasResource["toura.ui.BackgroundImage"]=true;dojo.provide("toura.ui.BackgroundImage");dojo.declare("toura.ui.BackgroundImage",[toura._View],{imageUrl:"",imageHeight:"",imageWidth:"",resizeMethod:"contain",isLoaded:false,loadOnInit:false,postCreate:function(){this.inherited(arguments);if(this.loadOnInit){this.loadImage();}},loadImage:function(){if(this.isLoaded){return;}dojo.style(this.domNode,{"backgroundImage":"url("+this.imageUrl+")","backgroundRepeat":"no-repeat"});if(!toura.app.Has.cssBackgroundContain()){this._resizeImage();this.subscription=this.subscription||dojo.subscribe("/window/resize",this,function(){this._resizeImage();});}this.isLoaded=true;},unloadImage:function(){dojo.style(this.domNode,"backgroundImage",null);this.isLoaded=false;if(this.subscription){dojo.unsubscribe(this.subscription);}},_setBackgroundImageAttr:function(_24d){if(!_24d){return;}dojo.mixin(this,{imageUrl:_24d.url,imageWidth:_24d.width,imageHeight:_24d.height});},_resizeImage:function(){var _24e=this._getDimensions(),_24f={width:this.imageWidth,height:this.imageHeight},_250=this._calculateDimensions(_24e,_24f);dojo.style(this.domNode,"webkitBackgroundSize",_250.width+"px "+_250.height+"px");},_calculateDimensions:function(_251,_252){var _253=_252.width/_252.height,_254=_251.width/_251.height;if(this.resizeMethod==="contain"){if(_253<_254){return this._fitToHeight(_251,_252);}else{return this._fitToWidth(_251,_252);}}else{if(_253<_254){return this._fitToWidth(_251,_252);}else{return this._fitToHeight(_251,_252);}}},_fitToWidth:function(_255,_256){return {width:_255.width,height:Math.ceil(_256.height*(_255.width/_256.width))};},_fitToHeight:function(_257,_258){return {width:Math.ceil(_258.width*(_257.height/_258.height)),height:_257.height};},_getDimensions:function(){this.dimensions=this.dimensions||{width:dojo.style(this.domNode,"width"),height:dojo.style(this.domNode,"height")};return this.dimensions;},destroy:function(){this.inherited(arguments);if(this.subscription){dojo.unsubscribe(this.subscription);}}});}if(!dojo._hasResource["toura.pageControllers._Page"]){dojo._hasResource["toura.pageControllers._Page"]=true;dojo.provide("toura.pageControllers._Page");dojo.declare("toura.pageControllers._Page",[toura._View,toura.ui.BackgroundImage],{"class":"page",widgetsInTemplate:true,init:function(_259){this.initialized=true;},postMixInProperties:function(){this.inherited(arguments);if(!this.device){throw "No device defined for page controller";}},postCreate:function(){this.setupNav();this._doPlacements();this._setup();this._applyBackgroundImage();this.inherited(arguments);},_doPlacements:function(){this.componentStartups=[];dojo.forEach(this.placements||[],function(arr){if(arr.length<3){console.error("Not enough information for placement",arr);return;}var _25a=this[arr[2]],data=arr[1],C=toura.components[arr[0]],_25b,_25c=arr[3]||"last";if(_25a&&C){_25b=this.adopt(C,data);this[arr[2]]=_25b.placeAt(_25a,_25c);if(_25b.startup){this.componentStartups.push(dojo.hitch(_25b,"startup"));}}},this);},_setup:function(){},_applyBackgroundImage:function(){var img=this._getBackgroundImage();if(!img){return;}this.set("backgroundImage",img);this.set("resizeMethod","cover");this.loadImage();},_getBackgroundImage:function(){var _25d=toura.app.Config.get("app").backgroundImage,img;if(!_25d){console.warn("toura.pageControllers._Page::_getBackgroundImage: No bg image specified for app.");return;}_25d=_25d[this.device.type];if(!_25d){console.warn("toura.pageControllers._Page::_getBackgroundImage: No bg image specified for type.");return;}img=toura.app.Data.getModel(_25d,"backgroundImage");return this.device.type==="phone"?img.gallery:img.original;},_getDimensions:function(){return toura.app.UI.viewport;},setupNav:function(){},startup:function(){this.inherited(arguments);dojo.forEach(this.componentStartups,function(fn){fn();});}});}if(!dojo._hasResource["toura.app.user.Facebook.android"]){dojo._hasResource["toura.app.user.Facebook.android"]=true;dojo.provide("toura.app.user.Facebook.android");toura.app.user.Facebook.android={init:function(_25e){this.appId=_25e;(function(){function _25f(){};_25f.prototype.authorize=function(_260,_261){PhoneGap.exec(_261,null,"FacebookAuth","authorize",[_260]);};_25f.prototype.request=function(path,_262){PhoneGap.exec(_262,null,"FacebookAuth","request",[path]);};_25f.prototype.getAccess=function(_263){PhoneGap.exec(_263,null,"FacebookAuth","getAccess",[]);};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("facebook",new _25f());PluginManager.addService("FacebookAuth","com.phonegap.plugins.facebook.FacebookAuth");});}());},_realGetAuth:function(){var dfd=new dojo.Deferred();window.plugins.facebook.authorize(this.appId,dojo.hitch(this,function(res){if(res.token){this.token=res.token;dfd.resolve(res.token);}else{window.plugins.facebook.getAccess(dojo.hitch(this,function(res){if(!res.token){dfd.reject();return;}this.token=res.token;dfd.resolve(res.token);}));}}));return dfd;}};}if(!dojo._hasResource["toura.app.user.Facebook.ios"]){dojo._hasResource["toura.app.user.Facebook.ios"]=true;dojo.provide("toura.app.user.Facebook.ios");toura.app.user.Facebook.ios={init:function(_264){this.authUrl="https://graph.facebook.com/oauth/authorize?"+dojo.objectToQuery({client_id:_264,redirect_uri:"https://www.facebook.com/connect/login_success.html",response_type:"token",scope:"publish_stream,offline_access"});this.childBrowser=toura.app.Phonegap.browser.getBrowser();},_realGetAuth:function(){var dfd=new dojo.Deferred();this.childBrowser.showWebPage(this.authUrl);this.childBrowser.onLocationChange=dojo.hitch(this,function(loc){var _265=this._findToken(loc);if(!_265){dfd.reject();return;}this.childBrowser.close();dfd.resolve(_265);});return dfd;},_findToken:function(loc){if(loc.indexOf("login_success")){var _266=dojo.queryToObject(unescape(loc).split("#")[1]);return _266.access_token;}return false;}};}if(!dojo._hasResource["toura.app.user.Facebook.browser"]){dojo._hasResource["toura.app.user.Facebook.browser"]=true;dojo.provide("toura.app.user.Facebook.browser");toura.app.user.Facebook.browser={init:function(_267){if(!toura.features.socialInBrowser){return;}window.fbAsyncInit=function(){FB.init({appId:_267});};var e=document.createElement("script");e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";e.async=true;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(e,s);},_realGetAuth:function(){var dfd=new dojo.Deferred();if(FB){FB.login(function(resp){dfd.resolve(resp.session&&resp.session.access_token);},{perms:"publish_stream"});}else{dfd.resolve();}return dfd;},_postMessage:function(msg){var dfd=new dojo.Deferred();if(FB){FB.api("/me/feed","post",{message:msg},function(resp){if(!resp||resp.error){dfd.reject(resp&&resp.error);}else{dfd.resolve();}});}else{dfd.resolve();}return dfd.promise;}};}if(!dojo._hasResource["toura.app.user.Facebook.base"]){dojo._hasResource["toura.app.user.Facebook.base"]=true;dojo.provide("toura.app.user.Facebook.base");dojo.declare("toura.app.user.Facebook.base",[],{token:null,constructor:function(){var self=this;this.device=toura.app.Config.get("device");dojo.mixin(this,toura.app.user.Facebook[toura.app.Phonegap.present?this.device.os:"browser"]);var key=toura.app.Config.get("app").facebookApiKey;if(key){this.init(key);}else{this.disabled=true;}},isAuthenticated:function(){console.log("toura.app.user.Facebook::isAuthenticated()");return !!this.token;},postMessage:function(msg){console.log("toura.app.user.Facebook::postMessage()");if(!msg){return;}var dfd=new dojo.Deferred();dojo.when(this._getAuth(),dojo.hitch(this,function(t){this.token=t;this._postMessage(msg,t).then(dfd.resolve,dfd.reject);}));return dfd.promise;},_postMessage:function(msg,_268){var url="https://graph.facebook.com/me/feed"+"?"+dojo.objectToQuery({message:msg,link:"",picture:""})+"&access_token="+_268;return dojo.xhrPost({url:url});},_getAuth:function(){console.log("toura.app.user.Facebook::_getAuth()");return this.token||this._realGetAuth().promise;}});}if(!dojo._hasResource["vendor.sha"]){dojo._hasResource["vendor.sha"]=true;dojo.provide("vendor.sha");(function(){var _269=8,_26a="",_26b=0,_26c=function(a,b){this.highOrder=a;this.lowOrder=b;},_26d=function(a){var b=[],mask=(1<<_269)-1,_26e=a.length*_269,i;for(i=0;i<_26e;i+=_269){b[i>>5]|=(a.charCodeAt(i/_269)&mask)<<(32-_269-(i%32));}return b;},_26f=function(a){var b=[],_270=a.length,i,num;for(i=0;i<_270;i+=2){num=parseInt(a.substr(i,2),16);if(!isNaN(num)){b[i>>3]|=num<<(24-(4*(i%8)));}else{return "INVALID HEX STRING";}}return b;},_271=function(a){var b=(_26b)?"0123456789ABCDEF":"0123456789abcdef",str="",_272=a.length*4,i,_273;for(i=0;i<_272;i+=1){_273=a[i>>2]>>((3-(i%4))*8);str+=b.charAt((_273>>4)&15)+b.charAt(_273&15);}return str;},_274=function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"+"0123456789+/",str="",_275=a.length*4,i,j,_276;for(i=0;i<_275;i+=3){_276=(((a[i>>2]>>8*(3-i%4))&255)<<16)|(((a[i+1>>2]>>8*(3-(i+1)%4))&255)<<8)|((a[i+2>>2]>>8*(3-(i+2)%4))&255);for(j=0;j<4;j+=1){if(i*8+j*6<=a.length*32){str+=b.charAt((_276>>6*(3-j))&63);}else{str+=_26a;}}}return str;},_277=function(x,n){return (x<<n)|(x>>>(32-n));},_278=function(x,n){return (x>>>n)|(x<<(32-n));},_279=function(x,n){if(n<=32){return new _26c((x.highOrder>>>n)|(x.lowOrder<<(32-n)),(x.lowOrder>>>n)|(x.highOrder<<(32-n)));}else{return new _26c((x.lowOrder>>>n)|(x.highOrder<<(32-n)),(x.highOrder>>>n)|(x.lowOrder<<(32-n)));}},_27a=function(x,n){return x>>>n;},_27b=function(x,n){if(n<=32){return new _26c(x.highOrder>>>n,x.lowOrder>>>n|(x.highOrder<<(32-n)));}else{return new _26c(0,x.highOrder<<(32-n));}},_27c=function(x,y,z){return x^y^z;},_27d=function(x,y,z){return (x&y)^(~x&z);},_27e=function(x,y,z){return new _26c((x.highOrder&y.highOrder)^(~x.highOrder&z.highOrder),(x.lowOrder&y.lowOrder)^(~x.lowOrder&z.lowOrder));},_27f=function(x,y,z){return (x&y)^(x&z)^(y&z);},_280=function(x,y,z){return new _26c((x.highOrder&y.highOrder)^(x.highOrder&z.highOrder)^(y.highOrder&z.highOrder),(x.lowOrder&y.lowOrder)^(x.lowOrder&z.lowOrder)^(y.lowOrder&z.lowOrder));},_281=function(x){return _278(x,2)^_278(x,13)^_278(x,22);},_282=function(x){var a=_279(x,28),_283=_279(x,34),_284=_279(x,39);return new _26c(a.highOrder^_283.highOrder^_284.highOrder,a.lowOrder^_283.lowOrder^_284.lowOrder);},_285=function(x){return _278(x,6)^_278(x,11)^_278(x,25);},_286=function(x){var a=_279(x,14),_287=_279(x,18),_288=_279(x,41);return new _26c(a.highOrder^_287.highOrder^_288.highOrder,a.lowOrder^_287.lowOrder^_288.lowOrder);},_289=function(x){return _278(x,7)^_278(x,18)^_27a(x,3);},_28a=function(x){var a=_279(x,1),_28b=_279(x,8),shr7=_27b(x,7);return new _26c(a.highOrder^_28b.highOrder^shr7.highOrder,a.lowOrder^_28b.lowOrder^shr7.lowOrder);},_28c=function(x){return _278(x,17)^_278(x,19)^_27a(x,10);},_28d=function(x){var a=_279(x,19),_28e=_279(x,61),shr6=_27b(x,6);return new _26c(a.highOrder^_28e.highOrder^shr6.highOrder,a.lowOrder^_28e.lowOrder^shr6.lowOrder);},_28f=function(x,y){var a=(x&65535)+(y&65535),msw=(x>>>16)+(y>>>16)+(a>>>16);return ((msw&65535)<<16)|(a&65535);},_290=function(a,b,c,d){var e=(a&65535)+(b&65535)+(c&65535)+(d&65535),msw=(a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16);return ((msw&65535)<<16)|(e&65535);},_291=function(a,b,c,d,e){var f=(a&65535)+(b&65535)+(c&65535)+(d&65535)+(e&65535),msw=(a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)+(f>>>16);return ((msw&65535)<<16)|(f&65535);},_292=function(x,y){var a,msw,_293,_294;a=(x.lowOrder&65535)+(y.lowOrder&65535);msw=(x.lowOrder>>>16)+(y.lowOrder>>>16)+(a>>>16);_293=((msw&65535)<<16)|(a&65535);a=(x.highOrder&65535)+(y.highOrder&65535)+(msw>>>16);msw=(x.highOrder>>>16)+(y.highOrder>>>16)+(a>>>16);_294=((msw&65535)<<16)|(a&65535);return new _26c(_294,_293);},_295=function(a,b,c,d){var e,msw,_296,_297;e=(a.lowOrder&65535)+(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535);msw=(a.lowOrder>>>16)+(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e>>>16);_296=((msw&65535)<<16)|(e&65535);e=(a.highOrder&65535)+(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(msw>>>16);msw=(a.highOrder>>>16)+(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e>>>16);_297=((msw&65535)<<16)|(e&65535);return new _26c(_297,_296);},_298=function(a,b,c,d,e){var f,msw,_299,_29a;f=(a.lowOrder&65535)+(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535)+(e.lowOrder&65535);msw=(a.lowOrder>>>16)+(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e.lowOrder>>>16)+(f>>>16);_299=((msw&65535)<<16)|(f&65535);f=(a.highOrder&65535)+(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(e.highOrder&65535)+(msw>>>16);msw=(a.highOrder>>>16)+(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e.highOrder>>>16)+(f>>>16);_29a=((msw&65535)<<16)|(f&65535);return new _26c(_29a,_299);},_29b=function(f,g){var W=[],a,b,c,d,e,T,ch=_27d,_29c=_27c,maj=_27f,rotl=_277,_29d=_28f,i,t,_29e=_291,_29f,H=[1732584193,4023233417,2562383102,271733878,3285377520],K=[1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782];f[g>>5]|=128<<(24-(g%32));f[(((g+65)>>9)<<4)+15]=g;_29f=f.length;for(i=0;i<_29f;i+=16){a=H[0];b=H[1];c=H[2];d=H[3];e=H[4];for(t=0;t<80;t+=1){if(t<16){W[t]=f[t+i];}else{W[t]=rotl(W[t-3]^W[t-8]^W[t-14]^W[t-16],1);}if(t<20){T=_29e(rotl(a,5),ch(b,c,d),e,K[t],W[t]);}else{if(t<40){T=_29e(rotl(a,5),_29c(b,c,d),e,K[t],W[t]);}else{if(t<60){T=_29e(rotl(a,5),maj(b,c,d),e,K[t],W[t]);}else{T=_29e(rotl(a,5),_29c(b,c,d),e,K[t],W[t]);}}}e=d;d=c;c=rotl(b,30);b=a;a=T;}H[0]=_29d(a,H[0]);H[1]=_29d(b,H[1]);H[2]=_29d(c,H[2]);H[3]=_29d(d,H[3]);H[4]=_29d(e,H[4]);}return H;},_2a0=function(j,k,l){var a,b,c,d,e,f,g,h,T1,T2,H,_2a1,_2a2,i,t,_2a3,_2a4,_2a5,_2a6,_2a7,_2a8,_2a9,_2aa,_2ab,ch,maj,Int,K,W=[],_2ac;if(l==="SHA-224"||l==="SHA-256"){_2a1=64;_2a2=(((k+65)>>9)<<4)+15;_2a3=16;_2a4=1;Int=Number;_2a5=_28f;_2a6=_290;_2a7=_291;_2a8=_289;_2a9=_28c;_2aa=_281;_2ab=_285;maj=_27f;ch=_27d;K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];if(l==="SHA-224"){H=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];}else{H=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];}}else{if(l==="SHA-384"||l==="SHA-512"){_2a1=80;_2a2=(((k+128)>>10)<<5)+31;_2a3=32;_2a4=2;Int=_26c;_2a5=_292;_2a6=_295;_2a7=_298;_2a8=_28a;_2a9=_28d;_2aa=_282;_2ab=_286;maj=_280;ch=_27e;K=[new Int(1116352408,3609767458),new Int(1899447441,602891725),new Int(3049323471,3964484399),new Int(3921009573,2173295548),new Int(961987163,4081628472),new Int(1508970993,3053834265),new Int(2453635748,2937671579),new Int(2870763221,3664609560),new Int(3624381080,2734883394),new Int(310598401,1164996542),new Int(607225278,1323610764),new Int(1426881987,3590304994),new Int(1925078388,4068182383),new Int(2162078206,991336113),new Int(2614888103,633803317),new Int(3248222580,3479774868),new Int(3835390401,2666613458),new Int(4022224774,944711139),new Int(264347078,2341262773),new Int(604807628,2007800933),new Int(770255983,1495990901),new Int(1249150122,1856431235),new Int(1555081692,3175218132),new Int(1996064986,2198950837),new Int(2554220882,3999719339),new Int(2821834349,766784016),new Int(2952996808,2566594879),new Int(3210313671,3203337956),new Int(3336571891,1034457026),new Int(3584528711,2466948901),new Int(113926993,3758326383),new Int(338241895,168717936),new Int(666307205,1188179964),new Int(773529912,1546045734),new Int(1294757372,1522805485),new Int(1396182291,2643833823),new Int(1695183700,2343527390),new Int(1986661051,1014477480),new Int(2177026350,1206759142),new Int(2456956037,344077627),new Int(2730485921,1290863460),new Int(2820302411,3158454273),new Int(3259730800,3505952657),new Int(3345764771,106217008),new Int(3516065817,3606008344),new Int(3600352804,1432725776),new Int(4094571909,1467031594),new Int(275423344,851169720),new Int(430227734,3100823752),new Int(506948616,1363258195),new Int(659060556,3750685593),new Int(883997877,3785050280),new Int(958139571,3318307427),new Int(1322822218,3812723403),new Int(1537002063,2003034995),new Int(1747873779,3602036899),new Int(1955562222,1575990012),new Int(2024104815,1125592928),new Int(2227730452,2716904306),new Int(2361852424,442776044),new Int(2428436474,593698344),new Int(2756734187,3733110249),new Int(3204031479,2999351573),new Int(3329325298,3815920427),new Int(3391569614,3928383900),new Int(3515267271,566280711),new Int(3940187606,3454069534),new Int(4118630271,4000239992),new Int(116418474,1914138554),new Int(174292421,2731055270),new Int(289380356,3203993006),new Int(460393269,320620315),new Int(685471733,587496836),new Int(852142971,1086792851),new Int(1017036298,365543100),new Int(1126000580,2618297676),new Int(1288033470,3409855158),new Int(1501505948,4234509866),new Int(1607167915,987167468),new Int(1816402316,1246189591)];if(l==="SHA-384"){H=[new Int(3418070365,3238371032),new Int(1654270250,914150663),new Int(2438529370,812702999),new Int(355462360,4144912697),new Int(1731405415,4290775857),new Int(41048885895,1750603025),new Int(3675008525,1694076839),new Int(1203062813,3204075428)];}else{H=[new Int(1779033703,4089235720),new Int(3144134277,2227873595),new Int(1013904242,4271175723),new Int(2773480762,1595750129),new Int(1359893119,2917565137),new Int(2600822924,725511199),new Int(528734635,4215389547),new Int(1541459225,327033209)];}}}j[k>>5]|=128<<(24-k%32);j[_2a2]=k;_2ac=j.length;for(i=0;i<_2ac;i+=_2a3){a=H[0];b=H[1];c=H[2];d=H[3];e=H[4];f=H[5];g=H[6];h=H[7];for(t=0;t<_2a1;t+=1){if(t<16){W[t]=new Int(j[t*_2a4+i],j[t*_2a4+i+1]);}else{W[t]=_2a6(_2a9(W[t-2]),W[t-7],_2a8(W[t-15]),W[t-16]);}T1=_2a7(h,_2ab(e),ch(e,f,g),K[t],W[t]);T2=_2a5(_2aa(a),maj(a,b,c));h=g;g=f;f=e;e=_2a5(d,T1);d=c;c=b;b=a;a=_2a5(T1,T2);}H[0]=_2a5(a,H[0]);H[1]=_2a5(b,H[1]);H[2]=_2a5(c,H[2]);H[3]=_2a5(d,H[3]);H[4]=_2a5(e,H[4]);H[5]=_2a5(f,H[5]);H[6]=_2a5(g,H[6]);H[7]=_2a5(h,H[7]);}switch(l){case "SHA-224":return [H[0],H[1],H[2],H[3],H[4],H[5],H[6]];case "SHA-256":return H;case "SHA-384":return [H[0].highOrder,H[0].lowOrder,H[1].highOrder,H[1].lowOrder,H[2].highOrder,H[2].lowOrder,H[3].highOrder,H[3].lowOrder,H[4].highOrder,H[4].lowOrder,H[5].highOrder,H[5].lowOrder];case "SHA-512":return [H[0].highOrder,H[0].lowOrder,H[1].highOrder,H[1].lowOrder,H[2].highOrder,H[2].lowOrder,H[3].highOrder,H[3].lowOrder,H[4].highOrder,H[4].lowOrder,H[5].highOrder,H[5].lowOrder,H[6].highOrder,H[6].lowOrder,H[7].highOrder,H[7].lowOrder];default:return [];}},_2ad=function(a,b){this.sha1=null;this.sha224=null;this.sha256=null;this.sha384=null;this.sha512=null;this.strBinLen=null;this.strToHash=null;if("HEX"===b){if(0!==(a.length%2)){return "TEXT MUST BE IN BYTE INCREMENTS";}this.strBinLen=a.length*4;this.strToHash=_26f(a);}else{if(("ASCII"===b)||("undefined"===typeof (b))){this.strBinLen=a.length*_269;this.strToHash=_26d(a);}else{return "UNKNOWN TEXT INPUT TYPE";}}};_2ad.prototype={getHash:function(a,b){var c=null,_2ae=this.strToHash.slice();switch(b){case "HEX":c=_271;break;case "B64":c=_274;break;default:return "FORMAT NOT RECOGNIZED";}switch(a){case "SHA-1":if(null===this.sha1){this.sha1=_29b(_2ae,this.strBinLen);}return c(this.sha1);case "SHA-224":if(null===this.sha224){this.sha224=_2a0(_2ae,this.strBinLen,a);}return c(this.sha224);case "SHA-256":if(null===this.sha256){this.sha256=_2a0(_2ae,this.strBinLen,a);}return c(this.sha256);case "SHA-384":if(null===this.sha384){this.sha384=_2a0(_2ae,this.strBinLen,a);}return c(this.sha384);case "SHA-512":if(null===this.sha512){this.sha512=_2a0(_2ae,this.strBinLen,a);}return c(this.sha512);default:return "HASH NOT RECOGNIZED";}},getHMAC:function(a,b,c,d){var e,_2af,_2b0,_2b1,i,_2b2,_2b3,_2b4,_2b5,_2b6=[],_2b7=[];switch(d){case "HEX":e=_271;break;case "B64":e=_274;break;default:return "FORMAT NOT RECOGNIZED";}switch(c){case "SHA-1":_2b0=64;_2b5=160;break;case "SHA-224":_2b0=64;_2b5=224;break;case "SHA-256":_2b0=64;_2b5=256;break;case "SHA-384":_2b0=128;_2b5=384;break;case "SHA-512":_2b0=128;_2b5=512;break;default:return "HASH NOT RECOGNIZED";}if("HEX"===b){if(0!==(a.length%2)){return "KEY MUST BE IN BYTE INCREMENTS";}_2af=_26f(a);_2b4=a.length*4;}else{if("ASCII"===b){_2af=_26d(a);_2b4=a.length*_269;}else{return "UNKNOWN KEY INPUT TYPE";}}_2b1=_2b0*8;_2b3=(_2b0/4)-1;if(_2b0<(_2b4/8)){if("SHA-1"===c){_2af=_29b(_2af,_2b4);}else{_2af=_2a0(_2af,_2b4,c);}_2af[_2b3]&=4294967040;}else{if(_2b0>(_2b4/8)){_2af[_2b3]&=4294967040;}}for(i=0;i<=_2b3;i+=1){_2b6[i]=_2af[i]^909522486;_2b7[i]=_2af[i]^1549556828;}if("SHA-1"===c){_2b2=_29b(_2b6.concat(this.strToHash),_2b1+this.strBinLen);_2b2=_29b(_2b7.concat(_2b2),_2b1+_2b5);}else{_2b2=_2a0(_2b6.concat(this.strToHash),_2b1+this.strBinLen,c);_2b2=_2a0(_2b7.concat(_2b2),_2b1+_2b5,c);}return (e(_2b2));}};window.jsSHA=_2ad;}());}if(!dojo._hasResource["toura.app.user.Twitter"]){dojo._hasResource["toura.app.user.Twitter"]=true;dojo.provide("toura.app.user.Twitter");(function(){var user;dojo.declare("toura.app.user.Twitter",[],{constructor:function(){var _2b8={customerKey:toura.app.Config.get("app").twitterCustomerKey,customerSecret:toura.app.Config.get("app").twitterCustomerSecret};if(_2b8.customerKey&&_2b8.customerSecret){this.twitterConfig=_2b8;if(toura.app.Phonegap.present){this.childBrowser=toura.app.Phonegap.browser.getBrowser();}}else{this.disabled=true;}},setUserInfo:function(u){console.log("toura.app.user.Twitter::setUserInfo()");if(u.username&&u.password){user=u;return true;}return false;},isAuthenticated:function(){console.log("toura.app.user.Twitter::isAuthenticated()");if(toura.app.Phonegap.present){return !!(this.oauth_token&&this.oauth_token_secret);}return false;},postMessage:function(msg){console.log("toura.app.user.Twitter::postMessage()");if(!msg){return;}if(toura.silenceSharing){console.log("sharing silenced; twitter message would have been",msg);}var dfd=new dojo.Deferred();dojo.when(this._getAuth(),dojo.hitch(this,function(t){this._postMessage(msg,t).then(dfd.resolve,dfd.reject);}));return dfd.promise;},_postMessage:function(msg,t){console.log("toura.app.user.Twitter::_postMessage()");var _2b9=new toura.app.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret}),auth=this._getAuthTokenFields(),dfd=new dojo.Deferred();_2b9.setAuth(auth);if(!_2b9.setupUpdate(msg)){dfd.reject();}else{dojo.xhrPost({url:_2b9.getPostTarget(),headers:_2b9.getAuthHeader(),load:dfd.resolve});}return dfd.promise;},_getAuthTokenFields:function(){console.log("toura.app.user.Twitter::_getAuthTokenFields()");return {oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret};},_getAuth:function(){console.log("toura.app.user.Twitter::_getAuth()");var dfd=new dojo.Deferred(),_2ba;if(!toura.app.Phonegap.present){dfd.resolve(true);return dfd.promise;}if(this.isAuthenticated()){return this._getAuthTokenFields();}if(!user){console.error("user not found");return;}_2ba=new toura.app.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret});_2ba.setupAuthPost(user.username,user.password);dojo.xhrPost({url:_2ba.getPostTarget(),headers:_2ba.getAuthHeader()}).then(dojo.hitch(this,function(_2bb){var _2bc=dojo.queryToObject(_2bb);dojo.mixin(this,_2bc);dfd.resolve({oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret});}),dfd.reject);return dfd.promise;}});}());dojo.declare("toura.app.user._TwitterAPI",null,{sigBaseTemplate:"POST&"+"{{ path }}&"+"oauth_consumer_key%3D"+"{{ customer_key }}"+"%26"+"oauth_nonce%3D"+"{{ nonce }}"+"%26"+"oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D"+"{{ time }}"+"%26"+"{{ optional_token }}"+"oauth_version%3D1.0%26"+"{{ post_body }}",authTemplate:"OAuth "+"oauth_nonce=\""+"{{ nonce }}"+"\", "+"oauth_signature_method=\"HMAC-SHA1\", "+"oauth_timestamp=\""+"{{ time }}"+"\", "+"oauth_consumer_key=\""+"{{ customer_key }}"+"\", "+"{{ optional_token }}"+"oauth_signature=\""+"{{ signature }}"+"\", "+"oauth_version=\"1.0\"",constructor:function(_2bd){this.config=_2bd;this.consumerSecret=this.config.consumerSecret+"&";this.nonce=this._createNonce();this.timestamp=(new Date((new Date()).toUTCString())).getTime()/1000;},_encode:function(str){return encodeURIComponent(str).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A");},_createNonce:function(){var _2be=[],_2bf=5;while(_2bf--){_2be.push((((1+Math.random())*65536)).toString(16).substring(1));}return _2be.join("");},getPostTarget:function(){return [this.path,this.postBody].join("?");},setSignature:function(_2c0){var _2c1=new jsSHA(this.signatureBaseString,"ASCII");this.signature=_2c1.getHMAC(_2c0,"ASCII","SHA-1","B64")+"%3D";},setupBaseString:function(_2c2){var _2c3=_2c2?"oauth_token%3D"+_2c2+"%26":"";this.signatureBaseString=this.sigBaseTemplate.split("{{ path }}").join(encodeURIComponent(this.path)).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(_2c3).split("{{ nonce }}").join(this.nonce).split("{{ time }}").join(this.timestamp).split("{{ post_body }}").join(encodeURIComponent(this.postBody));},setupAuthHeader:function(_2c4){var _2c5=_2c4?"oauth_token=\""+_2c4+"\", ":"";this.authHeader=this.authTemplate.split("{{ nonce }}").join(this.nonce).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(_2c5).split("{{ time }}").join(this.timestamp).split("{{ signature }}").join(this.signature);},getAuthHeader:function(){return {"Authorization":this.authHeader};},setupAuthPost:function(user,pw){this.path="https://api.twitter.com/oauth/access_token";this.postBody="x_auth_mode=client_auth&"+"x_auth_password="+this._encode(pw)+"&"+"x_auth_username="+this._encode(user);this.setupBaseString();this.setSignature(this.consumerSecret);this.setupAuthHeader();return true;},setupUpdate:function(_2c6){this.path="http://api.twitter.com/1/statuses/update.json";this.postBody="status="+this._encode(_2c6);if(!this.token||!this.tokenSecret){return false;}this.setupBaseString(this.token);this.setSignature(this.consumerSecret+this.tokenSecret);this.setupAuthHeader(this.token);return true;},setAuth:function(auth){this.token=auth.oauth_token;this.tokenSecret=auth.oauth_token_secret;}});(function(){if(window.device&&window.device.phonegap){return;}if(!toura.features.socialInBrowser){return;}var key=toura.app.Config.get("app").twitter_anywhere_key;if(!key){return;}var s=document.createElement("script");var _2c7="//platform.twitter.com/anywhere.js?"+dojo.objectToQuery({id:key,v:1});s.src=document.location.protocol+_2c7;s.async=true;document.body.appendChild(s);}());}if(!dojo._hasResource["toura.app.Sharing"]){dojo._hasResource["toura.app.Sharing"]=true;dojo.provide("toura.app.Sharing");toura.app.Sharing={lastPost:{},getMessage:function(svc,obj){console.log("toura.app.Sharing::getMessage",arguments);var app=toura.app.Config.get("app"),_2c8=app.sharingText||toura.sharingText||"${sharingURL}",_2c9=0,ret;obj=obj||{"name":app.name};console.log("app sharing URL is "+app.sharingUrl);obj.sharingURL=obj.sharingURL||app.sharingUrl||toura.sharingURL;if(!obj.sharingURL){console.error("No sharing URL defined for object or app. This will end badly.");}if(!_2c8){console.error("No sharing text template defined. This will end badly.");}if(svc==="twitter"){_2c9+=obj.sharingURL.length;ret=dojo.string.substitute(_2c8,obj).split(obj.sharingURL);if(ret[1]){_2c9+=ret[1].length;}ret=[dojo.trim(ret[0].substr(0,140-_2c9)),obj.sharingURL,ret[1]||""].join(" ");}else{ret=dojo.string.substitute(_2c8,obj)+" "+obj.sharingURL;}return ret;},share:function(_2ca,_2cb,node){console.log("toura.app.Sharing::share()");var dfd=new dojo.Deferred(),svc=_2ca.name,doit=true,_2cc=_2ca.beforePost?!!_2ca.beforePost(_2cb):true;if(_2cc!==true){console.log("beforePost was not true");dfd.reject(_2ca.beforePostError);doit=false;}if(this.lastPost[svc]&&(this.lastPost[svc]===_2cb.msg)){console.log("the message is a duplicate");dfd.reject("The message is a duplicate.");doit=false;}if(doit){console.log("doing it");this.lastPost[svc]=_2cb.msg;_2ca.api.postMessage(_2cb.msg).then(dojo.hitch(this,function(){dojo.publish("/share",[[svc,node.id,_2cb.msg].join(": ")]);dfd.resolve();}));}return dfd.promise;},getServices:function(){var i18n=dojo.i18n.getLocalization("toura","toura",toura.app.Config.get("locale")),_2cd=[];if(!toura.app.user.Twitter.disabled){_2cd.push({name:"twitter",api:toura.app.user.Twitter,requireAuth:!toura.app.user.Twitter.isAuthenticated(),maxLength:140,beforePost:function(_2ce){return !!toura.app.user.Twitter.setUserInfo(_2ce);},beforePostError:i18n.TWITTER_AUTHENTICATION_ERROR});}if(!toura.app.user.Facebook.disabled){_2cd.push({name:"facebook",api:toura.app.user.Facebook});}return _2cd;}};dojo.subscribe("/app/ready",function(){toura.app.user.Facebook=new toura.app.user.Facebook.base();toura.app.user.Twitter=new toura.app.user.Twitter();});}if(!dojo._hasResource["toura.components.buttons._Button"]){dojo._hasResource["toura.components.buttons._Button"]=true;dojo.provide("toura.components.buttons._Button");dojo.declare("toura.components.buttons._Button",[toura.components._Component],{templateString:dojo.cache("toura.components.buttons","_Button/_Button.haml","%a.button{ title: i18n_text }\n"),url:"#",i18n_text:"",preventWhenAnimating:false,setupConnections:function(){this._setupTouch(this.domNode,"_handleClick");},_handleClick:function(e){if(e){e.preventDefault();}if(this.preventWhenAnimating&&toura.animating){return;}this.onClick(e);},onClick:function(e){if(this.url&&this.url!=="#"){toura.app.Router.go(this.url);}}});}if(!dojo._hasResource["toura.components.buttons.HomeButton"]){dojo._hasResource["toura.components.buttons.HomeButton"]=true;dojo.provide("toura.components.buttons.HomeButton");dojo.declare("toura.components.buttons.HomeButton",[toura.components.buttons._Button],{preventWhenAnimating:true,onClick:function(e){e.preventDefault();toura.app.Router.home();}});}if(!dojo._hasResource["toura.components.buttons.SearchButton"]){dojo._hasResource["toura.components.buttons.SearchButton"]=true;dojo.provide("toura.components.buttons.SearchButton");dojo.declare("toura.components.buttons.SearchButton",[toura.components.buttons._Button],{"class":"search",url:toura.app.URL.search(),preventWhenAnimating:true});}if(!dojo._hasResource["toura.components.buttons.FontSize"]){dojo._hasResource["toura.components.buttons.FontSize"]=true;dojo.provide("toura.components.buttons.FontSize");dojo.declare("toura.components.buttons.FontSize",[toura.components.buttons._Button],{sizes:["small","medium","large"],"class":"font-size",defaultSize:"medium",sizePrefix:"font-size-",onClick:function(e){e.preventDefault();var b=dojo.body(),_2cf=toura.app.UI.fontSize||(this.sizePrefix+this.defaultSize),_2d0=dojo.indexOf(this.sizes,_2cf.replace(this.sizePrefix,"")),_2d1=this.sizePrefix+(this.sizes[_2d0+1]||this.sizes[0]);toura.app.UI.set("fontSize",_2d1);},initializeStrings:function(){this.i18n_font=this.getString("FONT");}});}if(!dojo._hasResource["toura.components.SocialMessage"]){dojo._hasResource["toura.components.SocialMessage"]=true;dojo.provide("toura.components.SocialMessage");dojo.declare("toura.components.SocialMessage",[toura.components._Component],{templateString:dojo.cache("toura.components","SocialMessage/SocialMessage.haml","%form.component.social-message\n  :if requireAuth\n    %fieldset.auth\n      %input{ type : 'text', name : 'username', placeholder : 'username', dojoAttachPoint : 'username', autocapitalize : 'off', autocorrect : 'off' }\n      %input{ type : 'password', name : 'password', placeholder : 'password', dojoAttachPoint : 'password' }\n\n\n  %textarea{ dojoAttachPoint : 'message', name : 'msg', autocorrect : 'off' }= messageText\n\n  :if maxLength\n    .count{ dojoAttachPoint : 'count' }= availLength\n\n  %fieldset.buttons\n    %input.highlight{ type : 'submit', dojoAttachPoint : 'submitBtn', value : i18n_submitLabel }\n    %input{ type : 'reset', dojoAttachPoint : 'cancelBtn', value : i18n_cancelLabel }\n"),requireAuth:false,maxLength:false,errorClass:"error",warningClass:"warning",prepareData:function(){this.messageText=this.messageText||"";this.availLength=this.maxLength-this.messageText.length;},setupConnections:function(){this.connect(this.submitBtn,"click","_onSubmit");this.connect(this.cancelBtn,"click","_onCancel");dojo.forEach(["keyup","change"],dojo.hitch(this,function(e){this.connect(this.message,e,"_resize");}));if(this.maxLength){this.connect(this.message,"keyup","_updateCharCount");}},_updateCharCount:function(e){var len=this.message.value.length,warn=this.maxLength-len<11,_2d2=this.maxLength-len<=0;this.count.innerHTML=this.maxLength-len;dojo[_2d2?"addClass":"removeClass"](this.count,this.errorClass);dojo[warn&&!_2d2?"addClass":"removeClass"](this.count,this.warningClass);},_onSubmit:function(e){e.preventDefault();var _2d3={msg:this.message.value,username:this.username&&this.username.value,password:this.password&&this.password.value},_2d4;_2d3.msg=dojo.trim(_2d3.msg);_2d4=this._validate(_2d3);if(!_2d4.length){this.onSubmit(_2d3);return;}this._handleErrors(_2d4);},_validate:function(_2d5){var _2d6=[];if(this.requireAuth){if(!_2d5.username){_2d6.push(this.i18n_usernameRequired);}if(!_2d5.password){_2d6.push(this.i18n_passwordRequired);}if(_2d6.length){_2d6.push(this.i18n_privacy);}}if(!_2d5.msg){_2d6.push(this.i18n_messageRequired);}if(this.maxLength&&_2d5.msg.length>this.maxLength){_2d6.push(this.i18n_messageLength);}return _2d6;},_resize:function(){var msg=this.message;msg.style.height="auto";msg.style.height=msg.scrollHeight+"px";},_handleErrors:function(_2d7){alert(_2d7.join("\n"));},onSubmit:function(_2d8){console.log(_2d8);},_onCancel:function(){this.onCancel();},onCancel:function(){console.log("toura.components.SocialMessage::onCancel()");},initializeStrings:function(){this.i18n_submitLabel=this.getString("SEND");this.i18n_cancelLabel=this.getString("CANCEL");this.i18n_usernameRequired=this.getString("SOCIAL_USERNAME_REQUIRED");this.i18n_passwordRequired=this.getString("SOCIAL_PASSWORD_REQUIRED");this.i18n_privacy=this.getString("SOCIAL_PRIVACY");this.i18n_messageRequired=this.getString("SOCIAL_MESSAGE_REQUIRED");this.i18n_messageLength=this.getString("SOCIAL_MESSAGE_LENGTH");}});}if(!dojo._hasResource["toura.components.MoreDrawer"]){dojo._hasResource["toura.components.MoreDrawer"]=true;dojo.provide("toura.components.MoreDrawer");dojo.declare("toura.components.MoreDrawer",[toura.components._Component],{templateString:dojo.cache("toura.components","MoreDrawer/MoreDrawer.haml",".component.more-drawer\n  :if phone\n    %section\n      %menu\n        =helpers.homeButton\n        =helpers.fontSizeButton\n        =helpers.searchButton\n\n    %section\n      %menu\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  :if tablet\n    %section\n      %menu\n        =helpers.fontSizeButton\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  %section{ dojoAttachPoint : 'shareSection' }\n"),helpers:{sharingButtons:dojo.cache("toura.components","MoreDrawer/_SharingButtons.haml","%li.facebook\n  %a{ dojoAttachPoint : 'facebook' }\n\n%li.twitter\n  %a{ dojoAttachPoint : 'twitter' }\n\n%li.email\n  %a{ dojoAttachPoint : 'email', href : '#' }\n"),favoriteButton:dojo.cache("toura.components","MoreDrawer/_FavoriteButton.haml","%li.favorite\n  %input{ type : 'checkbox', dojoAttachPoint : 'favorite' }\n"),homeButton:dojo.cache("toura.components","MoreDrawer/_HomeButton.haml","%li.home\n  %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n"),fontSizeButton:dojo.cache("toura.components","MoreDrawer/_FontSizeButton.haml","%li.font-size\n  %a{ dojoType : 'toura.components.buttons.FontSize' }\n"),searchButton:dojo.cache("toura.components","MoreDrawer/_SearchButton.haml","%li.search\n  %a{ dojoType : 'toura.components.buttons.SearchButton', dojoAttachPoint : 'searchButton' }\n")},widgetsInTemplate:true,isHidden:true,prepareData:function(){this.sharingDisabled=!toura.features.sharing;this.favoritesDisabled=!toura.features.favorites;this.fontSizeDisabled=!toura.features.fontSize;if(!this.sharingDisabled){this.socialMediaServices=toura.app.Sharing.getServices();if(!this.socialMediaServices.length){this.sharingDisabled=true;}}this.helpers.sharingButtons=this.sharingDisabled?"":this.helpers.sharingButtons;this.helpers.favoriteButton=this.favoritesDisabled?"":this.helpers.favoriteButton;this.helpers.fontSizeButton=this.fontSizeDisabled?"":this.helpers.fontSizeButton;this.inherited(arguments);},setupConnections:function(){var _2d9=toura.app.UI.hasTouch,evt=_2d9?"touchstart":"click",_2da=function(e){e.preventDefault();};if(!this.sharingDisabled){dojo.forEach(this.socialMediaServices,function(_2db){var _2dc=this[_2db.name];if(!_2dc){return;}this.connect(_2dc,evt,dojo.hitch(this,"_handleSocialMessageClick",_2db));if(_2d9){this.connect(_2dc,"click",_2da);}},this);this._createMailLink();this.hide(this.shareSection);}if(!this.favoritesDisabled){this.connect(this.favorite,evt,"_handleFavorite");if(_2d9){this.connect(this.favorite,"click",_2da);}}},adjustMarkup:function(){if(this.sharingDisabled){return;}dojo.forEach(["facebook","twitter"],function(_2dd){var _2de=dojo.filter(this.socialMediaServices,function(svc){return svc.name===_2dd;});if(!_2de.length){dojo.destroy(this.query("."+_2dd)[0]);}},this);},_createMailLink:function(){if(!this.email){return;}dojo.attr(this.email,"href","mailto:?"+dojo.objectToQuery({subject:toura.app.Config.get("app").name,body:toura.app.Sharing.getMessage("email",this.node)}));this.connect(this.email,"click",function(){dojo.publish("/share",[["email",this.node.id].join(": ")]);});},_handleSocialMessageClick:function(_2df){console.log("toura.components.MoreDrawer::_handleSocialMessageClick()");toura.app.Phonegap.network.isReachable().then(dojo.hitch(this,function(_2e0){if(!_2e0){alert(this.i18n_noNetwork);return;}if(this.socialMessage){var same=this.socialMessage.name===_2df.name;this.orphan(this.socialMessage,true);delete this.socialMessage;if(same){dojo.removeClass(this[_2df.name],"active");return;}}dojo.addClass(this[_2df.name],"active");var _2e1=dojo.mixin({messageText:toura.app.Sharing.getMessage(_2df.name,this.node)},_2df),_2e2=this.socialMessage=this.adopt(toura.components.SocialMessage,_2e1);_2e2.placeAt(this.shareSection);this.show(this.shareSection);this.connect(_2e2,"onSubmit",function(_2e3){toura.app.Sharing.share(_2df,_2e3,this.node).then(dojo.hitch(this,function(){this.hide(this.shareSection);}),function(msg){if(msg){alert(msg);}});});this.connect(_2e2,"onCancel",function(){this.hide(this.shareSection);this.orphan(_2e2,true);delete this.socialMessage;});}),function(){alert(this.i18n_noNetwork);});},_handleFavorite:function(e){console.log("toura.components.MoreDrawer::_handleFavorite");if(!this.node){return;}var n=this.node,_2e4=toura.app.user.Favorites.isFavorite(n),_2e5="/favorite/"+(_2e4?"remove":"add");dojo.publish(_2e5,[n]);this.favorite.checked=!_2e4;},_setNodeAttr:function(node){this.node=node;if(this.favorite){this.favorite.checked=toura.app.user.Favorites.isFavorite(node);}},toggle:function(){if(!this.isHidden){dojo.publish("/MoreDrawer/hide");this.hide(this.shareSection);}else{dojo.publish("/MoreDrawer/show");}this.inherited(arguments);},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK");}});}if(!dojo._hasResource["toura.components.buttons.MoreDrawerButton"]){dojo._hasResource["toura.components.buttons.MoreDrawerButton"]=true;dojo.provide("toura.components.buttons.MoreDrawerButton");dojo.declare("toura.components.buttons.MoreDrawerButton",[toura.components.buttons._Button],{initializeStrings:function(){this.i18n_text=this.getString("MORE");}});}if(!dojo._hasResource["toura.components.buttons.BackButton"]){dojo._hasResource["toura.components.buttons.BackButton"]=true;dojo.provide("toura.components.buttons.BackButton");dojo.declare("toura.components.buttons.BackButton",[toura.components.buttons._Button],{preventWhenAnimating:true,onClick:function(e){e.preventDefault();if(toura.features.disableBackButton){return;}toura.app.Router.back();},initializeStrings:function(){this.i18n_text=this.getString("BACK");}});}if(!dojo._hasResource["toura.components.PageNav"]){dojo._hasResource["toura.components.PageNav"]=true;dojo.provide("toura.components.PageNav");dojo.declare("toura.components.PageNav",[toura.components._Component],{templateString:dojo.cache("toura.components","PageNav/PageNav.haml","%nav.component.page-nav\n  .top\n    :if tablet\n      %ul\n        %li.back\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n        %li.home\n          %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      %ul\n        :if shareable\n          %li.more\n            %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n        %li.search\n          %a{ href : searchUrl }\n\n    :if phone\n      .back\n        %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      :if shareable\n        .more\n          %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n      :if !shareable\n        .home\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n  :if shareable\n    %div{ dojoType : 'toura.components.MoreDrawer', dojoAttachPoint : 'moreDrawer' }\n"),widgetsInTemplate:true,shareable:true,prepareData:function(){this.searchUrl=toura.app.URL.search();this.homeUrl=toura.app.URL.home();this.title=this.node?this.node.name:this.title;this.shareable=this.node&&this.node.shareable;},setupConnections:function(){if(this.moreDrawerButton){this.connect(this.moreDrawerButton,"onClick","_showMoreDrawer");}},setupSubscriptions:function(){this.subscribe("/button/menu","_showMoreDrawer");},setupChildComponents:function(){if(this.shareable){this.moreDrawer.set("node",this.node);}},initializeStrings:function(){this.i18n_more=this.getString("MORE");},_showMoreDrawer:function(e){if(e){e.preventDefault();}this.moreDrawer.toggle();},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}});}if(!dojo._hasResource["toura.pageControllers.Debug"]){dojo._hasResource["toura.pageControllers.Debug"]=true;dojo.provide("toura.pageControllers.Debug");dojo.declare("toura.pageControllers.Debug",[toura.pageControllers._Page],{templateString:dojo.cache("toura.pageControllers","Debug/Debug.haml",".page.debug\n  .header{ dojoAttachPoint : 'pageNav' }\n\n  .body\n    %div{ dojoType : 'toura.ui.Scrollable' }\n      %div\n        %table{ dojoAttachPoint : 'deviceInfo' }\n\n        %ul.actions\n          %li{ dojoAttachEvent : 'click:_weinre' } weinre\n          %li{ dojoAttachEvent : 'click:_resetDB' } reset\n\n        %div{ dojoAttachPoint : 'status' }\n\n"),postMixInProperties:function(){var html=[],tpl=function(k,v){return "<tr><th>{k}</th><td>{v}</td></tr>".replace("{k}",k).replace("{v}",v);},_2e6=function(t){return "<tr><th colspan=2>"+t+"</th></tr>";},k;html.push(_2e6("Device"));if(window.device){dojo.forIn(window.device,function(k,v){html.push(tpl(k,v));});}html.push(tpl("UA",window.navigator.userAgent));html.push(tpl("Device Type",this.device.type));html.push(tpl("Device OS",this.device.os));var app=toura.app.Config.get("app");html.push(_2e6("App"));html.push(tpl("Build Date",toura.app.Config.get("buildDate")));html.push(tpl("Data Version",toura.app.Tour._getLocalVersion()));dojo.forIn(app,function(k,v){html.push(tpl(k,v));});html.push(_2e6("Features"));dojo.forIn(toura.features,function(k,v){html.push(tpl(k,v?"true":"false"));});this.info=html.join("");this.inherited(arguments);},postCreate:function(){this.inherited(arguments);this.deviceInfo.innerHTML=this.info;},_weinre:function(){this.status.innerHTML="debugging at "+toura.app._Debug.weinre.init();},_resetDB:function(){toura.app.DeviceStorage.drop();window.location.reload();},setupNav:function(){this.adopt(toura.components.PageNav,{title:"Debug",shareable:false},this.pageNav);}});}if(!dojo._hasResource["toura.components.SearchInput"]){dojo._hasResource["toura.components.SearchInput"]=true;dojo.provide("toura.components.SearchInput");dojo.declare("toura.components.SearchInput",[toura.components._Component],{templateString:dojo.cache("toura.components","SearchInput/SearchInput.haml",".component.search-input\n  %a.back{ dojoType : 'toura.components.buttons.BackButton' }\n  %form.search{ dojoAttachPoint : 'searchForm' }\n    %input{ type : 'search', name : 'query', placeholder : i18n_placeholderText, autocorrect : 'off', dojoAttachPoint : 'queryInput' }\n    %input{ type : 'submit', value : 'Search', dojoAttachPoint : 'searchButton' }\n"),_oldValue:null,keybuffer:3,debounceTime:300,timeout:null,widgetsInTemplate:true,setupConnections:function(){this.connect(this.queryInput,"focus",function(){window.scrollTo(0,0);this.queryInput.value="";});this.connect(this.queryInput,"keyup","_handleInput");if(toura.app.UI.hasTouch){this.connect(this.searchButton,"touchstart","_handleSubmit");}this.connect(this.searchForm,"submit","_handleSubmit");},_setSearchTermAttr:function(term){this.queryInput.value=term||"";},_handleInput:function(){if(dojo.trim(this.queryInput.value).length<this.keybuffer){return;}clearTimeout(this.timeout);this.timeout=setTimeout(dojo.hitch(this,function(){this._search(this.queryInput.value);}),this.debounceTime);},_handleSubmit:function(e){e.preventDefault();e.stopPropagation();var q=this.queryInput.value;if(/^toura:./.test(q)){console.log("found toura:");dojo.publish("/debug/user",[q]);return;}this._search(q);},_search:function(q){q=dojo.trim(q);if(!q){return;}if(q===this._oldValue){return;}this.search(q);},search:function(q){},initializeStrings:function(){this.i18n_placeholderText=this.getString("SEARCH_PLACEHOLDER_TEXT");}});}if(!dojo._hasResource["toura.components._Results"]){dojo._hasResource["toura.components._Results"]=true;dojo.provide("toura.components._Results");dojo.declare("toura.components._Results",[toura.components._Component,toura.ui.Scrollable],{postCreate:function(){this.inherited(arguments);this.refreshScroller();},_truncate:function(text){return toura.util.truncate(text,200);}});}if(!dojo._hasResource["toura.components.SearchResults"]){dojo._hasResource["toura.components.SearchResults"]=true;dojo.provide("toura.components.SearchResults");dojo.declare("toura.components.SearchResults",[toura.components._Results],{templateString:dojo.cache("toura.components","SearchResults/SearchResults.haml",".component.search-results\n  %ul{ dojoAttachPoint : 'resultsContainer' }\n"),resultTemplate:Haml(dojo.cache("toura.components","SearchResults/Result.haml","%li{ class : type }\n  %a.text{ href : url }\n    %h2= nodeTitle\n    %p= displayText\n")),handleClicks:true,resultsToShow:25,postCreate:function(){this.clickableNode=this.resultsContainer;this.inherited(arguments);},_setResultsAttr:function(_2e7){if(_2e7&&!dojo.isArray(_2e7)){throw new Error("toura.components.SearchResults::_setResultsAttr: results argument must be an array");}dojo.empty(this.resultsContainer);if(!_2e7){this._handleEmptySearch();return;}if(!_2e7.length){this._handleNoResults();return;}var _2e8=_2e7.length>this.resultsToShow;this.results=_2e7=_2e7.slice(0,this.resultsToShow);this.resultsContainer.innerHTML=dojo.map(_2e7,function(r){var _2e9=dojo.mixin({},r),a=_2e9.asset;_2e9.thumbnailURL=a&&a.featured&&a.featured.url;_2e9.displayText=this._truncate(_2e9.displayText);return this.resultTemplate(_2e9);},this).join("");if(_2e8){_2e8=dojo.create("li",{innerHTML:this.i18n_moreResults,className:"more-results"});dojo.place(_2e8,this.resultsContainer,"last");}this.refreshScroller();},_handleNoResults:function(){this.resultsContainer.innerHTML="<li>"+this.i18n_noResults+"</li>";},_handleEmptySearch:function(){this.resultsContainer.innerHTML="<li>"+this.i18n_instructions+"</li>";},initializeStrings:function(){this.i18n_instructions=this.getString("SEARCH_INSTRUCTIONS");this.i18n_noResults=this.getString("SEARCH_NO_RESULTS");this.i18n_moreResults=this.getString("SEARCH_MORE_RESULTS");}});}if(!dojo._hasResource["toura.pageControllers.search.Search"]){dojo._hasResource["toura.pageControllers.search.Search"]=true;dojo.provide("toura.pageControllers.search.Search");dojo.declare("toura.pageControllers.search.Search",[toura.pageControllers._Page],{templateString:dojo.cache("toura.pageControllers.search","Search/Search.haml","%li.page.search\n  .header.input{ dojoAttachPoint : 'searchInput' }\n  .results{ dojoAttachPoint : 'searchResults' }\n"),lastSearchTerm:null,type:"search",postMixInProperties:function(){this.inherited(arguments);this.placements=[["SearchInput",{},"searchInput"],["SearchResults",{},"searchResults"]];},postCreate:function(){this.inherited(arguments);this.connect(this.searchInput,"search","_handleSearch");if(toura.lastSearchTerm){this._handleSearch(toura.lastSearchTerm);}},_handleSearch:function(term){if(term===this.lastSearchTerm){return;}this.set("searchTerm",term);this.searchResults.set("results",toura.app.Data.search(term));},_setSearchTermAttr:function(term){this.lastSearchTerm=toura.lastSearchTerm=term;this.searchInput.set("searchTerm",term);},init:function(term){if(!term){return;}this._handleSearch(term);}});}if(!dojo._hasResource["toura.components.buttons.DeleteButton"]){dojo._hasResource["toura.components.buttons.DeleteButton"]=true;dojo.provide("toura.components.buttons.DeleteButton");dojo.declare("toura.components.buttons.DeleteButton",[toura.components.buttons._Button],{templateString:dojo.cache("toura.components.buttons","DeleteButton/DeleteButton.haml","%div.button{ title: i18n_text }\n"),objId:"",deleting:false,onClick:function(e){if(this.deleting){this.onDelete(this.objId,this.domNode);return;}dojo.addClass(this.domNode,"deleting");this.deleting=true;},initializeStrings:function(){this.i18n_text=this.getString("DELETE");},onDelete:function(id,_2ea){}});}if(!dojo._hasResource["toura.components.Favorites"]){dojo._hasResource["toura.components.Favorites"]=true;dojo.provide("toura.components.Favorites");dojo.declare("toura.components.Favorites",[toura.components._Results],{templateString:dojo.cache("toura.components","Favorites/Favorites.haml",".component.favorites\n  %ul{ dojoAttachPoint : 'favoritesList' }\n    :if favorites.length\n\n      :each fav in favorites\n        %li{ class : fav.type }\n\n          %a{ href : fav.model.url }\n            :if fav.img\n              .img{ dojoType : 'toura.ui.BackgroundImage', imageUrl : fav.img, imageHeight : '50px', imageWidth : '67px', resizeMethod : 'cover', loadOnInit : true }\n\n            :if !fav.img\n              .img.default\n\n            .text\n              %h2= fav.name\n\n              :if fav.displayText\n                %p= fav.displayText\n\n          .delete{ dojoType : 'toura.components.buttons.DeleteButton', objId : fav.id, dojoAttachEvent : 'onDelete: _deleteFavorite' }\n\n    :if !favorites.length\n      %li= i18n_noFavorites\n"),handleClicks:true,widgetsInTemplate:true,prepareData:function(){this.favorites=dojo.filter(this.favorites||[],function(fav){return !fav.deleted;});this.favorites=dojo.map(this.favorites,function(fav){fav.img=fav.model.featuredImage&&fav.model.featuredImage.small.url;fav.displayText=fav.model.bodyText&&fav.model.bodyText.body?this._truncate(fav.model.bodyText.body):false;return fav;},this);},initializeStrings:function(){this.i18n_noFavorites=this.getString("FAVORITES_NO_FAVORITES");},_deleteFavorite:function(id,_2eb){dojo.publish("/favorite/remove",[id]);dojo.destroy(_2eb.parentNode);}});}if(!dojo._hasResource["toura.pageControllers.favorites.Favorites"]){dojo._hasResource["toura.pageControllers.favorites.Favorites"]=true;dojo.provide("toura.pageControllers.favorites.Favorites");dojo.declare("toura.pageControllers.favorites.Favorites",[toura.pageControllers._Page],{templateString:dojo.cache("toura.pageControllers.favorites","Favorites/Favorites.haml","%li.page.favorites\n  %div{ dojoAttachPoint : 'pageNav' }\n\n  .pane.bottom\n    %div{ dojoAttachPoint : 'favorites' }\n"),postMixInProperties:function(){this.placements=[["Favorites",{favorites:toura.app.user.Favorites.load()},"favorites","replace"]];this.inherited(arguments);},setupNav:function(){this.adopt(toura.components.PageNav,{shareable:false,title:this.i18n_favorites}).placeAt(this.pageNav,"replace");},initializeStrings:function(){this.i18n_favorites=this.getString("FAVORITES");}});}if(!dojo._hasResource["toura.pageControllers.node._Node"]){dojo._hasResource["toura.pageControllers.node._Node"]=true;dojo.provide("toura.pageControllers.node._Node");dojo.declare("toura.pageControllers.node._Node",[toura.pageControllers._Page],{templateString:"%div",shareable:true,postMixInProperties:function(){this.inherited(arguments);if(!this.node){this.node=this.baseObj;}this.node.shareable=this.shareable;},postCreate:function(){this.inherited(arguments);if(this.baseObj&&this.baseObj.id){this.addClass("page-"+this.baseObj.id);}},_getDimensions:function(){return toura.app.UI.viewport;},_getBackgroundImage:function(){if(!this.node.backgroundImage){return;}var img=this.node.backgroundImage[this.device.type];if(img){return this.device.type==="phone"?img.gallery:img.original;}return this.inherited(arguments);},setupNav:function(){this.inherited(arguments);if(!this.pageNav){return;}if(this.node.id===toura.app.Config.get("app").homeNodeId){dojo.destroy(this.pageNav);return;}this.adopt(toura.components.PageNav,{shareable:this.shareable,node:this.node}).placeAt(this.pageNav,"replace");}});}if(!dojo._hasResource["toura.pageControllers.node._ImageGalleryPage"]){dojo._hasResource["toura.pageControllers.node._ImageGalleryPage"]=true;dojo.provide("toura.pageControllers.node._ImageGalleryPage");dojo.declare("toura.pageControllers.node._ImageGalleryPage",[],{_imageGalleryPageSetup:function(_2ec){var _2ed=_2ec.caption,_2ee=_2ec.fullScreen,_2ef=_2ec.gallery,_2f0=function(_2f1){if(!_2ed){return;}_2ed.set("content",_2f1&&_2f1.caption||"");dojo.style(_2ed.domNode,"height",null);dojo.style(_2ed.domNode,"height",(_2ed.domNode.clientHeight+50)+"px");};this.connect(_2ef,"onShowDetail",function(_2f2){_2ee.set("active",true);_2ee.set("currentImageIndex",_2f2);dojo.publish("/ImageGalleryPage/detail/show");toura.app.UI.set("siblingNavVisible",false);dojo.addClass(this.mainScreen,"hidden");});this.connect(_2ee,"onHideDetail",function(_2f3){var _2f4=this.node.images[_2f3];_2ef.set("active",true);_2ef.scrollToIndex(_2f3);_2f0(_2f4);dojo.publish("/ImageGalleryPage/detail/hide");toura.app.UI.set("siblingNavVisible",true);dojo.removeClass(this.mainScreen,"hidden");});this.connect(this,"init",function(_2f5){this.connect(_2ef,"onScrollEnd",function(_2f6){var _2f7=this.node.images[_2f6];_2f0(_2f7);dojo.publish("/content/update");});if(!_2f5||!_2f5.assetId){return;}var _2f8=_2f5.assetId,_2f9;if(!_2f8){return;}var _2fa=dojo.filter(this.node.images,function(_2fb,i){if(_2fb.id===_2f8){_2f9=i;return _2fb;}})[0];if(!_2fa){return;}this.connect(_2ef,"onScrollerSetupComplete",function(){setTimeout(function(){_2ef.scrollToIndex(_2f9);_2f0(_2fa);},100);});});}});}if(!dojo._hasResource["toura.components.BodyText"]){dojo._hasResource["toura.components.BodyText"]=true;dojo.provide("toura.components.BodyText");dojo.declare("toura.components.BodyText",[toura.components._Component],{templateString:dojo.cache("toura.components","BodyText/BodyText.haml",".component.body-text\n  %div{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n"),prepareData:function(){this.bodyText=this.bodyText||this._getBodyText();},adjustMarkup:function(){if(!dojo.trim(this.bodyText)){this.addClass("empty");}},_getBodyText:function(){if(!this.node){return "";}return this.node.bodyText?this.node.bodyText.body:"";},setupConnections:function(){this.query("a[rel=\"external\"]").attr("target","_blank");this.connect(this.domNode,"click","_handleClick");},_handleClick:function(e){var t=e.target,href,rel;if(t.nodeName.toLowerCase()!=="a"){return;}rel=dojo.attr(t,"rel");if(rel&&rel==="external"){return;}href=dojo.attr(t,"href");if(/^http/.test(href)){e.preventDefault();toura.app.Phonegap.browser.url(href);return;}},_setContentAttr:function(val){this.bodyTextContainer.innerHTML=val;dojo[val?"removeClass":"addClass"](this.domNode,"empty");}});}if(!dojo._hasResource["toura.components.AudioCaption"]){dojo._hasResource["toura.components.AudioCaption"]=true;dojo.provide("toura.components.AudioCaption");dojo.declare("toura.components.AudioCaption",[toura.components.BodyText],{"class":"audio-caption",_getBodyText:function(){if(!this.node||!this.node.audios){return "";}return this.node.audios[0]?(this.node.audios[0].caption||""):"";}});}if(!dojo._hasResource["toura.components.ImageCaption"]){dojo._hasResource["toura.components.ImageCaption"]=true;dojo.provide("toura.components.ImageCaption");dojo.declare("toura.components.ImageCaption",[toura.components.BodyText],{"class":"image-caption",_getBodyText:function(){if(!this.node||!this.node.images){return "";}return this.node.images[0]?(this.node.images[0].caption||""):"";}});}if(!dojo._hasResource["toura.components._ImageGallery"]){dojo._hasResource["toura.components._ImageGallery"]=true;dojo.provide("toura.components._ImageGallery");dojo.declare("toura.components._ImageGallery",[],{widgetsInTemplate:true,postCreate:function(){this.inherited(arguments);},startup:function(){this._setWidth();this._setupClick();this.subscribe("/window/resize","_setWidth");},_setWidth:function(){this.widthItems=this.widthItems||this.query(".image");this.widthItems.style("width",toura.app.UI.viewport.width+"px");},_setCurrentImageIndexAttr:function(_2fc){this.bgImgs=this.bgImgs||dojo.filter(dijit.findWidgets(this.domNode),function(w){return w.isInstanceOf(toura.ui.BackgroundImage);});dojo.forEach(this.bgImgs,function(_2fd,i){if(_2fc!==null&&i>=_2fc-1&&i<=_2fc+1){_2fd.loadImage();}else{_2fd.unloadImage();}},this);this.currentImageIndex=_2fc;},_setupClick:function(){if(!this._handleClick){return;}if(!this.clickNode){return;}var _2fe=toura.app.UI.hasTouch?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"};this.connect(this.clickNode,_2fe.start,function(){var c=[],_2ff,_300=dojo.hitch(this,"_handleClick"),_301=new Date().getTime();c.push(dojo.connect(this.imageList,_2fe.move,function(){_2ff=true;}));c.push(dojo.connect(this.imageList,_2fe.end,function(e){dojo.forEach(c,dojo.disconnect);if((new Date().getTime()-_301>toura.app.UI.touchMoveDebounce)&&_2ff){return;}_300(e);}));});}});}if(!dojo._hasResource["toura.components._ImageScroller"]){dojo._hasResource["toura.components._ImageScroller"]=true;dojo.provide("toura.components._ImageScroller");dojo.declare("toura.components._ImageScroller",[toura.components._ImageGallery],{postMixInProperties:function(){this.inherited(arguments);this.useScroller=this.images.length>1;},startup:function(){this.inherited(arguments);this._setupImageScroller();},_setupImageScroller:function(){if(this.useScroller&&this.scrollerNode){var self=this,node=this.scrollerNode.parentNode,_302;_302=this.scrollerHandle=new iScroll(node,{snap:true,momentum:false,hScrollbar:false,onScrollEnd:function(){self.set("currentImageIndex",this.currPageX);self.onScrollEnd(this.currPageX);}});_302.refresh();this.onScrollerSetupComplete();}this.set("currentImageIndex",0);},onScrollerSetupComplete:function(){console.log("toura.components._ImageScroller::onScrollerSetupComplete()");},onScrollEnd:function(_303){},_setWidth:function(){var _304=toura.app.UI.viewport.width,_305=this.images.length*_304;this.scrollerNode.style.width=_305+"px";this.query(".image").style("width",_304+"px");if(!this.scrollerHandle){return;}this.scrollerHandle.refresh();this.scrollToIndex(this.currentImageIndex);},scrollToIndex:function(_306){if(!this.scrollerHandle){return;}if(_306===this.currentImageIndex){return;}this.scrollerHandle.scrollToPage(_306,0,"0ms");this.set("currentImageIndex",_306);},refresh:function(){if(!this.scrollerHandle){return;}this.scrollerHandle.refresh();},destroy:function(){if(this.scrollerHandle){this.scrollerHandle.destroy();}this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.ImageGallery"]){dojo._hasResource["toura.components.ImageGallery"]=true;dojo.provide("toura.components.ImageGallery");dojo.declare("toura.components.ImageGallery",[toura.components._Component,toura.components._ImageScroller],{templateString:dojo.cache("toura.components","ImageGallery/ImageGallery.haml",".component.image-gallery\n  %ol{ dojoAttachPoint : 'imageList' }\n    :each img in images\n      %li{ class : 'image ' + img.id }\n        .image{ dojoType : 'toura.ui.BackgroundImage', imageUrl : img.url, imageHeight : img.height, imageWidth : img.width }\n"),prepareData:function(){this.images=dojo.map(this.node.images||[],function(img){return dojo.mixin(img,{url:img.gallery.url,height:img.gallery.height,width:img.gallery.width});},this);},postCreate:function(){this.scrollerNode=this.clickNode=this.imageList;this.inherited(arguments);},_handleClick:function(){this.onShowDetail(this.currentImageIndex);},onShowDetail:function(_307){}});}if(!dojo._hasResource["toura.components.DetailTitle"]){dojo._hasResource["toura.components.DetailTitle"]=true;dojo.provide("toura.components.DetailTitle");dojo.declare("toura.components.DetailTitle",[toura.components._Component],{templateString:dojo.cache("toura.components","DetailTitle/DetailTitle.haml",".component.detail-title\n  %a.close{ href : '#', dojoAttachPoint : 'closeButton' }= i18n_close\n  %h1{ dojoAttachPoint : 'titleElement' }= title\n"),setupConnections:function(){this.connect(this.closeButton,"click","_close");},_close:function(e){e.preventDefault();this.onClose();},onClose:function(){},initializeStrings:function(){this.i18n_close=this.getString("CLOSE");},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}});}if(!dojo._hasResource["toura.ui.PinchZoom"]){dojo._hasResource["toura.ui.PinchZoom"]=true;dojo.provide("toura.ui.PinchZoom");dojo.declare("toura.ui.PinchZoom",null,{zoomMax:3,_makeScroller:function(_308){var self=this,_309=dijit.byNode(_308.firstChild);if(this.scroller){this.scroller.destroy();}this.scroller=new iScroll(_308,{zoom:toura.app.Has.iScrollZoom(),onZoomEnd:function(){self.onZoomEnd(_309,this);},zoomMin:0.33,zoomMax:this.zoomMax});},onZoomEnd:function(_30a,_30b){if(this.zoomTimeout){return;}this.zoomTimeout=setTimeout(dojo.hitch(this,function(){var _30c=_30b.scale,_30d=dojo.style(_30a.domNode,"width"),_30e=dojo.style(_30a.domNode,"height"),_30f=_30d*_30c,_310=_30e*_30c,newX=_30b.x,newY=_30b.y;if(_30a.imageWidth>_30a.imageHeight){if(_30f<toura.app.UI.viewport.width){_30f=toura.app.UI.viewport.width;_310=_30f/ratio;}}else{if(_310<toura.app.UI.viewport.height){_310=toura.app.UI.viewport.height;_30f=_310*ratio;}}if(_30f>toura.app.UI.viewport.width*this.zoomMax){_30f=_30d;_310=_30e;newX=newY=0;}dojo.style(_30a.domNode,"width",_30f+"px");dojo.style(_30a.domNode,"height",_310+"px");_30b.zoom(newX,newY,1,0);clearTimeout(this.zoomTimeout);this.zoomTimeout=null;}),0);}});}if(!dojo._hasResource["toura.components.ImageDetail"]){dojo._hasResource["toura.components.ImageDetail"]=true;dojo.provide("toura.components.ImageDetail");dojo.declare("toura.components.ImageDetail",[toura.components._Component,toura.components._ImageGallery,toura.ui.PinchZoom],{templateString:dojo.cache("toura.components","ImageDetail/ImageDetail.haml",".component.image-detail\n  %nav.header{ dojoAttachPoint : 'nav' }\n\n  .content\n    .image-nav.prev{ dojoAttachPoint : 'prevButton' }= i18n_prev\n\n    %ol{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li{ class : 'image ' + img.id }\n          .wrapper{ dojoType : 'toura.ui.BackgroundImage', imageUrl : img.url, imageHeight : img.height, imageWidth : img.width }\n\n    .image-nav.next{ dojoAttachPoint : 'nextButton' }= i18n_next\n\n  .caption{ dojoAttachPoint : 'captionContainer' }\n"),widgetsInTemplate:true,main:false,prepareData:function(){var _311=this.device;this.imageCache={};this.images=dojo.map(this.node.images||[],function(img){this.imageCache[img.id]=img;return dojo.mixin(img,(_311.type==="tablet"?{url:img.original.url,height:img.original.height,width:img.original.width}:{url:img.gallery.url,height:img.gallery.height,width:img.gallery.width}));},this);},postCreate:function(){this.nav=this.adopt(this.main?toura.components.PageNav:toura.components.DetailTitle,{node:this.node}).placeAt(this.nav,"replace");this.clickNode=this.imageList;this.cleanView=this.main?true:false;this._toggleCleanView();this.connect(this.nav,"onClose","_hideDetail");this.connect(this.nextButton,"click",this._go(1));this.connect(this.prevButton,"click",this._go(-1));this.set("active",false);this.inherited(arguments);},showNav:function(){this.removeClass("clean");},_go:function(_312){return dojo.hitch(this,function(){this.set("currentImageIndex",this.currentImageIndex+_312);});},_handleClick:function(){this._toggleCleanView();},_hideDetail:function(){this.set("active",false);this.onHideDetail(this.currentImageIndex);if(!this.scroller){return;}this.scroller.zoom(0,0,1);},onHideDetail:function(_313){console.log("ImageDetail::onHideDetail()",_313);},onScrollerSetupComplete:function(){this.set("active",false);},_setActiveAttr:function(_314){dojo[_314?"removeClass":"addClass"](this.domNode,"hidden");},_toggleCleanView:function(){var _315=this.cleanView=!this.cleanView;dojo[_315?"addClass":"removeClass"](this.domNode,"clean");},_setCurrentImageIndexAttr:function(_316){this.inherited(arguments);var img=this.images[_316];this.set("caption",img.caption);this.nav.set("screenTitle",img&&img.name||"");if(this.scroller){this.scroller.destroy();}this.bgImgs.forEach(function(_317,_318){var _319=_317.domNode.parentNode,_31a=_318===_316;dojo[_31a?"removeClass":"addClass"](_319,"hidden");if(!_31a){return;}this._makeScroller(_319);},this);var _31b=_316===0,_31c=_316===(this.images.length-1);dojo[_31b?"addClass":"removeClass"](this.prevButton,"hidden");dojo[_31c?"addClass":"removeClass"](this.nextButton,"hidden");},_setCaptionAttr:function(_31d){var _31e=this.captionContainer;this.caption=_31d;if(_31d){_31e.innerHTML=_31d;dojo.removeClass(_31e,"hidden");}else{dojo.empty(_31e);dojo.addClass(_31e,"hidden");}},initializeStrings:function(){this.i18n_prev=this.getString("PREVIOUS");this.i18n_next=this.getString("NEXT");}});}if(!dojo._hasResource["toura.components._MediaPlayer"]){dojo._hasResource["toura.components._MediaPlayer"]=true;dojo.provide("toura.components._MediaPlayer");(function(){var pg=toura.app.Phonegap;dojo.declare("toura.components._MediaPlayer",[toura.components._Component],{useHtml5Player:true,prepareData:function(){this.inherited(arguments);this.mediasCache={};this.medias=dojo.map(this.medias||[],function(_31f){this.mediasCache[_31f.id]=_31f=dojo.mixin(_31f,{assetUrl:[this.baseUrl,_31f.id].join("/")});return _31f;},this);this.media=this.medias[0]||null;this.useHtml5Player=toura.app.Has.html5Player();},setupSubscriptions:function(){this.inherited(arguments);if(!this.useHtml5Player){return;}this.subscribe("/page/transition/end","_setupPlayer");},adjustMarkup:function(){if(!this.useHtml5Player){this.addClass("has-html5-player");}},play:function(_320){this.set("mediaId",_320);this._play(this.media);},_play:function(_321){if(this.useHtml5Player){this.player.play();}dojo.publish("/"+this.playerType+"/play",[this.media.id]);},_pause:function(){if(this.useHtml5Player&&this.player){this.player.pause();}},_setMediaIdAttr:function(_322){var _323=this.media=this.mediasCache[_322];if(this.useHtml5Player&&!this.player){this._queuedMedia=_323;return;}this._queuedMedia=null;if(this.player){this.player.src=_323.url;}},_setupPlayer:function(){if(!this.useHtml5Player){return;}if(!this.media){return;}var _324=this.media,_325=this.domNode,_326=this.player=dojo.create(this.playerType,dojo.mixin({src:_324.url},this.playerSettings)),doIt=dojo.partial(dojo.place,_326,_325);var c=dojo.connect(_326,"loadstart",this,function(){dojo.disconnect(c);c=false;if(!_325){return;}doIt();});setTimeout(function(){if(!c){return;}dojo.disconnect(c);doIt();},100);}});}());}if(!dojo._hasResource["toura.components.AudioPlayer"]){dojo._hasResource["toura.components.AudioPlayer"]=true;dojo.provide("toura.components.AudioPlayer");dojo.declare("toura.components.AudioPlayer",[toura.components._MediaPlayer],{templateString:dojo.cache("toura.components","AudioPlayer/AudioPlayer.haml",".component.audio-player\n  :if !useHtml5Player\n    %form\n      %input{ type : 'button', class : 'play', dojoAttachPoint : 'controller' }\n"),playerType:"audio",isPlaying:false,playerSettings:{preload:"auto",controls:true,autobuffer:true},prepareData:function(){this.medias=this.node.audios||[];this.inherited(arguments);},setupConnections:function(){this.inherited(arguments);if(!this.useHtml5Player){this.connect(this.controller,"click","_handleControllerClick");}},_handleControllerClick:function(){if(this.useHtml5Player){return;}if(this.isPlaying){this._pause();this.isPlaying=false;this.removeClass("playing");}else{this._play();this.isPlaying=true;this.addClass("playing");}},_play:function(_327){this.inherited(arguments);if(this.useHtml5Player){return;}var pg=toura.app.Phonegap;pg.audio.destroy();pg.audio.play(this.media.url);},_pause:function(){this.inherited(arguments);if(!this.useHtml5Player){toura.app.Phonegap.audio.stop();}},teardown:function(){if(!this.useHtml5Player){toura.app.Phonegap.audio.destroy();}}});}if(!dojo._hasResource["toura.components.ChildNodes"]){dojo._hasResource["toura.components.ChildNodes"]=true;dojo.provide("toura.components.ChildNodes");dojo.declare("toura.components.ChildNodes",[toura.components._Component],{templateString:dojo.cache("toura.components","ChildNodes/ChildNodes.haml","%ul.component.child-nodes\n  :each c in children\n    %li\n      %a{ href : '#/node/' + c.id }= c.name\n"),handleClicks:true,prepareData:function(){this.children=this.node.children||[];},adjustMarkup:function(){if(!this.children.length){this.addClass("empty");}},_clickHandler:function(t,e){dojo.addClass(t,"tapped");}});}if(!dojo._hasResource["toura.components.AssetList"]){dojo._hasResource["toura.components.AssetList"]=true;dojo.provide("toura.components.AssetList");dojo.declare("toura.components.AssetList",[toura.components._Component],{templateString:dojo.cache("toura.components","AssetList/AssetList.haml",".component.asset-list\n  %ul{ dojoAttachPoint : 'list' }\n    :each a in assets\n      %li{ id : 'asset-' + a.id, data-id : a.id }\n        %a{ href : '#' }= a.name\n\n"),"class":"assets",prepareData:function(){this.assets=this.assets||(this.type&&this.node[this.type])||[];this.assets=dojo.map(this.assets,function(a){return dojo.mixin(a,{assetUrl:this.baseUrl+"/"+a.id});},this);this.baseUrl=this.node.assetTypeUrl(this.type);},setupConnections:function(){this.connect(this.domNode,"touchmove",function(){this.handle=null;});this.connect(this.domNode,"touchend",function(){if(this.handle&&dojo.isFunction(this.handle)){this.handle();}});dojo.forEach(this.list.children,function(n){var _328=dojo.attr(n,"data-id");if(toura.app.UI.hasTouch){this.connect(n,"touchstart",function(){this.handle=dojo.hitch(this,"_onSelect",_328);});this.connect(n,"click",function(e){e.preventDefault();});}else{this.connect(n,"click",function(e){e.preventDefault();this._onSelect(_328);});}},this);},_onSelect:function(_329){this.set("currentAsset",_329);this.onSelect(_329);},onSelect:function(_32a){},_setCurrentAssetAttr:function(_32b){var item=this.query("#asset-"+_32b)[0];this.query(".asset-list li").removeClass("current");dojo.addClass(item,"current");this.currentAsset=_32b;}});}if(!dojo._hasResource["toura.components.AudioList"]){dojo._hasResource["toura.components.AudioList"]=true;dojo.provide("toura.components.AudioList");dojo.declare("toura.components.AudioList",[toura.components.AssetList],{"class":"audio-list",postMixInProperties:function(){this.assets=this.node.audios||[];this.inherited(arguments);}});}if(!dojo._hasResource["toura.pageControllers.node.Audios1"]){dojo._hasResource["toura.pageControllers.node.Audios1"]=true;dojo.provide("toura.pageControllers.node.Audios1");dojo.declare("toura.pageControllers.node.Audios1",[toura.pageControllers.node._Node,toura.pageControllers.node._ImageGalleryPage],{templateString:dojo.cache("toura.pageControllers.node","Audios1/Audios1.haml","%li.page.audios-1\n  .detail.hidden{ dojoAttachPoint : 'detail' }\n\n  .screen.index{ dojoAttachPoint : 'mainScreen' }\n    .header{ dojoAttachPoint : 'pageNav' }\n\n    .body\n      .row-1\n        %div{ dojoAttachPoint : 'imageGallery' }\n\n      .row-2\n        %div{ dojoAttachPoint : 'audioPlayer' }\n\n      .row-3\n        :if phone\n          %div{ dojoType : 'toura.ui.Scrollable' }\n            %div\n              .audio-list{ dojoAttachPoint : 'audioList' }\n              .child-nodes{ dojoAttachPoint : 'childNodes' }\n              .caption{ dojoAttachPoint : 'audioCaption' }\n              .body-text{ dojoAttachPoint : 'bodyText' }\n\n        :if tablet\n          .col-1\n            %div{ dojoType : 'toura.ui.Scrollable' }\n              %div\n                %div{ dojoAttachPoint : 'childNodes' }\n                .text{ dojoAttachPoint : 'audioCaption' }\n                .text{ dojoAttachPoint : 'bodyText' }\n\n          .col-2\n            %div{ dojoType : 'toura.ui.Scrollable' }\n              %div\n                .caption{ dojoAttachPoint : 'imageCaption' }\n                .audio-list{ dojoAttachPoint : 'audioList' }\n"),postMixInProperties:function(){this.inherited(arguments);this.audiosCache={};this.audios=dojo.map(this.node.audios,function(_32c,idx){this.audiosCache[_32c.id]=_32c=dojo.mixin(_32c,{index:idx});return _32c;},this);this.placements=[["AudioPlayer",{node:this.node},"audioPlayer","replace"],["ImageGallery",{node:this.node},"imageGallery"],["ImageDetail",{node:this.node},"detail","replace"],["ChildNodes",{node:this.node},"childNodes","replace"],["AudioCaption",{node:this.node},"audioCaption"],["BodyText",{node:this.node},"bodyText"],["ImageCaption",{node:this.node},"imageCaption"]];if(this.node.audios.length>1){this.placements.push(["AudioList",{node:this.node},"audioList"]);}else{dojo.destroy(this.audioList);}},postCreate:function(){this.inherited(arguments);this.connect(this.audioList,"onSelect",function(_32d){var _32e=this._audioById(_32d);this.audioPlayer.play(_32d);this.audioCaption.set("content",_32e.caption||"");dojo.publish("/content/update");});if(this.audioPlayer.useHtml5Player){this.subscribe("/ImageGalleryPage/detail/show","togglePlayer");this.subscribe("/ImageGalleryPage/detail/hide","togglePlayer");}},_audioById:function(_32f){return this.audiosCache[_32f]||false;},_setup:function(){this._imageGalleryPageSetup({gallery:this.imageGallery,caption:this.imageCaption,fullScreen:this.detail});},init:function(_330){if(!_330.assetId||_330.assetType!=="audios"){return;}var _331=_330.assetId,_332=this._audioById(_331);if(this.audioList){this.audioList.set("currentAsset",_331);}if(this.audioCaption){this.audioCaption.set("content",_332.caption||"");}this.audioPlayer.set("mediaId",_331);},togglePlayer:function(){this.audioPlayer.toggle();}});}if(!dojo._hasResource["toura._AsyncView"]){dojo._hasResource["toura._AsyncView"]=true;dojo.provide("toura._AsyncView");dojo.declare("toura._AsyncView",[],{postMixInProperties:function(){this.inherited(arguments);this.queue=[];},_addToQueue:function(fn){this.queue.push(fn);},_doQueue:function(){dojo.forEach(this.queue,function(fn){fn();},this);}});}if(!dojo._hasResource["dijit.DialogUnderlay"]){dojo._hasResource["dijit.DialogUnderlay"]=true;dojo.provide("dijit.DialogUnderlay");dojo.declare("dijit.DialogUnderlay",[dijit._Widget,dijit._Templated],{templateString:"<div class='dijitDialogUnderlayWrapper'><div class='dijitDialogUnderlay' dojoAttachPoint='node'></div></div>",dialogId:"","class":"",attributeMap:{id:"domNode"},_setDialogIdAttr:function(id){dojo.attr(this.node,"id",id+"_underlay");this._set("dialogId",id);},_setClassAttr:function(_333){this.node.className="dijitDialogUnderlay "+_333;this._set("class",_333);},postCreate:function(){dojo.body().appendChild(this.domNode);},layout:function(){var is=this.node.style,os=this.domNode.style;os.display="none";var _334=dojo.window.getBox();os.top=_334.t+"px";os.left=_334.l+"px";is.width=_334.w+"px";is.height=_334.h+"px";os.display="block";},show:function(){this.domNode.style.display="block";this.layout();this.bgIframe=new dijit.BackgroundIframe(this.domNode);},hide:function(){this.bgIframe.destroy();delete this.bgIframe;this.domNode.style.display="none";}});}if(!dojo._hasResource["toura.components.GoogleMap"]){dojo._hasResource["toura.components.GoogleMap"]=true;dojo.provide("toura.components.GoogleMap");(function(dojo){var _335=0;dojo.declare("toura.components.GoogleMap",[toura.components._Component,toura._AsyncView],{templateString:dojo.cache("toura.components","GoogleMap/GoogleMap.haml",".component.google-map\n  .map{ dojoAttachPoint : 'mapNode' }\n"),mapType:"roadmap",apiURL:toura.app.URL.protocol()+"://maps.google.com/maps/api/js?v=3.4&sensor=false&callback=",prepareData:function(){this.googleTries=0;this.pinCache={};this.markerCache={};this.queue=[];this.isBuilt=false;this.pins=this.node.googleMapPins;dojo.forEach(this.pins,function(pin){this.pinCache[pin.id]=pin;},this);},postCreate:function(){this.inherited(arguments);this.callbackName="GoogleMapCallback"+(++_335);window[this.callbackName]=dojo.hitch(this,"_buildMap");dojo.io.script.get({url:this.apiURL+this.callbackName});},_buildMap:function(){delete window[this.callbackName];this.map=new google.maps.Map(this.mapNode,{mapTypeId:this.mapType,streetViewControl:false,mapTypeControl:false,zoom:0,zoomControl:true,zoomControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}});var _336=new google.maps.LatLngBounds();this.markers=dojo.map(this.pins||[],function(pin){var _337=new google.maps.LatLng(pin.lat,pin.lon),_338=new google.maps.Marker({map:this.map,position:_337,title:pin.name});google.maps.event.addListener(_338,"click",dojo.hitch(this,"_showInfo",_338,pin));_336.extend(_337);this.markerCache[pin.id]=_338;return _338;},this);if(this.pins.length>1){this.map.fitBounds(_336);}else{if(this.pins[0]){this.map.setCenter(new google.maps.LatLng(this.pins[0].lat,this.pins[0].lon));this.map.setZoom(15);}}this.isBuilt=true;this._doQueue();this.onMapBuilt();},_showInfo:function(_339,pin){var _33a;if(this.tablet){_33a=new google.maps.InfoWindow({content:this.pinInfo.domNode});_33a.open(this.map,_339);}this.onShowInfo(pin);},onShowInfo:function(pin){},onMapBuilt:function(){},_setCenterAttr:function(_33b){_33b=new google.maps.LatLng(_33b.lat,_33b.lng);this.map.setCenter(_33b);this.map.setZoom(15);},_setPinAttr:function(_33c){if(!_33c){return;}if(!this.isBuilt){this._addToQueue(dojo.hitch(this,"set","pin",_33c));return;}var _33d=this.markerCache[_33c],pin=this.pinCache[_33c],_33e=new google.maps.LatLng(pin.lat,pin.lon);this.map.panTo(_33e);this._showInfo(_33d,pin);this.pin=pin;},teardown:function(){if(window.google&&window.google.maps&&window.google.maps.event){dojo.forEach(this.markers,function(_33f){google.maps.event.clearInstanceListeners(_33f);_33f.setMap(null);});google.maps.event.clearInstanceListeners(this.map);}}});}(dojo));}if(!dojo._hasResource["toura.components.PinCaption"]){dojo._hasResource["toura.components.PinCaption"]=true;dojo.provide("toura.components.PinCaption");dojo.declare("toura.components.PinCaption",[toura.components.BodyText],{"class":"pin-caption",_getBodyText:function(){return this.caption||this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.PinInfo"]){dojo._hasResource["toura.components.PinInfo"]=true;dojo.provide("toura.components.PinInfo");dojo.declare("toura.components.PinInfo",[toura.components._Component],{templateString:dojo.cache("toura.components","PinInfo/PinInfo.haml",".component.pin-info\n  .header{ dojoAttachPoint : 'nav' }\n\n  .body\n    %a.directions{ dojoAttachPoint : 'directionsNode', target : '_blank' }= i18n_directions\n    %a.phone-number{ dojoAttachPoint : 'phoneNumberContainerNode' }\n      %span.label= i18n_phone\n      %span{ dojoAttachPoint : 'phoneNumberNode' }\n    %a.website{ dojoAttachPoint : 'websiteContainerNode' }= i18n_website\n\n    .bottom\n      :if phone\n        %div{ dojoType : 'toura.ui.Scrollable', dojoAttachPoint : 'scroller' }\n          %section\n            %header\n              %h2{ dojoAttachPoint : 'nameNode' }\n              %p{ dojoAttachPoint : 'addressNode' }\n            %div{ dojoAttachPoint : 'captionNode' }\n\n      :if tablet\n        %section\n          %header\n            %h2{ dojoAttachPoint : 'nameNode' }\n            %p{ dojoAttachPoint : 'addressNode' }\n          %div{ dojoAttachPoint : 'captionNode' }\n"),widgetsInTemplate:true,setupChildComponents:function(){if(this.scroller){this.scroller.makeScroller();}this.captionNode=this.adopt(toura.components.PinCaption).placeAt(this.captionNode,"replace");this.detailTitle=this.phone?this.adopt(toura.components.DetailTitle).placeAt(this.nav,"replace"):null;},setupConnections:function(){if(this.detailTitle){this.connect(this.detailTitle,"onClose","_onClose");}this.connect(this.websiteContainerNode,"click",function(e){e.preventDefault();toura.app.Phonegap.browser.url(dojo.attr(this.websiteContainerNode,"data-url"));});},_onClose:function(){this.onClose();},onClose:function(){},_setPinAttr:function(pin){if(!pin){return;}this.set("pinName",pin.name);this.set("address",pin.address);this.set("directionsUrl",toura.app.URL.googleMapAddress(pin.address));this.set("phoneNumber",pin.phoneNumber);this.set("website",pin.website);this.captionNode.set("content",pin.caption||"");if(this.detailTitle){this.detailTitle.set("screenTitle",pin.name);}if(this.scroller){this.scroller.refreshScroller();}},_setPhoneNumberAttr:function(_340){if(!_340){this.hide(this.phoneNumberContainerNode);return;}this.show(this.phoneNumberContainerNode);this.phoneNumberNode.innerHTML=_340;dojo.attr(this.phoneNumberContainerNode,"href",toura.app.URL.tel(_340));},_setWebsiteAttr:function(_341){if(!_341){this.hide(this.websiteContainerNode);return;}this.show(this.websiteContainerNode);dojo.attr(this.websiteContainerNode,"data-url",_341);},attributeMap:{pinName:{node:"nameNode",type:"innerHTML"},address:{node:"addressNode",type:"innerHTML"},directionsUrl:{node:"directionsNode",type:"attribute",attribute:"href"}},initializeStrings:function(){this.i18n_directions=this.getString("DIRECTIONS");this.i18n_phone=this.getString("PHONE");this.i18n_website=this.getString("WEBSITE");}});}if(!dojo._hasResource["toura.pageControllers.node.GoogleMap1"]){dojo._hasResource["toura.pageControllers.node.GoogleMap1"]=true;dojo.provide("toura.pageControllers.node.GoogleMap1");dojo.declare("toura.pageControllers.node.GoogleMap1",[toura.pageControllers.node._Node,toura._AsyncView],{templateString:dojo.cache("toura.pageControllers.node","GoogleMap1/GoogleMap1.haml","%li.page.google-map-1\n  :if phone\n    .detail{ dojoAttachPoint : 'detail' }\n\n  .index\n\n    .header{ dojoAttachPoint : 'pageNav' }\n    .body{ dojoAttachPoint : 'body' }\n"),postCreate:function(){toura.app.Phonegap.network.isReachable("maps.google.com").then(dojo.hitch(this,"_postCreate"));toura.app.UI.set("siblingNavVisible",false);this.inherited(arguments);},_postCreate:function(_342){if(!_342){this.failure="No internet connection found.";return;}var _343=toura.components;this.googleMap=this.adopt(_343.GoogleMap,{node:this.node}).placeAt(this.body,"replace");this.pinInfo=this.adopt(_343.PinInfo,{});if(this.phone){this.pinInfo.placeAt(this.detail);}else{this.googleMap.set("pinInfo",this.pinInfo);}this.connect(this.googleMap,"onShowInfo",function(pin){if(this.phone){dojo.addClass(this.detail,"active");}this.pinInfo.set("pin",pin);});this.connect(this.pinInfo,"onClose",function(){if(this.phone){dojo.removeClass(this.detail,"active");}});this._doQueue();},_setPin:function(pin){this.googleMap.set("pin",pin);},init:function(_344){if(!_344.assetId){return;}if(!this.googleMap){this._addToQueue(dojo.hitch(this,"init",_344));return;}this._setPin(_344.assetId);this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.VideoList"]){dojo._hasResource["toura.components.VideoList"]=true;dojo.provide("toura.components.VideoList");dojo.declare("toura.components.VideoList",[toura.components.AssetList],{"class":"video-list",postMixInProperties:function(){this.assets=this.node.videos||[];this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.VideoPlayer"]){dojo._hasResource["toura.components.VideoPlayer"]=true;dojo.provide("toura.components.VideoPlayer");dojo.declare("toura.components.VideoPlayer",[toura.components._MediaPlayer],{templateString:dojo.cache("toura.components","VideoPlayer/VideoPlayer.haml",".component.video-player\n  :if !useHtml5Player\n    .fake-video\n      .play-button{ dojoAttachPoint : 'playButton' }\n      %img.poster{ src : poster, dojoAttachPoint : \"videoPlaceholder\" }\n\n  :if useHtml5Player\n    .overlay{ dojoAttachPoint : 'overlay' }\n"),playerType:"video",defaultPoster:"./icons/video-poster.png",aspectRatio:3/4,playerSettings:{controls:true},prepareData:function(){this.medias=this.node.videos||[];this.inherited(arguments);if(this.useHtml5Player&&this.media.poster){this.playerSettings=dojo.mixin(this.playerSettings,{poster:this.media.poster});}if(!this.useHtml5Player){this.poster=this.media.poster||this.defaultPoster;}},setupConnections:function(){this.inherited(arguments);if(this.useHtml5Player){return;}this.connect(this.videoPlaceholder,"click","_play");this.connect(this.playButton,"click","_play");},startup:function(){if(this.useHtml5Player){toura.util.copyStyles(this.player,this.overlay,["width","height"]);}},_play:function(_345){this.inherited(arguments);if(this.useHtml5Player){return;}toura.app.Phonegap.browser.url(this.media.url);},_setMediaIdAttr:function(_346){this.inherited(arguments);this.set("poster",this.media.poster);},_setPosterAttr:function(_347){if(!this.useHtml5Player){var _348=toura.app.UI.viewport.width;this.videoPlaceholder.width=_348;this.videoPlaceholder.src=_347||this.defaultPoster;dojo.style(this.playButton,{"width":_348+"px","height":Math.floor(_348*this.aspectRatio)+"px"});return;}if(this.player){this.player.poster=_347||"";}}});}if(!dojo._hasResource["toura.components.VideoCaption"]){dojo._hasResource["toura.components.VideoCaption"]=true;dojo.provide("toura.components.VideoCaption");dojo.declare("toura.components.VideoCaption",[toura.components.BodyText],{"class":"video-caption",_getBodyText:function(){if(!this.node||!this.node.videos){return "";}return this.node.videos[0]?(this.node.videos[0].caption||""):"";}});}if(!dojo._hasResource["toura.pageControllers.node.Videos1"]){dojo._hasResource["toura.pageControllers.node.Videos1"]=true;dojo.provide("toura.pageControllers.node.Videos1");dojo.declare("toura.pageControllers.node.Videos1",[toura.pageControllers.node._Node],{templateString:dojo.cache("toura.pageControllers.node","Videos1/Videos1.haml","%li.page.videos-1\n  .screen.index\n    .header{ dojoAttachPoint : 'pageNav' }\n\n    .body\n      .top\n        .content{ dojoAttachPoint : 'videoPlayer' }\n\n      .bottom\n        :if phone\n          %div{ dojoType : 'toura.ui.Scrollable' }\n            %div\n              .video-list{ dojoAttachPoint : 'videoList' }\n              .child-nodes{ dojoAttachPoint : 'childNodes' }\n              .body-text{ dojoAttachPoint : 'videoCaption' }\n              .body-text{ dojoAttachPoint : 'bodyText' }\n\n        :if tablet\n          .col-1\n            %div{ dojoType : 'toura.ui.Scrollable' }\n              %div\n                .body-text{ dojoAttachPoint : 'videoCaption' }\n                .body-text{ dojoAttachPoint : 'bodyText' }\n\n\n          .col-2\n            %div{ dojoType : 'toura.ui.Scrollable' }\n              %div\n                .video-list{ dojoAttachPoint : 'videoList' }\n                .child-nodes{ dojoAttachPoint : 'childNodes' }\n\n"),postMixInProperties:function(){this.inherited(arguments);this.videosCache={};this.videos=dojo.map(this.node.videos,function(_349,idx){this.videosCache[_349.id]=_349=dojo.mixin(_349,{index:idx});return _349;},this);this.placements=[["BodyText",{node:this.node},"bodyText"],["VideoCaption",{node:this.node},"videoCaption"],["ChildNodes",{node:this.node},"childNodes"],["VideoPlayer",{node:this.node},"videoPlayer"]];if(this.node.videos.length>1){this.placements.push(["VideoList",{node:this.node},"videoList"]);}else{dojo.destroy(this.videoList);}},postCreate:function(){this.inherited(arguments);this.connect(this.videoList,"onSelect",function(_34a){var _34b=this._videoById(_34a);this.videoCaption.set("content",_34b.caption||"");this.videoPlayer.play(_34a);dojo.publish("/content/update");});if(this.videoPlayer.useHtml5Player){this.subscribe("/MoreDrawer/show",dojo.hitch(this.videoPlayer,"disable"));this.subscribe("/MoreDrawer/hide",dojo.hitch(this.videoPlayer,"enable"));}},init:function(_34c){if(!_34c.assetId||_34c.assetType!=="videos"){return;}var _34d=_34c.assetId,_34e=this._videoById(_34d);if(this.videoList){this.videoList.set("currentAsset",_34d);}this.videoPlayer.set("mediaId",_34d);this.videoCaption.set("content",_34e.caption||"");},_videoById:function(_34f){return this.videosCache[_34f]||false;}});}if(!dojo._hasResource["toura.containers._LayoutBox"]){dojo._hasResource["toura.containers._LayoutBox"]=true;dojo.provide("toura.containers._LayoutBox");dojo.declare("toura.containers._LayoutBox",[toura._View,toura.ui.BackgroundImage],{templateString:"<div class=layout-box></div>",defaultConfig:{containerType:"row",layout:"normal",size:"flex",scrollable:false},postMixInProperties:function(){this.config=dojo.mixin(dojo.mixin({},this.defaultConfig),this.config);},postCreate:function(){this.inherited(arguments);var _350=[this.config.containerType+"-container","size-"+this.config.size,"layout-"+this.config.layout];if(this.config.className){_350.push(this.config.className);}this.addClass(_350);if(this.config.backgroundImage&&this.backgroundImage){this.loadImage();}}});}if(!dojo._hasResource["toura.containers.Region"]){dojo._hasResource["toura.containers.Region"]=true;dojo.provide("toura.containers.Region");dojo.declare("toura.containers.Region",[toura.containers._LayoutBox],{templateString:dojo.cache("toura.containers","Region/Region.haml",".region\n  .pane{ dojoAttachPoint : 'pane' }\n    .inner{ dojoAttachPoint : 'inner' }\n"),config:{},_scroller:null,postCreate:function(){this.inherited(arguments);this._placeComponents();this._placeRegions();this._setupScroller();this.addClass(this.boxType);this.connect(this.screen,"startup","startup");},_setupScroller:function(){if(this.config.scrollable){this._scroller=new toura.ui.Scrollable({},this.pane);}},_placeComponents:function(){var _351=this.containerType==="component"?[this.domNode,"replace"]:this.config.scrollable?[this.inner,"last"]:[this.pane,"replace"];if(this.config.components&&this.config.components.length>1&&_351[0]===this.pane){console.error("WARNING: you're trying to place more than one component into a non-scrollable region. this will end badly.");}if(this.config.components&&this.config.components.length){dojo.forEach(this.config.components,function(_352){if(_352==="PageNav"&&this.baseObj.id===toura.app.Config.get("app").homeNodeId){return;}var _353=_352.match(/^custom\./)?client.components[_352.replace(/^custom\./,"")]:toura.components[_352];var c=this.adopt(_353,{baseObj:this.baseObj,page:this.page,node:this.baseObj,device:this.device,screen:this.screen,region:this});c.placeAt(_351[0],_351[1]);},this);}},_placeRegions:function(){if(this.config.regions&&this.config.regions.length){dojo.destroy(this.pane);dojo.forEach(this.config.regions,function(_354){this.adopt(toura.containers.Region,{config:_354,baseObj:this.baseObj,device:this.device,screen:this.screen,backgroundImage:this.backgroundImage,boxType:this.config.containerType}).placeAt(this.domNode);},this);}},refreshScroller:function(){if(this._scroller){this._scroller.refreshScroller();}}});}if(!dojo._hasResource["toura.containers.Screen"]){dojo._hasResource["toura.containers.Screen"]=true;dojo.provide("toura.containers.Screen");dojo.declare("toura.containers.Screen",[toura.containers._LayoutBox],{templateString:dojo.cache("toura.containers","Screen/Screen.haml",".screen\n"),components:{},postCreate:function(){this.inherited(arguments);this.addClass(this.config.name);if(this.config.layoutName){this.addClass(this.config.layoutName);}if(this.config.regions){this.regions=dojo.map(this.config.regions,function(_355){return this.adopt(toura.containers.Region,{page:this.page,config:_355,baseObj:this.baseObj,device:this.device,screen:this,backgroundImage:this.backgroundImage,boxType:this.config.containerType}).placeAt(this.domNode);},this);}},registerComponent:function(c){var _356=c.declaredClass.replace("toura.components.","").replace("client.components.","custom.");this.components[_356]=c;},getComponent:function(n){return this.components[n];}});}if(!dojo._hasResource["toura.components.buttons.AboutButton"]){dojo._hasResource["toura.components.buttons.AboutButton"]=true;dojo.provide("toura.components.buttons.AboutButton");dojo.declare("toura.components.buttons.AboutButton",[toura.components.buttons._Button],{"class":"about",prepareData:function(){this.url=toura.app.URL.about();},initializeStrings:function(){this.i18n_text=this.getString("ABOUT");}});dojo.mixin(toura.components.buttons.AboutButton,{isAvailable:function(){var _357=toura.app.Config.get("app");return _357.aboutEnabled&&!!_357.aboutNodeId;}});}if(!dojo._hasResource["toura.components.buttons.MapsButton"]){dojo._hasResource["toura.components.buttons.MapsButton"]=true;dojo.provide("toura.components.buttons.MapsButton");dojo.declare("toura.components.buttons.MapsButton",[toura.components.buttons._Button],{"class":"maps",prepareData:function(){this.url=toura.app.URL.maps();},initializeStrings:function(){this.i18n_text=this.getString("MAPS");}});dojo.mixin(toura.components.buttons.MapsButton,{isAvailable:function(){var _358=toura.app.Config.get("app");return _358.mapsEnabled&&!!_358.mapNodeId;}});}if(!dojo._hasResource["toura.components.buttons.FavoritesButton"]){dojo._hasResource["toura.components.buttons.FavoritesButton"]=true;dojo.provide("toura.components.buttons.FavoritesButton");dojo.declare("toura.components.buttons.FavoritesButton",[toura.components.buttons._Button],{"class":"favorites",prepareData:function(){this.url=toura.app.URL.favorites();},initializeStrings:function(){this.i18n_text=this.getString("FAVORITES");}});dojo.mixin(toura.components.buttons.FavoritesButton,{isAvailable:function(){return toura.features.favorites;}});}if(!dojo._hasResource["toura.components.AppNav"]){dojo._hasResource["toura.components.AppNav"]=true;dojo.provide("toura.components.AppNav");dojo.declare("toura.components.AppNav",[toura.components._Component],{templateString:dojo.cache("toura.components","AppNav/AppNav.haml","%nav.component.app-nav\n  %ol{ dojoAttachPoint : 'buttonList' }\n"),widgetsInTemplate:true,handleClicks:true,setupChildComponents:function(){var _359=[toura.components.buttons.SearchButton,toura.components.buttons.AboutButton,toura.components.buttons.MapsButton,toura.components.buttons.FavoritesButton];dojo.forEach(_359,function(btn){if((btn.isAvailable&&btn.isAvailable())||!btn.isAvailable){var li=dojo.create("li");this.adopt(btn).placeAt(li);dojo.place(li,this.buttonList,"last");}},this);}});}if(!dojo._hasResource["toura.components.ChildNodeGrid"]){dojo._hasResource["toura.components.ChildNodeGrid"]=true;dojo.provide("toura.components.ChildNodeGrid");dojo.declare("toura.components.ChildNodeGrid",[toura.components._Component],{templateString:dojo.cache("toura.components","ChildNodeGrid/ChildNodeGrid.haml","%ul.component.child-node-grid\n  :each c in children\n    %li\n      %a{ href : c.url }\n        :if tablet\n          .image{ dojoType : 'toura.ui.BackgroundImage', imageUrl : c.featuredImage.large.url, imageWidth : 370, imageHeight : 277, loadOnInit: true }\n        :if phone\n          .image{ dojoType : 'toura.ui.BackgroundImage', imageUrl : c.featuredImage.small.url, imageWidth : 145, imageHeight : 109, loadOnInit: true }\n        %h3= c.name\n"),widgetsInTemplate:true,prepareData:function(){this.node.populateChildren();this.children=dojo.filter(this.node.children||[],function(_35a){return _35a.featuredImage!==undefined;});if(this.tablet){var num=this.children.length,size=num>11?"medium":"large";this["class"]="size-"+size;}if(this.device.os!=="android"){return;}if(toura.components.ChildNodeGrid.placedCSS){return;}var tpl=dojo.cache("toura.components.ChildNodeGrid","child-node-grid.css.tpl","<style id=\"component-css-child-node-grid\">\n\n  .android.phone .child-node-grid li {\n    height: ${height}px;\n    width: ${width}px;\n  }\n\n  .android.phone .child-node-grid li h3 {\n    height: 2.5em;\n    overflow: hidden;\n  }\n\n  .android.phone .child-node-grid li .image {\n    width: ${width}px;\n    height: ${imageHeight}px;\n  }\n\n</style>\n"),_35b=3/4,_35c=Math.floor(toura.app.UI.viewport.width/2-18),_35d=Math.floor(_35c*_35b*1.4),_35e=_35c*_35b,css=dojo.string.substitute(tpl,{width:_35c,height:_35d,imageHeight:_35e});dojo.place(css,document.querySelector("head"));toura.components.ChildNodeGrid.placedCSS=true;}});}if(!dojo._hasResource["toura.components.HeaderImage"]){dojo._hasResource["toura.components.HeaderImage"]=true;dojo.provide("toura.components.HeaderImage");dojo.declare("toura.components.HeaderImage",[toura.components._Component],{templateString:dojo.cache("toura.components","HeaderImage/HeaderImage.haml",".component.header-image\n  :if viewImage\n    %img{ src : viewImage.url, width : viewImage.width, height : viewImage.height, dojoAttachPoint : 'imageNode' }\n"),prepareData:function(){this.inherited(arguments);var _35f=this.device.type,_360=this.phone?"gallery":"original";if(this.node.headerImage&&this.node.headerImage[_35f]){this.image=this.node.headerImage[_35f][_360];this.viewImage=dojo.mixin({},this.image);}else{this.viewImage=false;}},setupConnections:function(){if(!this.image){return;}var _361=this.node.headerImage[this.device.type];if(_361.destination){this.connect(this.domNode,"click",function(){toura.app.Phonegap.browser.url(_361.destination);});}},setupSubscriptions:function(){this.subscribe("/window/resize","_resizeImage");},teardown:function(){dojo.destroy(this.domNode);},resizeElements:function(){if(!this.viewImage){this.destroy();return;}this._resizeImage();},_resizeImage:function(){if(!this.imageNode){return;}dojo.attr(this.imageNode,this._calculateDimensions());},_calculateDimensions:function(){var w=this._getWidth(),img=this.image;return {width:img?w:0,height:img?Math.ceil(img.height*(w/img.width)):0};},_getWidth:function(){return this.getDimensions().width;}});}if(!dojo._hasResource["toura.components.ColumnHeaderImage"]){dojo._hasResource["toura.components.ColumnHeaderImage"]=true;dojo.provide("toura.components.ColumnHeaderImage");dojo.declare("toura.components.ColumnHeaderImage",[toura.components.HeaderImage],{"class":"column-header-image"});}if(!dojo._hasResource["toura.components.DropDownText"]){dojo._hasResource["toura.components.DropDownText"]=true;dojo.provide("toura.components.DropDownText");dojo.declare("toura.components.DropDownText",[toura.components.BodyText],{templateString:dojo.cache("toura.components","DropDownText/DropDownText.haml",".component.drop-down-text\n  .open-wrapper{ dojoAttachPoint : 'openButton' }\n    .button.open\n      %span=i18n_instructions\n\n  .text-wrapper{ dojoAttachPoint : 'textWrapper' }\n    .body-text-container{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n    .button.close{ dojoAttachPoint : 'closeButton' }\n      %span=i18n_close\n\n"),adjustMarkup:function(){this.hide(this.textWrapper);},initializeStrings:function(){this.i18n_close=this.getString("CLOSE");this.i18n_instructions=this.getString("INSTRUCTIONS");},setupConnections:function(){this.connect(this.openButton,"click",function(){this.hide(this.openButton);this.show(this.textWrapper);});this.connect(this.textWrapper,"click",function(){this.hide(this.textWrapper);this.show(this.openButton);});}});}if(!dojo._hasResource["toura.components.FeedItemDetail"]){dojo._hasResource["toura.components.FeedItemDetail"]=true;dojo.provide("toura.components.FeedItemDetail");dojo.declare("toura.components.FeedItemDetail",[toura.components._Component],{templateString:dojo.cache("toura.components","FeedItemDetail/FeedItemDetail.haml",".component.feed-item-detail\n  %article{ dojoAttachPoint : 'content' }\n  %a.full{ dojoAttachPoint : 'externalLink' }= i18n_viewOriginal\n"),itemTemplate:Haml(dojo.cache("toura.components","FeedItemDetail/Item.haml",":if image\n  .image{ style: 'background-image: url(' + image.url + ')' }\n\n.date= pubDate\n\n%h2= title\n.item-body{ dojoAttachPoint : 'itemBody' }= body\n")),prepareData:function(){this.item=this.node;},setupConnections:function(){this.connect(this.externalLink,"click",function(e){e.preventDefault();toura.app.Phonegap.browser.url(this.item.link);});},initializeStrings:function(){this.i18n_viewOriginal=this.getString("FEED_VIEW_ORIGINAL");},_setItemAttr:function(_362){if(_362.type!=="feedItem"){return;}this.item=_362;dojo.empty(this.content);dojo.place(this.itemTemplate(dojo.delegate(this.item,{pubDate:dojo.date.locale.format(this.item.pubDate),i18n_viewOriginal:this.i18n_viewOriginal})),this.content);dojo.attr(this.externalLink,"href",this.item.link);this._setupLinks();if(this.region){this.region.refreshScroller();}},_setupLinks:function(){dojo.forEach(this.domNode.querySelectorAll(".content a"),function(link){dojo.attr(link,"target","_blank");},this);}});}if(!dojo._hasResource["toura.components.FeedItemList"]){dojo._hasResource["toura.components.FeedItemList"]=true;dojo.provide("toura.components.FeedItemList");dojo.declare("toura.components.FeedItemList",[toura.components._Component],{templateString:dojo.cache("toura.components","FeedItemList/FeedItemList.haml",".component.feed-item-list\n  %header\n    .updated\n      %span Last Updated:\n      %span{ dojoAttachPoint : 'lastUpdated' }\n    .refresh{ dojoAttachPoint : 'refreshButton' }= i18n_feedRefresh\n    .spinner\n\n  %ol{ dojoAttachPoint : 'feedItemList' }\n\n"),itemTemplate:Haml(dojo.cache("toura.components","FeedItemList/FeedItem.haml","%li{ data-index : index }\n  %div\n    :if image\n      .image{ style: 'background: url(' + image.url + ')' }\n\n    %h2= title\n    %p.summary= displayText\n    %p.date= pubDate\n\n")),prepareData:function(){this.feed=this.node.feeds&&this.node.feeds[0];},setupConnections:function(){this.inherited(arguments);if(this.feed){this.connect(this.refreshButton,"click","_loadFeed");}},startup:function(){this.inherited(arguments);this._loadFeed();},_loadFeed:function(){this.addClass("loading");this.feed.load().then(dojo.hitch(this,"_populate"),dojo.hitch(this,"_handleNoNetwork"));this.connect(this.feedItemList,"click","_onSelect");},_populate:function(_363){this.removeClass("loading");if(!_363.length){var li=dojo.create("li",{innerHTML:this.i18n_noItems});dojo.place(li,this.feedItemList,"only");return;}this.feedItemList.innerHTML=dojo.map(_363,function(item,idx){item.displayText=toura.util.truncate(item.body,200);item.index=idx;item.pubDate=dojo.date.locale.format(item.pubDate);return this.itemTemplate(item);},this).join("");this.lastUpdated.innerHTML=" "+dojo.date.locale.format(new Date());this.region.refreshScroller();this.onPopulate();},onPopulate:function(){},_handleNoNetwork:function(){this.removeClass("loading");var li=dojo.create("li",{innerHTML:this.i18n_noNetwork});dojo.place(li,this.feedItemList,"only");},_onSelect:function(e){e.preventDefault();var t=e.target,_364;while(t.nodeName.toLowerCase()!=="li"){t=t.parentNode;}_364=dojo.attr(t,"data-index");dojo.forEach(t.parentNode.childNodes,function(el){dojo.removeClass(el,"active");});dojo.addClass(t,"active");if(_364){this.onSelect(this.feed.id,_364);}},onSelect:function(_365,_366){console.log("onSelect",_365,_366);},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK");this.i18n_noItems=this.getString("FEED_NO_ITEMS");this.i18n_feedRefresh=this.getString("FEED_REFRESH");}});}if(!dojo._hasResource["toura.components.Hotspots"]){dojo._hasResource["toura.components.Hotspots"]=true;dojo.provide("toura.components.Hotspots");dojo.declare("toura.components.Hotspots",[toura.components._Component],{templateString:dojo.cache("toura.components","Hotspots/Hotspots.haml",".component.hotspots\n  .image-wrapper{ dojoAttachPoint : 'imageWrapper', style : 'text-align: center' }\n    %img{ src : image.url, dojoAttachPoint : 'imageNode' }\n"),widgetsInTemplate:true,prepareData:function(){var data=this.node.data[0].json;this.hotspots=data.hotspots;this.image=this.node.images[0].original;},setupConnections:function(){this.connect(this.imageNode,"click","_handleImageClick");},postCreate:function(){this.inherited(arguments);this.scroller=new iScroll(this.domNode,{zoom:false,bounce:false});dojo.style(this.imageWrapper,{"width":this.image.width+"px","height":this.image.height+"px"});},_handleImageClick:function(e){e.preventDefault();var x=e.offsetX,y=e.offsetY,_367;dojo.forEach(this.hotspots,function(spot){if(_367){return;}var _368;if(spot.shape==="rectangle"){if(x>spot.left&&y>spot.top&&x<(spot.left+spot.width)&&y<(spot.top+spot.height)){_367=spot;}}if(spot.shape==="circle"){var _369=spot.width/2,_36a=spot.left+_369,_36b=spot.top+_369,hyp=Math.sqrt(Math.pow(_36b-y,2)+Math.pow(_36a-x,2));if(hyp<_369){_367=spot;}}},this);if(_367){toura.app.UI.click={x:x,y:y};toura.app.Router.go(toura.app.URL.node(_367.node_id));}},startup:function(){this.inherited(arguments);var _36c=this.domNode.clientHeight,_36d=this.domNode.clientWidth,newX=0,newY=0,_36e={},_36f;if(toura.app.UI.click){_36f=toura.app.UI.click;_36e.x=+_36f.x;_36e.y=+_36f.y;}else{_36e.x=this.image.width/2;_36e.y=this.image.height/2;}toura.app.UI.click=false;if(_36e.x>_36d/2){_36e.x=_36e.x-(_36d/2);}else{_36e.x=0;}if(_36e.y>_36c/2){_36e.y=_36e.y-(_36c/2);}else{_36e.y=0;}this.scroller.refresh();this.scroller.scrollTo(_36e.x*-1,_36e.y*-1,"0ms");}});}if(!dojo._hasResource["toura.components.LocationList"]){dojo._hasResource["toura.components.LocationList"]=true;dojo.provide("toura.components.LocationList");dojo.declare("toura.components.LocationList",[toura.components._Component],{templateString:dojo.cache("toura.components","LocationList/LocationList.haml","%ul.component.location-list\n  :each location in locations\n    %li\n      .address\n        %p= location.name\n\n        :if location.address\n          %p= location.address\n\n      %a.directions{ target : '_blank', href : location.directionsUrl }= i18n_directions\n\n      :if location.phoneNumber\n        %a.phone-number{ href : location.phoneUrl }\n          %span.label= i18n_phone\n          %span= location.phoneNumber\n\n      :if location.website\n          %a.website{ href : location.website }= i18n_website\n"),prepareData:function(){this.locations=dojo.map(this.node.googleMapPins,function(pin){var loc=dojo.mixin({},pin);loc.directionsUrl=pin.address&&toura.app.URL.googleMapAddress(pin.address);loc.phoneUrl=pin.phoneNumber&&toura.app.URL.tel(pin.phoneNumber);return loc;});},setupConnections:function(){dojo.forEach(this.query("a.website"),function(n){this.connect(n,"click",function(e){e.preventDefault();toura.app.Phonegap.browser.url(dojo.attr(n,"href"));});},this);},initializeStrings:function(){this.i18n_phone=this.getString("PHONE");this.i18n_website=this.getString("WEBSITE");this.i18n_directions=this.getString("DIRECTIONS");}});}if(!dojo._hasResource["toura.components.NodeGallery"]){dojo._hasResource["toura.components.NodeGallery"]=true;dojo.provide("toura.components.NodeGallery");dojo.declare("toura.components.NodeGallery",[toura.components._Component,toura.components._ImageScroller],{templateString:dojo.cache("toura.components","NodeGallery/NodeGallery.haml",".component.node-gallery\n  %ol.indicator{ dojoAttachPoint : 'indicator' }\n    :each img in images\n      %li\n\n  .wrapper\n    %ol.images{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li{ class : 'image ' + img.id }\n          .image{ dojoType : 'toura.ui.BackgroundImage', imageUrl : img.url, imageHeight : img.height, imageWidth : img.width }\n"),"class":"node-gallery",prepareData:function(){this.node.populateChildren();this.children=this.node.children;this.images=dojo.map(this.children||[],function(_370){var img=_370.images[0];return dojo.mixin(img,this.phone?{url:img.gallery.url,height:img.gallery.height,width:img.gallery.width}:{url:img.original.url,height:img.original.height,width:img.original.width});},this);},postCreate:function(){this.scrollerNode=this.clickNode=this.imageList;this.inherited(arguments);},setupConnections:function(){this.connect(this.clickNode,"click","_handle");},_handle:function(e){var _371=this.children[this.currentImageIndex],_372={x:e.offsetX,y:e.offsetY},img=this.images[this.currentImageIndex],_373,_374=this.domNode.clientHeight,_375=this.domNode.clientWidth,_376=_375/img.width;if((img.height*_376)>_374){_372.y+=((img.height*_376)-_374)/2;}_373=img.original.width/_375;_372.x=Math.floor(_372.x*_373);_372.y=Math.floor(_372.y*_373);toura.app.UI.click=_372;toura.app.Router.go(_371.url);},_setCurrentImageIndexAttr:function(_377){this.inherited(arguments);dojo.forEach(this.indicator.childNodes,function(_378){dojo.removeClass(_378,"active");});dojo.addClass(this.indicator.childNodes[_377],"active");},onScrollEnd:function(_379){}});}if(!dojo._hasResource["toura.components.NodeTitleBanner"]){dojo._hasResource["toura.components.NodeTitleBanner"]=true;dojo.provide("toura.components.NodeTitleBanner");dojo.declare("toura.components.NodeTitleBanner",[toura.components._Component],{templateString:dojo.cache("toura.components","NodeTitleBanner/NodeTitleBanner.haml",".component.node-title-banner\n  :if image\n    .image{ dojoType : 'toura.ui.BackgroundImage', imageWidth : image.width, imageHeight : image.height, imageUrl : image.url, loadOnInit: true }\n\n  %header\n    :if parentTitle\n      %h3= parentTitle\n\n    %h2= nodeTitle\n"),widgetsInTemplate:true,prepareData:function(){if(this.node.featuredImage){this.image=this.node.featuredImage[this.phone?"small":"large"];}else{this.image=false;}this.parentTitle=this.node.parent&&this.node.parent.name;this.nodeTitle=this.node.name;}});}if(!dojo._hasResource["toura.components.PageHeaderImage"]){dojo._hasResource["toura.components.PageHeaderImage"]=true;dojo.provide("toura.components.PageHeaderImage");dojo.declare("toura.components.PageHeaderImage",[toura.components.HeaderImage],{"class":"page-header-image",prepareData:function(){this.inherited(arguments);if(this.viewImage){dojo.mixin(this.viewImage,this._calculateDimensions());}},_getWidth:function(){return toura.app.UI.viewport.width;}});}if(!dojo._hasResource["toura.components.ZoomableImageGallery"]){dojo._hasResource["toura.components.ZoomableImageGallery"]=true;dojo.provide("toura.components.ZoomableImageGallery");dojo.declare("toura.components.ZoomableImageGallery",[toura.components._Component,toura.components._ImageGallery,toura.ui.PinchZoom],{templateString:dojo.cache("toura.components","ZoomableImageGallery/ZoomableImageGallery.haml",".component.zoomable-image-gallery\n  .content\n    .image-nav.prev{ dojoAttachPoint : 'prevButton' }\n\n    %ol{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li.image\n          .wrapper{ dojoType : 'toura.ui.BackgroundImage', imageUrl : img.url, imageHeight : img.height, imageWidth : img.width }\n\n    .image-nav.next{ dojoAttachPoint : 'nextButton' }\n\n    .caption{ dojoType : 'toura.components.ImageCaption', dojoAttachPoint : 'caption' }\n"),widgetsInTemplate:true,chromeVisible:false,prepareData:function(){this.inherited(arguments);this.images=dojo.map(this.node.images||[],function(img){var _37a={tablet:"original",phone:"gallery"}[this.device.type];dojo.forEach(["url","height","width"],function(prop){img[prop]=img[_37a][prop];});return img;},this);},setupConnections:function(){this.clickNode=this.imageList;this.connect(this.nextButton,"click",this._go(1));this.connect(this.prevButton,"click",this._go(-1));},_go:function(_37b){return dojo.hitch(this,function(){this.set("currentImageIndex",this.currentImageIndex+_37b);});},_setCurrentImageIndexAttr:function(_37c){this.inherited(arguments);var img=this.images[_37c];this.set("caption",img.caption||"");this._updateImages(_37c);this._updateButtons(_37c);this.onImageChange(img);},_handleClick:function(){this.set("chromeVisible",!this.chromeVisible);},_setChromeVisibleAttr:function(_37d){this[_37d?"removeClass":"addClass"]("chrome-hidden");this.chromeVisible=_37d;this[_37d?"onShowChrome":"onHideChrome"]();},onShowChrome:function(){},onHideChrome:function(){},onImageChange:function(_37e){},_updateImages:function(_37f){dojo.forEach(this.bgImgs,function(_380,_381){var n=_380.domNode.parentNode,_382=_381===_37f;this[_382?"show":"hide"](n);if(!_382){return;}this._makeScroller(n);},this);},_updateButtons:function(_383){var _384=_383===0,_385=_383===(this.images.length-1);this[_384?"hide":"show"](this.prevButton);this[_385?"hide":"show"](this.nextButton);},_setCaptionAttr:function(_386){this.caption.set("content",_386);this.caption[_386?"show":"hide"]();}});}if(!dojo._hasResource["toura.components._base"]){dojo._hasResource["toura.components._base"]=true;dojo.provide("toura.components._base");}if(!dojo._hasResource["toura.capabilities._Capability"]){dojo._hasResource["toura.capabilities._Capability"]=true;dojo.provide("toura.capabilities._Capability");dojo.declare("toura.capabilities._Capability",[],{requirements:{},connects:[],constructor:function(_387){dojo.mixin(this,_387);this.domNode=this.page.domNode;this.node=this.page.node;this.involved=this._loadInvolvedComponents();if(!this._checkRequirements()){console.error("Did not find required components for capability",this.declaredClass);return;}this._doLookups();this._doConnects();this.init();},init:function(){},_loadInvolvedComponents:function(){var _388={};dojo.forEach(this.components,function(c){var tmp=c.split(":"),_389=tmp[0],_38a=tmp[1],_38b=this.page.getScreen(_389),_38c=_38b.getComponent(_38a);_388[_38a]=_38c;},this);return _388;},_checkRequirements:function(){var _38d=true;dojo.forIn(this.requirements,function(_38e,_38f){requirmentsMet=this.involved[_38f];},this);return _38d;},_doLookups:function(){dojo.forIn(this.requirements,function(_390,_391){this[_390]=this.involved[_391];},this);},_doConnects:function(){dojo.forEach(this.connects,function(c){this.connect.apply(this,c);},this);},connect:function(obj,_392,fn){if(dojo.isString(obj)){obj=this[obj];}this.page.connect(obj,_392,dojo.hitch(this,fn));}});toura.capability=function(name,_393){dojo.declare("toura.capabilities."+name,[toura.capabilities._Capability],_393);};}if(!dojo._hasResource["toura.capabilities.Page_Images"]){dojo._hasResource["toura.capabilities.Page_Images"]=true;dojo.provide("toura.capabilities.Page_Images");dojo.declare("toura.capabilities.Page_Images",[toura.capabilities._Capability],{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["page","init","_setup"]],_setup:function(_394){if(!_394){return;}var _395=_394.assetId,_396,_397;if(!_395){return;}_397=dojo.filter(this.baseObj.images,function(_398,idx){if(_398.id===_395){_396=idx;return _398;}})[0];if(!_397){return;}if(this.imageGallery){this.connect(this.imageGallery,"startup",function(){this.imageGallery.scrollToIndex(_396);});}if(this.imageCaption){this.imageCaption.set("content",_397.caption||"");}}});}if(!dojo._hasResource["toura.capabilities.Page_FullScreenImages"]){dojo._hasResource["toura.capabilities.Page_FullScreenImages"]=true;dojo.provide("toura.capabilities.Page_FullScreenImages");dojo.declare("toura.capabilities.Page_FullScreenImages",[toura.capabilities._Capability],{requirements:{imageGallery:"ZoomableImageGallery",pageNav:"PageNav"},connects:[["page","init","_setup"],["imageGallery","onHideChrome","_hideNav"],["imageGallery","onShowChrome","_showNav"]],_setup:function(_399){var _39a=0;if(_399.assetId){dojo.forEach(this.baseObj.images,function(_39b,idx){if(_39b.id===_399.assetId){_39a=idx;}});}this.imageGallery.set("currentImageIndex",_39a);},_hideNav:function(){this.pageNav.hide();},_showNav:function(){this.pageNav.show();}});}if(!dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]){dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]=true;dojo.provide("toura.capabilities.ImageGallery_ImageCaption");dojo.declare("toura.capabilities.ImageGallery_ImageCaption",[toura.capabilities._Capability],{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["imageGallery","onScrollEnd","_setCaption"]],_setCaption:function(_39c){var _39d=this.baseObj.images[_39c];this.imageCaption.set("content",_39d&&_39d.caption||"");dojo.publish("/content/update");}});}if(!dojo._hasResource["toura.capabilities.ImageGalleryDetail"]){dojo._hasResource["toura.capabilities.ImageGalleryDetail"]=true;dojo.provide("toura.capabilities.ImageGalleryDetail");dojo.declare("toura.capabilities.ImageGalleryDetail",[toura.capabilities._Capability],{requirements:{imageGallery:"ImageGallery",imageDetail:"ZoomableImageGallery",detailTitle:"DetailTitle"},connects:[["imageGallery","onShowDetail","_showDetail"],["detailTitle","onClose","_hideDetail"],["imageDetail","onImageChange","_setTitle"],["imageDetail","onShowChrome","_showDetailTitle"],["imageDetail","onHideChrome","_hideDetailTitle"]],_showDetail:function(_39e){toura.app.UI.set("siblingNavVisible",false);this.detailTitle.hide();this.page.showScreen("detail");this.imageDetail.set("currentImageIndex",_39e);this.imageDetail.set("chromeVisible",false);},_hideDetail:function(_39f){this.page.showScreen("index");toura.app.UI.set("siblingNavVisible",true);this.imageGallery.scrollToIndex(this.imageDetail.currentImageIndex);},_setTitle:function(_3a0){this.detailTitle.set("screenTitle",_3a0.name);},_showDetailTitle:function(){this.detailTitle.show();},_hideDetailTitle:function(){this.detailTitle.hide();}});}if(!dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]){dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]=true;dojo.provide("toura.capabilities.FeedItemList_FeedItemPage");dojo.declare("toura.capabilities.FeedItemList_FeedItemPage",[toura.capabilities._Capability],{requirements:{feedItemList:"FeedItemList"},connects:[["feedItemList","onSelect","_navigateToFeedItemPage"]],_navigateToFeedItemPage:function(_3a1,_3a2){var url=toura.app.URL.feedItem(_3a1,_3a2);toura.app.Router.go(url);}});}if(!dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]){dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]=true;dojo.provide("toura.capabilities.FeedItemList_FeedItemDetail");dojo.declare("toura.capabilities.FeedItemList_FeedItemDetail",[toura.capabilities._Capability],{requirements:{feedItemList:"FeedItemList",feedItemDetail:"FeedItemDetail"},connects:[["feedItemList","onSelect","_showFeedItem"],["feedItemList","onPopulate","_showFirstItem"]],_showFeedItem:function(_3a3,_3a4){this.feedItemDetail.set("item",this.feedItemList.feed.getItem(_3a4));},_showFirstItem:function(){this.feedItemDetail.set("item",this.feedItemList.feed.getItem(0));}});}if(!dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]){dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]=true;dojo.provide("toura.capabilities.PageNav_FeedTitle");dojo.declare("toura.capabilities.PageNav_FeedTitle",[toura.capabilities._Capability],{requirements:{feedItemDetail:"FeedItemDetail",pageNav:"PageNav"},init:function(){this.pageNav.set("screenTitle",this.page.baseObj.feedName);}});}if(!dojo._hasResource["toura.capabilities.Page_Audios"]){dojo._hasResource["toura.capabilities.Page_Audios"]=true;dojo.provide("toura.capabilities.Page_Audios");dojo.declare("toura.capabilities.Page_Audios",[toura.capabilities._Capability],{requirements:{audioPlayer:"AudioPlayer",audioList:"AudioList"},connects:[["page","init","_setup"]],_setup:function(_3a5){if(this.baseObj.audios.length<2){dojo.destroy(this.audioList.domNode);}this._loadAudio(_3a5);},_loadAudio:function(_3a6){if(!_3a6.assetId||_3a6.assetType!=="audios"){return;}var _3a7=_3a6.assetId,_3a8=this._audioById(_3a7);if(this.audioList){this.audioList.set("currentAsset",_3a7);}if(this.audioCaption){this.audioCaption.set("content",_3a8.caption||"");}this.audioPlayer.set("mediaId",_3a7);}});}if(!dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]){dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]=true;dojo.provide("toura.capabilities.AudioList_AudioPlayer");dojo.declare("toura.capabilities.AudioList_AudioPlayer",[toura.capabilities._Capability],{requirements:{audioList:"AudioList",audioPlayer:"AudioPlayer"},connects:[["audioList","onSelect","_playAudio"]],_playAudio:function(_3a9){this.audioPlayer.play(_3a9);}});}if(!dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]){dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]=true;dojo.provide("toura.capabilities.AudioList_AudioCaption");dojo.declare("toura.capabilities.AudioList_AudioCaption",[toura.capabilities._Capability],{requirements:{audioList:"AudioList",audioCaption:"AudioCaption"},connects:[["audioList","onSelect","_setCaption"]],_setCaption:function(_3aa){var _3ab=this.baseObj.getAssetById("audio",_3aa);if(!_3ab){return;}this.audioCaption.set("content",_3ab.caption||"");}});}if(!dojo._hasResource["toura.capabilities._base"]){dojo._hasResource["toura.capabilities._base"]=true;dojo.provide("toura.capabilities._base");}if(!dojo._hasResource["toura.pageControllers.Configurable"]){dojo._hasResource["toura.pageControllers.Configurable"]=true;dojo.provide("toura.pageControllers.Configurable");dojo.declare("toura.pageControllers.Configurable",[toura.pageControllers._Page],{templateConfig:{},templateString:dojo.cache("toura.pageControllers","Configurable/Configurable.haml","%li.page.node.configurable\n"),postMixInProperties:function(){this.inherited(arguments);this.baseObj.shareable=this.baseObj.type==="node";},postCreate:function(){this.inherited(arguments);this.screens={};if(!this.baseObj){throw "Configurable page controller requires a base object";}if(!this.templateConfig){throw "Configurable page controller requires a template config";}if(!this.templateConfig.screens||!this.templateConfig.screens.length){throw "Configurable page controller must have at least one screen defined";}dojo.forEach(this.templateConfig.screens,function(_3ac){var scr=this.adopt(toura.containers.Screen,{page:this,config:_3ac,baseObj:this.baseObj,device:this.device,backgroundImage:this._getBackgroundImage()}).placeAt(this.domNode);this.screens[_3ac.name]=scr;},this);this.capabilities=dojo.map(this.templateConfig.capabilities||[],function(_3ad){var C=_3ad.name,_3ae=_3ad.components;if(!toura.capabilities[C]){console.warn("No capability",C,"defined -- did you remember to require it in toura.capabilities._base?");return null;}return new toura.capabilities[C]({page:this,baseObj:this.baseObj,components:_3ae});},this);if(this.screens.detail){this.screens.detail.hide();}this.addClass("page-"+this.baseObj.id);this.addClass(this.templateName);},showScreen:function(_3af){dojo.forIn(this.screens,function(name,_3b0){if(name!==_3af){_3b0.hide();}});this.screens[_3af].show();},getScreen:function(_3b1){return this.screens[_3b1];},startup:function(){this.inherited(arguments);dojo.forIn(this.screens,function(name,_3b2){_3b2.startup();});},_applyBackgroundImage:function(){},_getBackgroundImage:function(){var img;if(this.baseObj.getBackgroundImage){img=this.baseObj.getBackgroundImage(this.device);}return img||this.inherited(arguments);}});}if(!dojo._hasResource["toura.app.PageFactory"]){dojo._hasResource["toura.app.PageFactory"]=true;dojo.provide("toura.app.PageFactory");dojo.declare("toura.app.PageFactory",[],{constructor:function(_3b3){this.device=_3b3;},_translations:{"videos":"Videos1","locations-map":"GoogleMap1"},_overrides:{"FeedList":function(_3b4){return "feed-list-"+_3b4.type;},"Images1":function(_3b5){return "images-and-text-"+_3b5.type;},"Home1":function(_3b6){return "home-"+_3b6.type;},"Home2":function(_3b7){return "home-with-header-"+_3b7.type;},"Audios1":function(_3b8){return "audio-with-images-"+_3b8.type;}},pages:{"search":function(){return new toura.pageControllers.search.Search({device:this.device});},"favorites":function(){return new toura.pageControllers.favorites.Favorites({device:this.device});},"feedItem":function(obj){var _3b9=toura.pageControllers.Configurable,_3ba=toura.templates["feed-item"];return new _3b9({baseObj:obj.feedItem,device:this.device,templateConfig:_3ba});},"debug":function(obj){return new toura.pageControllers.Debug({device:this.device,query:obj.query});}},createPage:function(obj){if(!obj){throw new Error("toura.app.PageFactory::createPage requires an object");}var _3bb=obj.pageController||"default",_3bc,_3bd;if(obj.pageController&&dojo.isObject(obj.pageController)){_3bb=obj.pageController[this.device.type]||"default";}else{_3bb=obj.pageController||"default";}if(this.pages[_3bb]){return this.pages[_3bb].call(this,obj);}if(this._translations[_3bb]){_3bb=this._translations[_3bb];}if(this._overrides[_3bb]){_3bb=this._overrides[_3bb](this.device);}_3bc=toura.templates&&toura.templates[_3bb];_3bd=_3bc?toura.pageControllers.Configurable:toura.pageControllers.node[_3bb];if(!_3bd){console.error("toura.app.PageFactory: The controller \""+_3bb+"\" does not exist. Did you require it in PageFactory?");throw ("toura.app.PageFactory: The controller \""+_3bb+"\" does not exist. Did you require it in PageFactory?");}toura.log("Creating "+_3bb);return new _3bd({baseObj:obj,device:this.device,templateConfig:_3bc,templateName:_3bb});}});dojo.subscribe("/app/ready",function(){toura.app.PageFactory=new toura.app.PageFactory(toura.app.Config.get("device"));});}if(!dojo._hasResource["toura.app.Routes"]){dojo._hasResource["toura.app.Routes"]=true;dojo.provide("toura.app.Routes");toura.app.Routes=function(){var app=toura.app.Config.get("app"),_3be=toura.app.PageFactory,_3bf;function _3c0(_3c1,_3c2,_3c3){_3c3=_3c3||{};var _3c4=toura.app.Data.getModel(_3c2),page=toura.app.UI.getCurrentPage(),pf,_3c5;if(!_3c4){console.log("Request for invalid hash",_3c1.hash);toura.app.Router.home();return;}if(!page||!page.node||_3c2!==page.node.id){try{pf=_3be.createPage(_3c4);}catch(e){console.log(e);toura.app.Router.back();return;}if(pf.failure){if(dojo.isString(pf.failure)){alert(pf.failure);}toura.app.Router.back();return;}pf.init(_3c3);toura.app.UI.showPage(pf,_3c4);}else{page.init(_3c3);}if(_3c2&&!_3c3.assetType){dojo.publish("/node/view",[_3c1.hash]);}toura.endLogSection("NODE ROUTE");return true;};_3bf=[{route:"/home",handler:function(_3c6,_3c7){toura.lastSearchTerm=null;return _3c0(_3c7,app.homeNodeId);},defaultRoute:true},{route:"/about",handler:function(_3c8,_3c9){return _3c0(_3c9,app.aboutNodeId);}},{route:"/maps",handler:function(_3ca,_3cb){return _3c0(_3cb,app.mapNodeId);}},{route:/\/node\/(.*)/,handler:function(_3cc,_3cd){var _3ce=_3cc.splat[0].split("/"),_3cf=_3ce[0],_3d0={assetType:_3ce[1],assetId:_3ce[2],assetSubId:_3ce[3]};return _3c0(_3cd,_3cf,_3d0);}},{route:/\/search\/?(.*)/,handler:function(_3d1){var page=toura.app.UI.getCurrentPage(),term=_3d1.splat&&_3d1.splat[0].split("/")[0];if(!page||!page.type||page.type!=="search"){page=_3be.createPage({pageController:"search"});toura.app.UI.showPage(page);}page.init(term);return true;}},{route:"/feed/:feedId/item/:itemIndex",handler:function(_3d2){var feed=toura.app.Data.getModel(_3d2.feedId,"feed"),_3d3=feed.getItem(_3d2.itemIndex),page=_3be.createPage({pageController:"feedItem",feedItem:_3d3});toura.app.UI.showPage(page,_3d3);}}];if(toura.features.debugPage){_3bf.push({route:"/debug/:query",handler:function(_3d4,_3d5){var page=_3be.createPage({pageController:"debug",query:_3d4.query});toura.app.UI.showPage(page);}});}if(toura.features.favorites){_3bf.push({route:"/favorites",handler:function(){var page=_3be.createPage({pageController:"favorites"});toura.app.UI.showPage(page);}});}return _3bf;};}if(!dojo._hasResource["toura.app.Notifications"]){dojo._hasResource["toura.app.Notifications"]=true;dojo.provide("toura.app.Notifications");(function(){var _3d6;toura.app.Notifications={areAvailable:function(){return !!toura.app.Phonegap.present;},init:function(){if(!toura.app.Phonegap.present){return;}window.plugins.pushNotification.startNotify();this._apnRegister();},setNotificationCallback:function(_3d7){if(!toura.app.Phonegap.present){return;}_3d6=window.plugins.pushNotification.notificationCallback=_3d7;},notify:function(_3d8){_3d6(_3d8);},_apnRegister:function(){window.plugins.pushNotification.register(function(e){toura.app.Notifications._apnOnRegisterSuccess(e);},function(e){toura.app.Notifications._apnOnRegisterError(e);},[{alert:true,badge:true,sound:true}]);console.log("APN push notification registered.");},_apnOnRegisterSuccess:function(e){this._urbanAirshipRegister(e.deviceToken,e.host,e.appKey,e.appSecret);},_apnOnRegisterError:function(e){console.log("error registering with APN: "+e.toString());},_urbanAirshipRegister:function(_3d9,host,_3da,_3db){var _3dc=new XMLHttpRequest();_3dc.open("PUT",host+"api/device_tokens/"+_3d9,true,_3da,_3db);_3dc.onload=function(){if(this.status===200||this.status===201){console.log("Successfully registered with Urban Airship.");}else{console.log("Error when registring with Urban Airship: "+this.statusText);}};_3dc.send();}};var _3dd=toura.app.Notifications;dojo.subscribe("/app/ready",function(){var _3de=function(){},_3df="Notification from "+toura.app.Config.get("app").name;_3dd.init();_3dd.setNotificationCallback(function(_3e0){window.navigator.notification.alert(_3e0.alert,_3de,_3df);});});}());}if(!dojo._hasResource["dojo.cookie"]){dojo._hasResource["dojo.cookie"]=true;dojo.provide("dojo.cookie");dojo.cookie=function(name,_3e1,_3e2){var c=document.cookie;if(arguments.length==1){var _3e3=c.match(new RegExp("(?:^|; )"+dojo.regexp.escapeString(name)+"=([^;]*)"));return _3e3?decodeURIComponent(_3e3[1]):undefined;}else{_3e2=_3e2||{};var exp=_3e2.expires;if(typeof exp=="number"){var d=new Date();d.setTime(d.getTime()+exp*24*60*60*1000);exp=_3e2.expires=d;}if(exp&&exp.toUTCString){_3e2.expires=exp.toUTCString();}_3e1=encodeURIComponent(_3e1);var _3e4=name+"="+_3e1,_3e5;for(_3e5 in _3e2){_3e4+="; "+_3e5;var _3e6=_3e2[_3e5];if(_3e6!==true){_3e4+="="+_3e6;}}document.cookie=_3e4;}};dojo.cookie.isSupported=function(){if(!("cookieEnabled" in navigator)){this("__djCookieTest__","CookiesAllowed");navigator.cookieEnabled=this("__djCookieTest__")=="CookiesAllowed";if(navigator.cookieEnabled){this("__djCookieTest__","",{expires:-1});}}return navigator.cookieEnabled;};}if(!dojo._hasResource["toura.app._Debug"]){dojo._hasResource["toura.app._Debug"]=true;dojo.provide("toura.app._Debug");(function(){var sub=dojo.subscribe("/debug/user",function(_3e7){if(!toura.features.debugPage){return;}if(!confirm("Click OK if you want to enter debug mode.")){return;}toura.app.Router.go("/debug/"+_3e7);});var _3e8=function(){var _3e9=[],_3ea=2;while(_3ea--){_3e9.push((((1+Math.random())*65536)).toString(16).substring(0,3));}return "#toura-"+_3e9.join("");};toura.app._Debug=function(){var _3eb=new toura.app._Debug.Tools().placeAt(dojo.body(),"first"),msg=new toura.app._Debug.Message().placeAt(dojo.body(),"first"),tpl="Desktop debugging at {url}";dojo.connect(_3eb,"onWeinre",function(hash){var url=toura.app._Debug.weinre.client(hash);msg.set("content",tpl.split("{url}").join(url));});};toura.app._Debug.weinre={init:function(){var _3ec=dojo.cookie("debug-hash"),hash=_3ec||_3e8(),s=document.createElement("script"),url=s.src=this.script+hash;if(this.enabled){return hash;}document.body.appendChild(s);dojo.cookie("debug-hash",hash);this.enabled=true;return hash;},script:"http://debug.phonegap.com/target/target-script-min.js",client:function(hash){return "http://debug.phonegap.com/client/{hash}".replace("{hash}",hash);}};dojo.declare("toura.app._Debug.Tools",[toura.components._Component],{templateString:"<div class=\"component debug-tools\"><div class=\"buttons\"></div></div>",actions:[{name:"Reset DB",method:"_resetDB"},{name:"weinre",method:"_weinre"}],postCreate:function(){this.inherited(arguments);this._makeActions();},_makeActions:function(){dojo.forEach(this.actions,function(_3ed){var n=dojo.create("div",{className:"button",innerHTML:_3ed.name});dojo.place(n,this.domNode.firstChild);this.connect(n,"click",_3ed.method);},this);},_resetDB:function(){toura.app.DeviceStorage.drop();window.location.reload();},_weinre:function(){if(this.hasWeinre){return;}var hash=toura.app._Debug.weinre.init();this.hasWeinre=true;this.onWeinre(hash);},onWeinre:function(hash){}});dojo.declare("toura.app._Debug.Message",[toura.components._Component],{templateString:"<div class=\"component debug-message\"></div>",postCreate:function(){this.inherited(arguments);var n=dojo.create("div",{className:"close",innerHTML:"close"});dojo.place(n,this.domNode);this.connect(n,"click",function(){this.hide();});this.msgNode=dojo.create("div");dojo.place(this.msgNode,this.domNode);this.hide();},_setContentAttr:function(msg){this.show();this.msgNode.innerHTML=msg;}});}());}if(!dojo._hasResource["toura.app.Manifest"]){dojo._hasResource["toura.app.Manifest"]=true;dojo.provide("toura.app.Manifest");dojo.declare("toura.app.Manifest",[],{url:"./media/manifest.js",constructor:function(){dojo.when(this._load(),dojo.hitch(this,"_parse"));},_load:function(){return this.manifest||dojo.io.script.get({url:this.url});},_parse:function(){if(!toura.app.manifest){toura.app.manifest={};return;}var _3ee={};this._parseDir(_3ee,toura.app.manifest.dirs);toura.app.manifest=_3ee;},_parseDir:function(base,obj){dojo.forIn(obj,function(_3ef,_3f0){base[_3ef]=_3f0.files?_3f0.files:[];if(_3f0.dirs){dojo.forIn(_3f0.dirs,function(_3f1,_3f2){this._parseDir(base[_3ef],_3f2);},this);}},this);}});dojo.subscribe("/app/start",function(){toura.app.Manifest=new toura.app.Manifest();});}if(!dojo._hasResource["toura.app.Has"]){dojo._hasResource["toura.app.Has"]=true;dojo.provide("toura.app.Has");toura.app.Has=function(){var _3f3=toura.app.Config.get("device");return {cssBackgroundContain:function(){return !(_3f3.os==="android"&&_3f3.version==="2-1");},html5Player:function(){return _3f3.os!=="android";},iScrollZoom:function(){return _3f3.os!=="android";}};};(function(){var s=dojo.subscribe("/app/start",function(){dojo.unsubscribe(s);if(dojo.isFunction(toura.app.Has)){toura.app.Has=toura.app.Has();}});}());}if(!dojo._hasResource["toura.app.Local"]){dojo._hasResource["toura.app.Local"]=true;dojo.provide("toura.app.Local");toura=toura||{};toura.data=toura.data||{};toura.app.Local=(function(){return {manifest:function(){return dojo.io.script.get({url:"./media/manifest.js",preventCache:true});},templates:function(){return dojo.io.script.get({url:"./data/templates.js",preventCache:true});}};}());}if(!dojo._hasResource["toura.app._base"]){dojo._hasResource["toura.app._base"]=true;dojo.provide("toura.app._base");}if(!dojo._hasResource["toura.base"]){dojo._hasResource["toura.base"]=true;dojo.provide("toura.base");toura.data=toura.data||{};mulberry=toura;var readyFn=function(){toura.features=toura.features||{};dojo.publish("/app/start");toura.logSection("Bootstrapper");dojo.when(toura.app.Bootstrapper(),function(){toura.endLogSection("Bootstrapper");dojo.when(toura.app.Tour.getItems(),function(data){if(toura.extraTourData&&dojo.isArray(toura.extraTourData)){dojo.forEach(toura.extraTourData,function(item){data.push(item);});}toura.app.Data=new toura.app.Data(data);setTimeout(function(){dojo.publish("/app/ready");toura.app.Phonegap.network.isReachable().then(function(_3f4){toura.app.Local.templates().then(function(){toura.app.Router=new toura.app.Router({routes:toura.app.Routes()});dojo.publish("/routes/loaded");toura.app.Router.init();toura.app.UI.hideSplash();if(!_3f4){alert(dojo.i18n.getLocalization("toura","toura",toura.app.Config.get("locale")).STARTUP_NO_NETWORK);}dojo.publish("/app/started");});});},200);});});if(toura.features.debugToolbar){toura.app._Debug();}};document.addEventListener("deviceready",function(){dojo.ready(readyFn);},false);}dojo.i18n._preloadLocalizations("toura.nls.base",["ROOT","en","en-us","xx"]);
